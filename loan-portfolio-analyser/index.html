<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tape Analyser — Enable Funding</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #0a0b0f;
      --surface: #111219;
      --surface-2: #181a22;
      --border: #21242e;
      --text: #b8bcc8;
      --text-bright: #d0d3dc;
      --text-muted: #585e6f;
      --accent: #4a6a8f;
      --accent-light: #6888a8;
      --positive: #4a7a5e;
      --positive-bg: rgba(74,122,94,0.08);
      --negative: #8a4a4a;
      --negative-bg: rgba(138,74,74,0.08);
      --caution: #8a7a4a;
      --caution-bg: rgba(138,122,74,0.08);
      --radius: 3px;
      --shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Mono', 'Consolas', 'Menlo', 'Monaco', 'Liberation Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      font-size: 13px;
    }

    .nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 28px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-brand {
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-bright);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .nav-brand svg { width: 18px; height: 18px; color: var(--text-muted); }
    .nav-actions { display: flex; gap: 8px; align-items: center; }
    .nav-sub { font-size: 11px; color: var(--text-muted); font-weight: 400; text-transform: none; letter-spacing: 0; margin-left: 8px; }

    .container { max-width: 1440px; margin: 0 auto; padding: 20px 28px; }
    .section { margin-bottom: 20px; }
    .section-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 10px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    .stat-card { padding: 14px 14px; }
    .stat-label {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      white-space: nowrap;
      color: var(--text-bright);
      font-family: 'SF Mono', 'Consolas', 'Menlo', monospace;
    }
    .stat-sub {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .upload-area {
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 48px 40px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      background: var(--surface);
    }
    .upload-area:hover, .upload-area.drag-over {
      border-color: var(--accent);
      background: rgba(74,106,143,0.04);
    }
    .upload-area svg { width: 32px; height: 32px; color: var(--text-muted); margin-bottom: 12px; }
    .upload-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; color: var(--text-bright); }
    .upload-sub { font-size: 11px; color: var(--text-muted); }
    .upload-area input { display: none; }

    .btn {
      padding: 6px 14px;
      border: none;
      border-radius: var(--radius);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: inherit;
      letter-spacing: 0.02em;
    }
    .btn:hover { opacity: 0.8; }
    .btn-primary { background: var(--accent); color: #d0d8e4; }
    .btn-outline { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-outline:hover { color: var(--text); border-color: var(--text-muted); }
    .btn-sm { padding: 5px 10px; font-size: 10px; }

    .chart-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .chart-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .chart-card { padding: 16px; }
    .chart-card h3 {
      font-size: 10px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .chart-wrap { position: relative; height: 260px; }

    .table-card { padding: 0; overflow: hidden; }
    .table-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .table-header h3 { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .table-scroll { max-height: 420px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left;
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--surface);
      font-weight: 600;
    }
    tbody td {
      padding: 7px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-family: 'SF Mono', 'Consolas', 'Menlo', monospace;
    }
    tbody tr:hover { background: rgba(74,106,143,0.03); }
    tbody tr:last-child td { border-bottom: none; }
    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 2px;
      font-size: 10px;
      font-weight: 600;
    }
    .badge-positive { background: var(--positive-bg); color: var(--positive); }
    .badge-negative { background: var(--negative-bg); color: var(--negative); }

    .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
    .tab {
      padding: 8px 18px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--text-bright); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .dashboard { display: none; }
    .dashboard.active { display: block; }

    @media (max-width: 1100px) {
      .stat-grid { grid-template-columns: repeat(3, 1fr); }
      .chart-grid-3 { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 700px) {
      .container { padding: 12px; }
      .stat-grid { grid-template-columns: 1fr 1fr; }
      .chart-grid-2, .chart-grid-3 { grid-template-columns: 1fr; }
    }

    /* --- MAPPING MODAL --- */
    .mapping-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .mapping-overlay.active { display: flex; }
    .mapping-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
      width: 700px;
      max-width: 95vw;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    .mapping-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .mapping-modal-header h2 {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-bright);
    }
    .mapping-modal-header p {
      font-size: 11px;
      color: var(--text-muted);
    }
    .mapping-modal-body {
      padding: 12px 20px;
      overflow-y: auto;
      flex: 1;
    }
    .mapping-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mapping-status {
      font-size: 11px;
      color: var(--text-muted);
    }
    .mapping-status .count { color: var(--accent-light); font-weight: 600; }
    .mapping-status .warn { color: var(--caution); }
    .mapping-row {
      display: grid;
      grid-template-columns: 1fr 32px 1fr;
      gap: 10px;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid rgba(33,36,46,0.6);
    }
    .mapping-row:last-child { border-bottom: none; }
    .mapping-row-header {
      display: grid;
      grid-template-columns: 1fr 32px 1fr;
      gap: 10px;
      padding: 4px 0 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2px;
    }
    .mapping-row-header span {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }
    .mapping-col-name {
      font-size: 11px;
      font-weight: 500;
      padding: 6px 10px;
      background: var(--surface-2);
      border-radius: var(--radius);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mapping-col-name .sample {
      display: block;
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mapping-arrow {
      text-align: center;
      color: var(--text-muted);
      font-size: 11px;
    }
    .mapping-select {
      width: 100%;
      padding: 6px 10px;
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 11px;
      font-family: inherit;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%23585e6f' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 24px;
    }
    .mapping-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .mapping-select.mapped { border-color: var(--accent); }
    .mapping-select.unmapped { border-color: transparent; }
    .mapping-badge {
      display: inline-block;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 2px;
      margin-left: 6px;
      font-weight: 600;
      vertical-align: middle;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .mapping-badge.auto { background: rgba(74,106,143,0.1); color: var(--accent-light); }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  </style>
</head>
<body>

<nav class="nav">
  <div class="nav-brand">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="1"/><path d="M2 9h20"/><path d="M9 21V9"/></svg>
    Tape Analyser<span class="nav-sub">Enable Funding</span>
  </div>
  <div class="nav-actions">
    <button class="btn btn-outline btn-sm" onclick="downloadSampleTape()">Download Sample Tape</button>
    <button class="btn btn-outline btn-sm" onclick="exportCSV()">Export CSV</button>
  </div>
</nav>

<div class="container">

  <!-- UPLOAD -->
  <div class="section" id="upload-section">
    <div class="upload-area" id="upload-area">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <div class="upload-title">Upload Data Tape</div>
      <div class="upload-sub">Drag &amp; drop a CSV or Excel file, or click to browse</div>
      <div class="upload-sub" style="margin-top:8px;">Any column layout — you'll map columns to the template after upload</div>
      <input type="file" id="file-input" accept=".csv,.xlsx,.xls">
    </div>
    <div style="text-align:center; margin-top:12px;">
      <button class="btn btn-outline btn-sm" onclick="downloadSampleTape()">Download Sample Tape (.xlsx)</button>
      <span style="color:var(--text-muted); font-size:11px; margin-left:6px;">to test the upload flow</span>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard" id="dashboard">

    <div class="tabs">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="concentration">Concentration</div>
      <div class="tab" data-tab="data">Tape Data</div>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <div class="section">
        <div class="stat-grid">
          <div class="card stat-card">
            <div class="stat-label">Total Commitments</div>
            <div class="stat-value" id="s-portfolio-size">-</div>
            <div class="stat-sub" id="s-loan-count">-</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Outstanding Balance</div>
            <div class="stat-value" id="s-outstanding">-</div>
            <div class="stat-sub" id="s-utilisation">-</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">WA Interest Rate</div>
            <div class="stat-value" id="s-wair">-</div>
            <div class="stat-sub">Weighted by balance</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">WA Maturity</div>
            <div class="stat-value" id="s-wam">-</div>
            <div class="stat-sub">Years to maturity</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Default Rate</div>
            <div class="stat-value" id="s-default-rate">-</div>
            <div class="stat-sub" id="s-default-count">-</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Borrower Count</div>
            <div class="stat-value" id="s-borrower-count">-</div>
            <div class="stat-sub" id="s-avg-facility">-</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Top Exposures</div>
        <div class="card table-card">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Borrower</th><th>Sector</th><th>Outstanding</th><th>% of Book</th><th>Rating</th><th>Status</th>
                </tr>
              </thead>
              <tbody id="top-exposures-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- CONCENTRATION TAB -->
    <div class="tab-content" id="tab-concentration">
      <div class="section">
        <div class="chart-grid-2">
          <div class="card chart-card">
            <h3>Sector Concentration</h3>
            <div class="chart-wrap"><canvas id="chart-sector"></canvas></div>
          </div>
          <div class="card chart-card">
            <h3>Regional Concentration</h3>
            <div class="chart-wrap"><canvas id="chart-region"></canvas></div>
          </div>
        </div>
      </div>
      <div class="section">
        <div class="chart-grid-3">
          <div class="card chart-card">
            <h3>Rating Distribution</h3>
            <div class="chart-wrap"><canvas id="chart-rating"></canvas></div>
          </div>
          <div class="card chart-card">
            <h3>Top 10 Borrower Exposures</h3>
            <div class="chart-wrap"><canvas id="chart-top10"></canvas></div>
          </div>
          <div class="card chart-card">
            <h3>Maturity Profile</h3>
            <div class="chart-wrap"><canvas id="chart-maturity"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DATA TAB -->
    <div class="tab-content" id="tab-data">
      <div class="section">
        <div class="card table-card">
          <div class="table-header">
            <h3 id="data-table-title">Tape Data</h3>
            <button class="btn btn-outline btn-sm" onclick="exportCSV()">Export CSV</button>
          </div>
          <div class="table-scroll" style="max-height:600px;">
            <table>
              <thead>
                <tr>
                  <th>Loan ID</th><th>Borrower</th><th>Sector</th><th>Region</th><th>Commitment</th><th>Outstanding</th><th>Maturity</th><th>Rate</th><th>Rating</th><th>Facility</th><th>Default</th>
                </tr>
              </thead>
              <tbody id="data-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- COLUMN MAPPING MODAL -->
<div class="mapping-overlay" id="mapping-overlay">
  <div class="mapping-modal">
    <div class="mapping-modal-header">
      <h2>Map Your Columns</h2>
      <p>We detected <strong id="mapping-col-count">0</strong> columns in your tape. Map each to a template field — auto-matched where possible.</p>
    </div>
    <div class="mapping-modal-body" id="mapping-body"></div>
    <div class="mapping-modal-footer">
      <div class="mapping-status" id="mapping-status"></div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-outline btn-sm" onclick="cancelMapping()">Cancel</button>
        <button class="btn btn-primary btn-sm" id="mapping-confirm-btn" onclick="confirmMapping()">Confirm &amp; Analyse</button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
//  STATE
// ============================================================
let loans = [];
let charts = {};
let pendingRawData = null;
let columnMapping = {};

const COLORS = [
  '#4a6a8f','#5a7a6e','#7a7a5a','#7a5a5a','#5a5a7a',
  '#4a7a7a','#7a5a6a','#6a6a5a','#4a6a6a','#5a5a6a',
  '#585e6f','#6a4a5a','#4a5a6a','#5a6a4a','#6a5a6a'
];

// ============================================================
//  FILE UPLOAD
// ============================================================
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
uploadArea.addEventListener('drop', e => {
  e.preventDefault();
  uploadArea.classList.remove('drag-over');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'csv') {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: r => showMappingModal(r.data)
    });
  } else if (ext === 'xlsx' || ext === 'xls') {
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      showMappingModal(data);
    };
    reader.readAsArrayBuffer(file);
  }
}

// ============================================================
//  TEMPLATE FIELDS
// ============================================================
const TEMPLATE_FIELDS = [
  { key: 'loan_id',             label: 'Loan ID',             required: true,  type: 'string' },
  { key: 'borrower_name',       label: 'Borrower Name',       required: true,  type: 'string' },
  { key: 'sector',              label: 'Sector',              required: false, type: 'string' },
  { key: 'region',              label: 'Region',              required: false, type: 'string' },
  { key: 'loan_amount',         label: 'Commitment',          required: true,  type: 'number' },
  { key: 'outstanding_balance', label: 'Outstanding Balance', required: true,  type: 'number' },
  { key: 'maturity_date',       label: 'Maturity Date',       required: false, type: 'string' },
  { key: 'interest_rate',       label: 'Interest Rate',       required: false, type: 'number' },
  { key: 'credit_rating',       label: 'Credit Rating',       required: false, type: 'string' },
  { key: 'facility_type',       label: 'Facility Type',       required: false, type: 'string' },
  { key: 'default_flag',        label: 'Default Flag',        required: false, type: 'boolean' }
];

const FIELD_ALIASES = {
  loan_id:             ['loan_id','loanid','loan id','loan #','loan_number','loannumber','loan number','id','loan_ref','loanref','deal_id','dealid','asset_id','assetid','facility_id','facilityid','reference','ref'],
  borrower_name:       ['borrower_name','borrowername','borrower name','borrower','obligor','obligor_name','obligorname','counterparty','counterparty_name','client','client_name','company','company_name','entity','entity_name','name','customer','customer_name'],
  sector:              ['sector','industry','industry_sector','industrysector','segment','business_sector','sic','sic_code','naics','industry_classification'],
  region:              ['region','geography','country','location','geo','market','territory','jurisdiction','domicile','country_of_risk','area'],
  loan_amount:         ['loan_amount','loanamount','loan amount','original_amount','originalamount','original amount','commitment','facility_amount','facilityamount','notional','principal','face_value','facevalue','committed_amount','committedamount','deal_size','dealsize','size','facility_size','facilitysize','limit','facility_limit'],
  outstanding_balance: ['outstanding_balance','outstandingbalance','outstanding balance','outstanding','current_balance','currentbalance','current balance','drawn','drawn_amount','drawnamount','exposure','current_exposure','net_exposure','balance','current_drawn','currentdrawn','utilised','utilised_amount'],
  maturity_date:       ['maturity_date','maturitydate','maturity date','maturity','mat_date','matdate','final_maturity','finalmaturity','end_date','enddate','expiry','expiry_date','expirydate','termination_date','repayment_date'],
  interest_rate:       ['interest_rate','interestrate','interest rate','rate','coupon','spread','margin','yield','all_in_rate','allinrate','coupon_rate','couponrate','rate_pct','pricing','current_rate'],
  credit_rating:       ['credit_rating','creditrating','credit rating','rating','internal_rating','internalrating','external_rating','externalrating','risk_rating','riskrating','grade','risk_grade','credit_grade','pd_grade'],
  facility_type:       ['facility_type','facilitytype','facility type','facility','type','loan_type','loantype','loan type','product','product_type','producttype','instrument','instrument_type','tranche','deal_type','asset_type'],
  default_flag:        ['default_flag','defaultflag','default flag','default','defaulted','is_default','isdefault','in_default','npl','non_performing','nonperforming','status','performing_status','workout','impaired','arrears']
};

// ============================================================
//  FUZZY COLUMN MATCHING
// ============================================================
function normalizeStr(s) {
  return String(s).toLowerCase().replace(/[^a-z0-9]/g, '');
}

function autoMatchColumn(colName) {
  const norm = normalizeStr(colName);
  for (const [field, aliases] of Object.entries(FIELD_ALIASES)) {
    for (const alias of aliases) {
      if (normalizeStr(alias) === norm) return field;
    }
  }
  for (const [field, aliases] of Object.entries(FIELD_ALIASES)) {
    for (const alias of aliases) {
      const normAlias = normalizeStr(alias);
      if (norm.includes(normAlias) || normAlias.includes(norm)) {
        if (normAlias.length >= 3 && norm.length >= 3) return field;
      }
    }
  }
  return '';
}

// ============================================================
//  MAPPING MODAL
// ============================================================
function showMappingModal(rawData) {
  pendingRawData = rawData;
  if (!rawData.length) return;

  const sourceColumns = Object.keys(rawData[0]);
  document.getElementById('mapping-col-count').textContent = sourceColumns.length;

  columnMapping = {};
  const autoMatched = {};
  sourceColumns.forEach(col => {
    const match = autoMatchColumn(col);
    if (match && !Object.values(autoMatched).includes(match)) {
      autoMatched[col] = match;
      columnMapping[col] = match;
    }
  });

  const body = document.getElementById('mapping-body');
  body.innerHTML = '';

  const headerRow = document.createElement('div');
  headerRow.className = 'mapping-row-header';
  headerRow.innerHTML = '<span>Source Column</span><span></span><span>Maps To</span>';
  body.appendChild(headerRow);

  sourceColumns.forEach(col => {
    const row = document.createElement('div');
    row.className = 'mapping-row';
    const samples = rawData.slice(0, 10).map(r => r[col]).filter(v => v != null && v !== '').slice(0, 3);
    const sampleText = samples.length ? samples.join(', ') : '(empty)';
    const isAuto = !!autoMatched[col];

    row.innerHTML = `
      <div class="mapping-col-name">
        ${escapeHtml(col)}${isAuto ? '<span class="mapping-badge auto">auto</span>' : ''}
        <span class="sample">${escapeHtml(sampleText)}</span>
      </div>
      <div class="mapping-arrow">&rarr;</div>
      <select class="mapping-select ${columnMapping[col] ? 'mapped' : 'unmapped'}" data-source="${escapeHtml(col)}" onchange="onMappingChange(this)">
        <option value="">-- skip --</option>
        ${TEMPLATE_FIELDS.map(f =>
          `<option value="${f.key}" ${columnMapping[col] === f.key ? 'selected' : ''}>${f.label}${f.required ? ' *' : ''}</option>`
        ).join('')}
      </select>
    `;
    body.appendChild(row);
  });

  updateMappingStatus();
  document.getElementById('mapping-overlay').classList.add('active');
}

function onMappingChange(select) {
  const sourceCol = select.getAttribute('data-source');
  const newVal = select.value;

  if (newVal) {
    document.querySelectorAll('.mapping-select').forEach(s => {
      if (s !== select && s.value === newVal) {
        s.value = '';
        s.classList.remove('mapped');
        s.classList.add('unmapped');
        delete columnMapping[s.getAttribute('data-source')];
      }
    });
  }

  if (newVal) {
    columnMapping[sourceCol] = newVal;
    select.classList.add('mapped');
    select.classList.remove('unmapped');
  } else {
    delete columnMapping[sourceCol];
    select.classList.remove('mapped');
    select.classList.add('unmapped');
  }
  updateMappingStatus();
}

function updateMappingStatus() {
  const mapped = Object.values(columnMapping);
  const total = TEMPLATE_FIELDS.length;
  const mappedCount = mapped.length;
  const requiredFields = TEMPLATE_FIELDS.filter(f => f.required);
  const missingRequired = requiredFields.filter(f => !mapped.includes(f.key));

  const statusEl = document.getElementById('mapping-status');
  const confirmBtn = document.getElementById('mapping-confirm-btn');

  if (missingRequired.length > 0) {
    statusEl.innerHTML = `<span class="count">${mappedCount}/${total}</span> mapped · <span class="warn">Required: ${missingRequired.map(f => f.label).join(', ')}</span>`;
    confirmBtn.style.opacity = '0.4';
    confirmBtn.disabled = true;
  } else {
    statusEl.innerHTML = `<span class="count">${mappedCount}/${total}</span> mapped · Ready`;
    confirmBtn.style.opacity = '1';
    confirmBtn.disabled = false;
  }
}

function cancelMapping() {
  document.getElementById('mapping-overlay').classList.remove('active');
  pendingRawData = null;
  columnMapping = {};
}

function confirmMapping() {
  if (!pendingRawData) return;
  const reverseMap = {};
  for (const [source, target] of Object.entries(columnMapping)) {
    reverseMap[target] = source;
  }
  loans = applyMapping(pendingRawData, reverseMap);
  document.getElementById('mapping-overlay').classList.remove('active');
  pendingRawData = null;
  renderDashboard();
}

function applyMapping(data, reverseMap) {
  return data.map((row, i) => ({
    loan_id:             reverseMap.loan_id ? String(row[reverseMap.loan_id] || '') || `L${i+1}` : `L${i+1}`,
    borrower_name:       reverseMap.borrower_name ? String(row[reverseMap.borrower_name] || '') : '',
    sector:              reverseMap.sector ? String(row[reverseMap.sector] || '') : '',
    region:              reverseMap.region ? String(row[reverseMap.region] || '') : '',
    loan_amount:         reverseMap.loan_amount ? parseNum(row[reverseMap.loan_amount]) : 0,
    outstanding_balance: reverseMap.outstanding_balance ? parseNum(row[reverseMap.outstanding_balance]) : 0,
    maturity_date:       reverseMap.maturity_date ? String(row[reverseMap.maturity_date] || '') : '',
    interest_rate:       reverseMap.interest_rate ? parseNum(row[reverseMap.interest_rate]) : 0,
    credit_rating:       reverseMap.credit_rating ? String(row[reverseMap.credit_rating] || '') : '',
    facility_type:       reverseMap.facility_type ? String(row[reverseMap.facility_type] || '') : '',
    default_flag:        reverseMap.default_flag ? parseDefault(row[reverseMap.default_flag]) : false
  }));
}

function parseNum(v) { const n = parseFloat(String(v).replace(/[£,$%]/g, '')); return isNaN(n) ? 0 : n; }
function parseDefault(v) { return v === true || v === 1 || v === '1' || String(v).toLowerCase() === 'yes' || String(v).toLowerCase() === 'true'; }

// ============================================================
//  SAMPLE TAPE GENERATOR + DOWNLOAD
//  Uses non-standard column names to exercise the mapping flow
// ============================================================
function generateSampleRows() {
  const sectors = ['Healthcare','Technology','Business Services','Manufacturing','Professional Services','Retail & Consumer','Construction & Property','Energy & Infrastructure','Media & Entertainment','Financial Services','Education','Hospitality & Leisure','Transport & Logistics'];
  const regions = ['London','South East','Midlands','North West','North East','Scotland','Wales','South West','East of England','Yorkshire & Humber'];
  const grades = ['A','A-','B+','B','B-','C+','C','C-','D'];
  const gradeWeights = [0.04, 0.08, 0.14, 0.24, 0.20, 0.14, 0.10, 0.04, 0.02];
  const products = ['Term Loan','Revolving Credit','Capex Facility','Acquisition Facility','Working Capital','Asset-Based Lending'];
  const productWeights = [0.35, 0.22, 0.12, 0.10, 0.13, 0.08];
  const borrowers = [
    'Acorn Manufacturing Ltd','Beacon Healthcare Group','Crestfield Properties Plc','Drummond Engineering Ltd','Evergreen Retail Holdings',
    'Foxbridge Capital Ltd','Glenmore Logistics Plc','Hartland Construction Ltd','Ironside Technologies Ltd','Jubilee Hotels Group',
    'Kingfisher Media Ltd','Lakeside Foods Plc','Millbrook Pharmaceuticals','Northgate Services Ltd','Oakwood Education Trust',
    'Pennine Transport Ltd','Quartermile Ventures Ltd','Rosewood Hospitality Plc','Silverstone Motors Ltd','Thornbury Agriculture',
    'Ashworth Textiles Ltd','Barrington Financial Plc','Cavendish Partners Ltd','Dalton Energy Services','Elmwood Care Homes Ltd',
    'Farnham Digital Ltd','Guildhall Property Trust','Hawthorn Packaging Ltd','Ivybridge Renewables','Kensington Capital Plc',
    'Langley Aerospace Ltd','Moorfield Recycling Ltd','Newbury Biotech Ltd','Osprey Defence Systems','Pemberton Mining Ltd',
    'Ridgeway Infrastructure','Stanmore Chemicals Ltd','Tavistock Brewing Co','Underwood Telecom Ltd','Vauxhall Precision Ltd',
    'Whitfield Consulting Ltd','Yarmouth Marine Services','Albion Steel Works Ltd','Brixton Foods Group','Cheltenham IT Services',
    'Devonshire Paper Mills','Exmouth Leisure Holdings','Falkirk Plant Hire Ltd','Greenwich Software Ltd','Holborn Legal Services',
    'Islington Health Partners','Jersey Finance Solutions','Kelso Agricultural Co','Lewisham Logistics Ltd','Manchester Print Group',
    'Norwich Data Centre Ltd','Oxford Instruments Plc','Preston Composites Ltd','Reading Facilities Mgmt','Sheffield Forgings Ltd',
    'Taunton Warehousing Ltd','Uxbridge Engineering Plc','Warwick Plastics Ltd','Exeter Renewable Power','York Building Supplies'
  ];

  function weightedRandom(weights) {
    const r = Math.random();
    let cum = 0;
    for (let i = 0; i < weights.length; i++) { cum += weights[i]; if (r <= cum) return i; }
    return weights.length - 1;
  }

  function randomDate(startYear, endYear) {
    const y = startYear + Math.floor(Math.random() * (endYear - startYear + 1));
    const m = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
    const d = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
    return `${d}/${m}/${y}`;
  }

  const rows = [];
  for (let i = 1; i <= 150; i++) {
    const gradeIdx = weightedRandom(gradeWeights);
    const prodIdx = weightedRandom(productWeights);
    const facilitySize = Math.round((250000 + Math.random() * 9750000) / 25000) * 25000;
    const isRevolver = prodIdx === 1 || prodIdx === 4;
    const util = isRevolver ? (0.1 + Math.random() * 0.6) : (0.85 + Math.random() * 0.15);
    const drawn = Math.round(facilitySize * util / 1000) * 1000;
    const baseRate = [3.5, 4.2, 5.0, 5.8, 6.5, 7.5, 8.5, 10.0, 12.0][gradeIdx];
    const rate = Math.round((baseRate + (Math.random() - 0.5) * 1.2) * 100) / 100;
    const defaultProb = [0.002, 0.005, 0.01, 0.02, 0.04, 0.07, 0.12, 0.18, 0.30][gradeIdx];
    const isDefault = Math.random() < defaultProb;

    // Use non-standard column names to test the mapper
    rows.push({
      'Facility_Ref':      `EF-${String(i).padStart(5, '0')}`,
      'Counterparty':      borrowers[Math.floor(Math.random() * borrowers.length)],
      'Industry':          sectors[Math.floor(Math.random() * sectors.length)],
      'Geography':         regions[Math.floor(Math.random() * regions.length)],
      'Facility_Limit':    facilitySize,
      'Current_Drawn':     drawn,
      'Final_Maturity':    randomDate(2026, 2032),
      'All_In_Rate':       Math.max(2.5, rate),
      'Risk_Grade':        grades[gradeIdx],
      'Product_Type':      products[prodIdx],
      'NPL_Flag':          isDefault ? 'Yes' : 'No'
    });
  }
  return rows;
}

function downloadSampleTape() {
  const rows = generateSampleRows();
  const ws = XLSX.utils.json_to_sheet(rows);

  // Set column widths
  ws['!cols'] = [
    { wch: 14 }, { wch: 30 }, { wch: 24 }, { wch: 20 },
    { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 12 },
    { wch: 12 }, { wch: 22 }, { wch: 10 }
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Loan Tape');
  XLSX.writeFile(wb, 'sample_tape_enable_funding.xlsx');
}

// ============================================================
//  FORMATTING HELPERS — GBP
// ============================================================
function fmtM(v) {
  if (v >= 1e9) return '\u00A3' + (v / 1e9).toFixed(2) + 'bn';
  if (v >= 1e6) return '\u00A3' + (v / 1e6).toFixed(1) + 'mm';
  if (v >= 1e3) return '\u00A3' + (v / 1e3).toFixed(0) + 'k';
  return '\u00A3' + v.toFixed(0);
}
function fmtFull(v) { return '\u00A3' + v.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
function fmtPct(v) { return v.toFixed(2) + '%'; }
function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ============================================================
//  TABS
// ============================================================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ============================================================
//  RENDER DASHBOARD
// ============================================================
function renderDashboard() {
  document.getElementById('upload-section').style.display = 'none';
  document.getElementById('dashboard').classList.add('active');
  renderStats();
  renderTopExposures();
  renderCharts();
  renderDataTable();
}

// ============================================================
//  STATS
// ============================================================
function renderStats() {
  const totalOriginal = loans.reduce((s, l) => s + l.loan_amount, 0);
  const totalOutstanding = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const defaults = loans.filter(l => l.default_flag);
  const defaultRate = loans.length > 0 ? (defaults.length / loans.length) * 100 : 0;

  const wair = totalOutstanding > 0
    ? loans.reduce((s, l) => s + l.interest_rate * l.outstanding_balance, 0) / totalOutstanding
    : 0;

  const now = new Date();
  const wam = totalOutstanding > 0
    ? loans.reduce((s, l) => {
        const mat = parseDate(l.maturity_date);
        const years = mat ? Math.max(0, (mat - now) / (365.25 * 86400000)) : 0;
        return s + years * l.outstanding_balance;
      }, 0) / totalOutstanding
    : 0;

  const uniqueBorrowers = new Set(loans.map(l => l.borrower_name)).size;
  const avgFacility = loans.length > 0 ? totalOriginal / loans.length : 0;
  const utilisation = totalOriginal > 0 ? (totalOutstanding / totalOriginal) * 100 : 0;

  document.getElementById('s-portfolio-size').textContent = fmtM(totalOriginal);
  document.getElementById('s-loan-count').textContent = loans.length + ' facilities';
  document.getElementById('s-outstanding').textContent = fmtM(totalOutstanding);
  document.getElementById('s-utilisation').textContent = fmtPct(utilisation) + ' drawn';
  document.getElementById('s-wair').textContent = fmtPct(wair);
  document.getElementById('s-wam').textContent = wam.toFixed(2) + ' yrs';
  document.getElementById('s-default-rate').textContent = fmtPct(defaultRate);
  document.getElementById('s-default-count').textContent = defaults.length + ' defaults';
  document.getElementById('s-borrower-count').textContent = uniqueBorrowers;
  document.getElementById('s-avg-facility').textContent = 'Avg facility: ' + fmtM(avgFacility);
}

// Parse DD/MM/YYYY or YYYY-MM-DD or other common formats
function parseDate(s) {
  if (!s) return null;
  // DD/MM/YYYY
  const dmy = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (dmy) {
    const day = parseInt(dmy[1]), mon = parseInt(dmy[2]), yr = parseInt(dmy[3]);
    if (day > 12) return new Date(yr, mon - 1, day); // definitely DD/MM
    if (mon > 12) return new Date(yr, day - 1, mon); // definitely MM/DD
    return new Date(yr, mon - 1, day); // assume DD/MM for UK
  }
  // YYYY-MM-DD
  const ymd = String(s).match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (ymd) return new Date(parseInt(ymd[1]), parseInt(ymd[2]) - 1, parseInt(ymd[3]));
  // Excel serial number
  const num = parseFloat(s);
  if (!isNaN(num) && num > 30000 && num < 100000) {
    return new Date((num - 25569) * 86400000);
  }
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

// ============================================================
//  TOP EXPOSURES
// ============================================================
function renderTopExposures() {
  const totalOutstanding = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const sorted = [...loans].sort((a, b) => b.outstanding_balance - a.outstanding_balance).slice(0, 10);

  document.getElementById('top-exposures-body').innerHTML = sorted.map((l, i) => {
    const pct = totalOutstanding > 0 ? ((l.outstanding_balance / totalOutstanding) * 100).toFixed(2) : '0.00';
    const statusClass = l.default_flag ? 'badge-negative' : 'badge-positive';
    const statusText = l.default_flag ? 'Default' : 'Current';
    return `<tr>
      <td>${i + 1}</td>
      <td>${escapeHtml(l.borrower_name)}</td>
      <td>${escapeHtml(l.sector)}</td>
      <td>${fmtFull(l.outstanding_balance)}</td>
      <td>${pct}%</td>
      <td>${escapeHtml(l.credit_rating)}</td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
    </tr>`;
  }).join('');
}

// ============================================================
//  CHARTS
// ============================================================
const chartDefaults = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: { labels: { color: '#585e6f', font: { size: 10, family: "'SF Mono','Consolas','Menlo',monospace" }, padding: 10, boxWidth: 10 } },
    tooltip: { backgroundColor: '#181a22', titleColor: '#b8bcc8', bodyColor: '#b8bcc8', borderColor: '#21242e', borderWidth: 1, titleFont: { family: "'SF Mono','Consolas',monospace", size: 11 }, bodyFont: { family: "'SF Mono','Consolas',monospace", size: 11 } }
  }
};

function destroyCharts() {
  Object.values(charts).forEach(c => c.destroy());
  charts = {};
}

function renderCharts() {
  destroyCharts();
  const totalOutstanding = loans.reduce((s, l) => s + l.outstanding_balance, 0);

  const sectorMap = groupBy(loans, 'sector', 'outstanding_balance');
  charts.sector = new Chart(document.getElementById('chart-sector'), {
    type: 'doughnut',
    data: { labels: Object.keys(sectorMap), datasets: [{ data: Object.values(sectorMap), backgroundColor: COLORS, borderWidth: 0 }] },
    options: { ...chartDefaults, cutout: '60%', plugins: { ...chartDefaults.plugins, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.label + ': ' + fmtM(ctx.raw) + ' (' + (totalOutstanding > 0 ? ((ctx.raw / totalOutstanding) * 100).toFixed(1) : 0) + '%)' } } } }
  });

  const regionMap = groupBy(loans, 'region', 'outstanding_balance');
  charts.region = new Chart(document.getElementById('chart-region'), {
    type: 'doughnut',
    data: { labels: Object.keys(regionMap), datasets: [{ data: Object.values(regionMap), backgroundColor: COLORS.slice(5).concat(COLORS.slice(0, 5)), borderWidth: 0 }] },
    options: { ...chartDefaults, cutout: '60%', plugins: { ...chartDefaults.plugins, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.label + ': ' + fmtM(ctx.raw) + ' (' + (totalOutstanding > 0 ? ((ctx.raw / totalOutstanding) * 100).toFixed(1) : 0) + '%)' } } } }
  });

  const ratingMap = groupBy(loans, 'credit_rating', 'outstanding_balance');
  const allRatings = Object.keys(ratingMap);
  charts.rating = new Chart(document.getElementById('chart-rating'), {
    type: 'bar',
    data: { labels: allRatings, datasets: [{ label: 'Outstanding', data: allRatings.map(r => ratingMap[r] || 0), backgroundColor: '#4a6a8f', borderRadius: 2, borderWidth: 0 }] },
    options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: false } }, scales: { x: { ticks: { color: '#585e6f', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { display: false } }, y: { ticks: { color: '#585e6f', callback: v => fmtM(v), font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: 'rgba(33,36,46,0.8)' }, beginAtZero: true } } }
  });

  const borrowerMap = {};
  loans.forEach(l => { borrowerMap[l.borrower_name] = (borrowerMap[l.borrower_name] || 0) + l.outstanding_balance; });
  const top10 = Object.entries(borrowerMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
  charts.top10 = new Chart(document.getElementById('chart-top10'), {
    type: 'bar',
    data: { labels: top10.map(b => b[0].length > 22 ? b[0].slice(0, 20) + '..' : b[0]), datasets: [{ label: 'Exposure', data: top10.map(b => b[1]), backgroundColor: '#4a6a8f', borderRadius: 2, borderWidth: 0 }] },
    options: { ...chartDefaults, indexAxis: 'y', plugins: { ...chartDefaults.plugins, legend: { display: false } }, scales: { x: { ticks: { color: '#585e6f', callback: v => fmtM(v), font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: 'rgba(33,36,46,0.8)' }, beginAtZero: true }, y: { ticks: { color: '#585e6f', font: { size: 9, family: "'SF Mono','Consolas',monospace" } }, grid: { display: false } } } }
  });

  const now = new Date();
  const buckets = { '<1yr': 0, '1-2yr': 0, '2-3yr': 0, '3-5yr': 0, '5-7yr': 0, '7+yr': 0 };
  loans.forEach(l => {
    const mat = parseDate(l.maturity_date);
    const years = mat ? Math.max(0, (mat - now) / (365.25 * 86400000)) : 0;
    if (years < 1) buckets['<1yr'] += l.outstanding_balance;
    else if (years < 2) buckets['1-2yr'] += l.outstanding_balance;
    else if (years < 3) buckets['2-3yr'] += l.outstanding_balance;
    else if (years < 5) buckets['3-5yr'] += l.outstanding_balance;
    else if (years < 7) buckets['5-7yr'] += l.outstanding_balance;
    else buckets['7+yr'] += l.outstanding_balance;
  });
  charts.maturity = new Chart(document.getElementById('chart-maturity'), {
    type: 'bar',
    data: { labels: Object.keys(buckets), datasets: [{ label: 'Outstanding', data: Object.values(buckets), backgroundColor: '#5a7a6e', borderRadius: 2, borderWidth: 0 }] },
    options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: false } }, scales: { x: { ticks: { color: '#585e6f', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { display: false } }, y: { ticks: { color: '#585e6f', callback: v => fmtM(v), font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: 'rgba(33,36,46,0.8)' }, beginAtZero: true } } }
  });
}

function groupBy(arr, key, sumKey) {
  const map = {};
  arr.forEach(item => { const k = item[key] || '(blank)'; map[k] = (map[k] || 0) + item[sumKey]; });
  return Object.fromEntries(Object.entries(map).sort((a, b) => b[1] - a[1]));
}

// ============================================================
//  DATA TABLE
// ============================================================
function renderDataTable() {
  document.getElementById('data-table-title').textContent = `Tape Data \u2014 ${loans.length} records`;
  document.getElementById('data-table-body').innerHTML = loans.map(l => {
    const statusClass = l.default_flag ? 'badge-negative' : 'badge-positive';
    const statusText = l.default_flag ? 'Yes' : 'No';
    return `<tr>
      <td>${escapeHtml(l.loan_id)}</td>
      <td>${escapeHtml(l.borrower_name)}</td>
      <td>${escapeHtml(l.sector)}</td>
      <td>${escapeHtml(l.region)}</td>
      <td>${fmtFull(l.loan_amount)}</td>
      <td>${fmtFull(l.outstanding_balance)}</td>
      <td>${escapeHtml(l.maturity_date)}</td>
      <td>${l.interest_rate.toFixed(2)}%</td>
      <td>${escapeHtml(l.credit_rating)}</td>
      <td>${escapeHtml(l.facility_type)}</td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
    </tr>`;
  }).join('');
}

// ============================================================
//  EXPORT CSV
// ============================================================
function exportCSV() {
  if (!loans.length) return;
  const headers = ['loan_id','borrower_name','sector','region','loan_amount','outstanding_balance','maturity_date','interest_rate','credit_rating','facility_type','default_flag'];
  const rows = loans.map(l => headers.map(h => {
    const val = l[h];
    if (typeof val === 'boolean') return val ? '1' : '0';
    if (typeof val === 'string' && val.includes(',')) return '"' + val + '"';
    return val;
  }).join(','));
  const csv = headers.join(',') + '\n' + rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tape_export.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
