<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tape Analyser — Enable Funding</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #f7f8fa;
      --surface: #ffffff;
      --border: #e2e5ea;
      --border-light: #eef0f3;
      --text: #1a1e2a;
      --text-secondary: #4a5068;
      --text-muted: #8890a0;
      --navy: #003078;
      --navy-light: #1d4e9e;
      --navy-faint: rgba(0,48,120,0.06);
      --teal: #00857c;
      --teal-faint: rgba(0,133,124,0.06);
      --red: #b3253a;
      --red-faint: rgba(179,37,58,0.05);
      --green: #00703c;
      --green-faint: rgba(0,112,60,0.05);
      --amber: #b58900;
      --amber-faint: rgba(181,137,0,0.06);
      --radius: 4px;
      --mono: 'SF Mono', 'Consolas', 'Menlo', 'Monaco', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      font-size: 14px;
    }

    .nav {
      background: var(--navy);
      padding: 0 28px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-brand {
      font-size: 15px;
      font-weight: 600;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-brand svg { width: 20px; height: 20px; color: rgba(255,255,255,0.7); }
    .nav-sub { font-size: 13px; color: rgba(255,255,255,0.55); font-weight: 400; margin-left: 6px; }
    .nav-actions { display: flex; gap: 8px; align-items: center; }

    .btn {
      padding: 7px 14px;
      border: none;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s, background 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }
    .btn:hover { opacity: 0.85; }
    .btn-nav { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.2); }
    .btn-nav:hover { background: rgba(255,255,255,0.22); }
    .btn-primary { background: var(--navy); color: #ffffff; }
    .btn-outline { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-outline:hover { background: var(--navy-faint); border-color: var(--navy-light); color: var(--navy); }
    .btn-teal { background: var(--teal); color: #ffffff; }
    .btn-sm { padding: 5px 12px; font-size: 12px; }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px 28px; }

    .home-page { max-width: 640px; margin: 80px auto 0; text-align: center; }
    .home-title { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
    .home-subtitle { font-size: 14px; color: var(--text-muted); margin-bottom: 32px; }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 48px 40px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      background: var(--surface);
    }
    .upload-area:hover, .upload-area.drag-over {
      border-color: var(--navy);
      background: var(--navy-faint);
    }
    .upload-area svg { width: 36px; height: 36px; color: var(--text-muted); margin-bottom: 12px; }
    .upload-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .upload-sub { font-size: 13px; color: var(--text-muted); }
    .upload-area input { display: none; }

    .sample-section {
      margin-top: 24px;
      padding: 20px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .sample-section p { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }

    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .section { margin-bottom: 20px; }
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 10px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 16px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
    }
    .stat-card { padding: 16px; }
    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      white-space: nowrap;
      color: var(--text);
      font-family: var(--mono);
    }
    .stat-sub { font-size: 12px; color: var(--text-muted); margin-top: 3px; }

    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--navy); border-bottom-color: var(--navy); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .chart-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .chart-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .chart-card { padding: 16px; }
    .chart-card h3 {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-secondary);
    }
    .chart-wrap { position: relative; height: 260px; }

    .table-card { padding: 0; overflow: hidden; }
    .table-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-light);
    }
    .table-header h3 { font-size: 13px; font-weight: 600; color: var(--text-secondary); }
    .table-scroll { max-height: 420px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--surface);
      font-weight: 600;
    }
    thead th.right, tbody td.right { text-align: right; }
    tbody td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-light);
      font-size: 13px;
    }
    tbody td.mono { font-family: var(--mono); font-size: 12px; }
    tbody tr:hover { background: var(--navy-faint); }
    tbody tr:last-child td { border-bottom: none; }
    tfoot td {
      padding: 10px 12px;
      border-top: 2px solid var(--border);
      font-size: 13px;
      font-weight: 700;
    }
    tfoot td.mono { font-family: var(--mono); font-size: 12px; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-green { background: var(--green-faint); color: var(--green); }
    .badge-red { background: var(--red-faint); color: var(--red); }
    .badge-amber { background: var(--amber-faint); color: var(--amber); }
    .badge-navy { background: var(--navy-faint); color: var(--navy); }

    /* STRATIFICATION */
    .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .strat-card { padding: 0; overflow: hidden; }
    .strat-card-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-light);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .strat-card .table-scroll { max-height: 340px; }

    /* ANOMALIES */
    .anomaly-summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .anomaly-summary-card {
      padding: 14px;
      text-align: center;
    }
    .anomaly-summary-card .stat-value { font-size: 1.5rem; }
    .anomaly-list { display: flex; flex-direction: column; gap: 10px; }
    .anomaly-card {
      padding: 14px 16px;
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }
    .anomaly-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .anomaly-icon.error { background: var(--red-faint); color: var(--red); }
    .anomaly-icon.warning { background: var(--amber-faint); color: var(--amber); }
    .anomaly-icon.info { background: var(--navy-faint); color: var(--navy); }
    .anomaly-body { flex: 1; min-width: 0; }
    .anomaly-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
    .anomaly-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .anomaly-examples { font-size: 11px; color: var(--text-muted); font-family: var(--mono); }
    .anomaly-count {
      font-size: 12px;
      font-weight: 600;
      font-family: var(--mono);
      white-space: nowrap;
    }

    /* MAPPING MODAL */
    .mapping-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .mapping-overlay.active { display: flex; }
    .mapping-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      width: 720px;
      max-width: 95vw;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    .mapping-modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-light); }
    .mapping-modal-header h2 { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--text); }
    .mapping-modal-header p { font-size: 13px; color: var(--text-muted); }
    .mapping-modal-body { padding: 12px 24px; overflow-y: auto; flex: 1; }
    .mapping-modal-footer {
      padding: 14px 24px;
      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mapping-status { font-size: 13px; color: var(--text-muted); }
    .mapping-status .count { color: var(--navy); font-weight: 600; }
    .mapping-status .warn { color: var(--red); }

    .mapping-row {
      display: grid;
      grid-template-columns: 1fr 32px 1fr;
      gap: 10px;
      align-items: center;
      padding: 7px 0;
      border-bottom: 1px solid var(--border-light);
    }
    .mapping-row:last-child { border-bottom: none; }
    .mapping-row-header {
      display: grid;
      grid-template-columns: 1fr 32px 1fr;
      gap: 10px;
      padding: 4px 0 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2px;
    }
    .mapping-row-header span {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }
    .mapping-col-name {
      font-size: 13px;
      font-weight: 500;
      padding: 6px 10px;
      background: var(--bg);
      border-radius: var(--radius);
    }
    .mapping-col-name .sample {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mapping-arrow { text-align: center; color: var(--text-muted); font-size: 12px; }
    .mapping-select {
      width: 100%;
      padding: 7px 10px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%238890a0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 24px;
    }
    .mapping-select:focus { outline: none; border-color: var(--navy); }
    .mapping-select.mapped { border-color: var(--navy-light); }
    .mapping-select option.option-in-use { color: var(--text-muted); font-style: italic; }

    /* LOADING OVERLAY */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.85);
      z-index: 300;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
    }
    .loading-overlay.active { display: flex; }
    .loading-spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--navy);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
    .loading-sub { font-size: 12px; color: var(--text-muted); }
    .mapping-badge {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      margin-left: 6px;
      font-weight: 600;
      vertical-align: middle;
    }
    .mapping-badge.auto { background: var(--navy-faint); color: var(--navy); }

    /* CUSTOM FIELD INLINE CONFIG */
    .custom-field-config {
      grid-column: 1 / -1;
      background: var(--navy-faint);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .cf-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .cf-row label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      min-width: 60px;
    }
    .cf-row input, .cf-row select {
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 12px;
      font-family: inherit;
      background: var(--surface);
    }
    .cf-row input:focus, .cf-row select:focus { outline: none; border-color: var(--navy); }
    .cf-row input.cf-label-input { flex: 1; }
    .cf-bands-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .cf-band-tag {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    .cf-band-del {
      cursor: pointer;
      opacity: 0.5;
      border: none;
      background: none;
      color: inherit;
      font-size: 11px;
      padding: 0 2px;
    }
    .cf-band-del:hover { opacity: 1; color: var(--red); }
    .cf-hint {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
    }
    .cf-options-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .cf-option-tag {
      display: inline-block;
      padding: 2px 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    @media (max-width: 1100px) {
      .stat-grid { grid-template-columns: repeat(3, 1fr); }
      .chart-grid-3 { grid-template-columns: 1fr 1fr; }
      .strat-grid { grid-template-columns: 1fr; }
      .anomaly-summary { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 700px) {
      .container { padding: 12px; }
      .stat-grid { grid-template-columns: 1fr 1fr; }
      .chart-grid-2, .chart-grid-3 { grid-template-columns: 1fr; }
      .home-page { margin: 40px 16px 0; }
      .anomaly-summary { grid-template-columns: 1fr 1fr; }
    }

    /* SETTINGS MODAL */
    .settings-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 300;
      align-items: center;
      justify-content: center;
    }
    .settings-overlay.active { display: flex; }
    .settings-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      width: 780px;
      max-width: 95vw;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    .settings-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .settings-modal-header h2 { font-size: 16px; font-weight: 600; color: var(--text); }
    .settings-modal-body { padding: 16px 24px; overflow-y: auto; flex: 1; }
    .settings-section { margin-bottom: 20px; }
    .settings-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 10px;
    }
    .opt-field-group { margin-bottom: 16px; }
    .opt-field-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .opt-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .opt-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--navy-faint);
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .opt-tag-edit, .opt-tag-del {
      cursor: pointer;
      opacity: 0.5;
      font-size: 11px;
      border: none;
      background: none;
      color: inherit;
      padding: 0 2px;
    }
    .opt-tag-edit:hover { opacity: 1; color: var(--navy); }
    .opt-tag-del:hover { opacity: 1; color: var(--red); }
    .opt-add-row {
      display: flex;
      gap: 6px;
    }
    .opt-add-input {
      flex: 1;
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 12px;
      font-family: inherit;
    }
    .opt-add-input:focus { outline: none; border-color: var(--navy); }
    .opt-add-btn {
      padding: 5px 12px;
      background: var(--navy);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 12px;
      cursor: pointer;
    }

    /* CUSTOM TESTS */
    .custom-test-section {
      margin-top: 20px;
      padding: 16px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      background: var(--surface);
    }
    .custom-test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .custom-test-header h3 { font-size: 13px; font-weight: 600; color: var(--text-secondary); }
    .custom-test-list { display: flex; flex-direction: column; gap: 8px; }
    .custom-test-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      background: var(--bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-light);
    }
    .custom-test-row select, .custom-test-row input {
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 12px;
      font-family: inherit;
      background: var(--surface);
    }
    .custom-test-row select:focus, .custom-test-row input:focus { outline: none; border-color: var(--navy); }
    .custom-test-row .ct-field { width: 160px; }
    .custom-test-row .ct-op { width: 100px; }
    .custom-test-row .ct-val { width: 120px; }
    .custom-test-row .ct-sev { width: 90px; }
    .custom-test-row .ct-name { flex: 1; min-width: 100px; }
    .ct-del {
      cursor: pointer;
      color: var(--text-muted);
      border: none;
      background: none;
      font-size: 14px;
      padding: 2px 4px;
    }
    .ct-del:hover { color: var(--red); }
    .custom-test-empty { font-size: 12px; color: var(--text-muted); text-align: center; padding: 12px; }

    /* SERIES SELECTOR */
    .series-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
    }
    .series-bar-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .series-pills {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .series-pill {
      padding: 4px 12px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-family: inherit;
      transition: all 0.15s;
    }
    .series-pill:hover { background: var(--navy-faint); border-color: var(--navy-light); }
    .series-pill.active { background: var(--navy); color: #fff; border-color: var(--navy); }
    .series-pill .pill-count { font-size: 10px; opacity: 0.7; margin-left: 4px; }
    .series-pill .pill-cutoff { font-size: 9px; opacity: 0.6; margin-left: 4px; font-style: italic; }
    .cutoff-banner { display:flex; align-items:center; gap:8px; padding:6px 12px; background:var(--navy-faint); border:1px solid var(--border-light); border-radius:var(--radius); margin-bottom:12px; font-size:12px; color:var(--text-secondary); }
    .cutoff-banner .cutoff-label { font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.04em; font-size:11px; }
    .cutoff-banner .cutoff-value { font-family:var(--mono); font-weight:600; color:var(--navy); }

    /* OVERVIEW WIDGETS */
    .ow-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .ow-card { padding: 16px; }
    .ow-card h3 {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-secondary);
    }
    .health-bar-track {
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .health-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.4s;
    }
    .health-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    .health-metric {
      text-align: center;
    }
    .health-metric-val {
      font-size: 1.1rem;
      font-weight: 700;
      font-family: var(--mono);
    }
    .health-metric-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .mini-chart-wrap { height: 160px; position: relative; }
    .ow-exposures-table { width: 100%; font-size: 12px; }
    .ow-exposures-table th { font-size: 10px; }
    .ow-exposures-table td { padding: 5px 8px; font-size: 12px; }
    .arrears-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .arrears-bucket {
      text-align: center;
      padding: 10px 4px;
      border-radius: var(--radius);
    }
    .arrears-bucket-val {
      font-size: 1rem;
      font-weight: 700;
      font-family: var(--mono);
    }
    .arrears-bucket-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .arrears-bucket-pct {
      font-size: 10px;
      font-family: var(--mono);
      color: var(--text-secondary);
    }
    @media (max-width: 1100px) {
      .ow-grid { grid-template-columns: 1fr; }
      .arrears-grid { grid-template-columns: repeat(3, 1fr); }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<nav class="nav">
  <div class="nav-brand">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="1"/><path d="M2 9h20"/><path d="M9 21V9"/></svg>
    Tape Analyser<span class="nav-sub">Enable Funding</span>
  </div>
  <div class="nav-actions" id="nav-actions"></div>
</nav>

<div class="container">

  <!-- HOME / UPLOAD -->
  <div id="upload-section">
    <div class="home-page">
      <h1 class="home-title">Data Tape Analyser</h1>
      <p class="home-subtitle">Upload a loan or lease tape to analyse portfolio composition, concentration, stratification and data quality.</p>

      <input type="file" id="file-input" accept=".csv,.xlsx,.xls" multiple style="display:none">
      <div class="upload-area" id="upload-area">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <div class="upload-title">Upload Data Tape</div>
        <div class="upload-sub">Drag & drop a CSV or Excel file, or click to browse</div>
        <div class="upload-sub" style="margin-top:6px; font-size:12px;">Any column layout accepted — you'll map columns after upload</div>
      </div>

      <div class="sample-section">
        <p>No tape to hand? Download a sample file with 200 UK lease receivables (includes deliberate anomalies for testing).</p>
        <button class="btn btn-teal" onclick="downloadSampleTape()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download Sample Tape (.xlsx)
        </button>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard" id="dashboard">

    <div class="series-bar" id="series-bar" style="display:none;">
      <span class="series-bar-label">Portfolio:</span>
      <div class="series-pills" id="series-pills"></div>
      <button class="btn btn-outline btn-sm" style="margin-left:auto;" onclick="addAnotherTape()">+ Add Tape</button>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="stratification">Stratification</div>
      <div class="tab" data-tab="anomalies">Anomalies</div>
      <div class="tab" data-tab="comparison" id="tab-comparison-link" style="display:none;">Comparison</div>
      <div class="tab" data-tab="data">Tape Data</div>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <div id="cutoff-date-banner"></div>
      <div class="section">
        <div class="stat-grid" id="stat-grid-container"></div>
      </div>
      <div id="overview-widgets"></div>
      <div class="section">
        <div class="chart-grid-2">
          <div class="card chart-card"><h3>Sector Concentration</h3><div class="chart-wrap"><canvas id="chart-sector"></canvas></div></div>
          <div class="card chart-card"><h3 id="chart-top-title">Top 10 Lessee Exposures</h3><div class="chart-wrap"><canvas id="chart-top10"></canvas></div></div>
        </div>
      </div>
      <div class="section">
        <div class="chart-grid-3">
          <div class="card chart-card"><h3>Loan Size Distribution</h3><div class="chart-wrap"><canvas id="chart-loansize"></canvas></div></div>
          <div class="card chart-card"><h3>Original Term</h3><div class="chart-wrap"><canvas id="chart-maturity"></canvas></div></div>
          <div class="card chart-card"><h3>Regional Breakdown</h3><div class="chart-wrap"><canvas id="chart-region"></canvas></div></div>
        </div>
      </div>
    </div>

    <!-- STRATIFICATION TAB -->
    <div class="tab-content" id="tab-stratification">
      <div class="section" id="strat-content"></div>
    </div>

    <!-- ANOMALIES TAB -->
    <div class="tab-content" id="tab-anomalies">
      <div class="section" id="anomaly-summary-section"></div>
      <div class="section" id="anomaly-list-section"></div>
      <div class="section">
        <div class="custom-test-section">
          <div class="custom-test-header">
            <h3>Custom Tests</h3>
            <button class="btn btn-outline btn-sm" onclick="addCustomTest()">+ Add Test</button>
          </div>
          <div class="custom-test-list" id="custom-test-list">
            <div class="custom-test-empty" id="custom-test-empty">No custom tests defined. Click "+ Add Test" to create one.</div>
          </div>
          <div style="margin-top:10px; text-align:right;">
            <button class="btn btn-primary btn-sm" onclick="runCustomTests()" id="run-custom-tests-btn" style="display:none;">Run Custom Tests</button>
          </div>
        </div>
      </div>
    </div>

    <!-- COMPARISON TAB -->
    <div class="tab-content" id="tab-comparison">
      <div class="section" id="comparison-content"></div>
    </div>

    <!-- DATA TAB -->
    <div class="tab-content" id="tab-data">
      <div class="section">
        <div class="card table-card">
          <div class="table-header">
            <h3 id="data-table-title">Tape Data</h3>
            <div style="display:flex;gap:6px;">
              <button class="btn btn-outline btn-sm" onclick="exportCSV()">Export CSV</button>
              <button class="btn btn-outline btn-sm" onclick="exportXLSX()">Export XLSX (All Tabs)</button>
            </div>
          </div>
          <div class="table-scroll" style="max-height:600px;">
            <div id="data-table-container"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- COLUMN MAPPING MODAL -->
<div class="mapping-overlay" id="mapping-overlay">
  <div class="mapping-modal">
    <div class="mapping-modal-header">
      <h2>Map Your Columns</h2>
      <p>We detected <strong id="mapping-col-count">0</strong> columns. Map each to a template field — auto-matched where possible.</p>
    </div>
    <div class="mapping-modal-body" id="mapping-body"></div>
    <div class="mapping-modal-footer">
      <div class="mapping-status" id="mapping-status"></div>
      <div style="display:flex; align-items:center; gap:12px;">
        <label style="font-size:12px; font-weight:600; color:var(--text-muted); white-space:nowrap;">Cut-Off Date</label>
        <input type="date" id="mapping-cutoff-date" style="font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:var(--radius); font-family:inherit; background:var(--surface);">
        <button class="btn btn-outline btn-sm" onclick="cancelMapping()">Cancel</button>
        <button class="btn btn-primary btn-sm" id="mapping-confirm-btn" onclick="confirmMapping()">Confirm & Analyse</button>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="settings-overlay" id="settings-overlay">
  <div class="settings-modal">
    <div class="settings-modal-header">
      <h2>Settings</h2>
      <button class="btn btn-outline btn-sm" onclick="closeSettings()">Close</button>
    </div>
    <div class="settings-modal-body" id="settings-body"></div>
  </div>
</div>

<!-- FIELD RE-CATEGORISATION MODAL -->
<div class="mapping-overlay" id="recat-overlay">
  <div class="mapping-modal" style="max-height:80vh;">
    <div class="mapping-modal-body" id="recat-body" style="padding:20px 24px;overflow-y:auto;"></div>
  </div>
</div>

<!-- VALUE MAPPING MODAL -->
<div class="mapping-overlay" id="valuemap-overlay">
  <div class="mapping-modal" style="max-height:85vh;">
    <div class="mapping-modal-header">
      <h2>Harmonise Field Values</h2>
      <p>Values in this tape that don't match existing tapes are highlighted. Map them to a standard value or keep as-is.</p>
    </div>
    <div class="mapping-modal-body" id="valuemap-body" style="padding:12px 24px;overflow-y:auto;"></div>
    <div class="mapping-modal-footer">
      <div class="mapping-status" id="valuemap-status"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-outline btn-sm" onclick="goBackFromHarmonisation()">&#8592; Back</button>
        <button class="btn btn-outline btn-sm" onclick="closeValueMapping()">Skip</button>
        <button class="btn btn-primary btn-sm" onclick="applyValueMapping()">Apply & Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loading-text">Loading...</div>
  <div class="loading-sub" id="loading-sub"></div>
</div>

<script>
// ============================================================
//  STATE
// ============================================================
let loans = [];
let charts = {};
let pendingRawData = null;
let columnMapping = {};
let customTests = [];

// Custom fields defined during mapping — persists across tapes
// { key: { key, label, type ('categorical'|'numeric'|'text'|'date'), options: [], bands: [{label,min,max}] } }
let customFieldDefs = {};

// Column mapping memory — remembers previous source column -> template field mappings
// so when the same column name appears in a new tape, it's auto-matched
let columnMappingMemory = {}; // { normalised_source_col: template_field_key }

// Configurable predefined options per field — users can add/edit/delete
let fieldOptions = {
  facility_type:       ['Loan', 'Hire Purchase', 'Finance Lease', 'Operating Lease', 'Refinance'],
  bbb_guarantee:       ['None', 'GGS', 'RLS'],
  loan_status:         ['Live', 'Repaid', 'Defaulted', 'Written Off', 'Restructured', 'Settled Early'],
  arrears_status:      ['Current', '1-30 days', '31-60 days', '61-90 days', '>90 days'],
  customer_segment:    ['SME', 'Mid-Market', 'Large Corporate', 'Micro Enterprise', 'Sole Trader'],
  // payment_frequency removed from defaults per user request
  interest_rate_type:  ['Fixed', 'Floating', 'Mixed'],
  repayment_method:    ['Level', 'Reducing', 'Balloon', 'Seasonal', 'Stepped'],
  amortisation_type:   ['Annuity', 'Linear', 'Bullet', 'Soft Bullet'],
  vat_deferral:        ['Yes', 'No', 'Partial'],
  equipment_type:      ['Vehicles', 'Plant & Machinery', 'IT Equipment', 'Office Equipment', 'Commercial Vehicles', 'Medical Equipment', 'Construction Equipment'],
  asset_category:      ['Hard Asset', 'Soft Asset', 'Vehicle', 'Property', 'Technology'],
  origination_channel: ['Direct', 'Broker', 'Vendor', 'Online', 'Branch'],
  broker:              [],
  originator:          [],
  lessee_type:         ['Limited Company', 'Sole Trader', 'Partnership', 'LLP', 'PLC', 'Charity', 'Individual']
};

// Display settings
let displaySettings = {
  termUnit: 'months', // 'months', 'years', 'days'
  rateFormat: 'auto', // 'auto', 'percentage' (5 = 5%), 'decimal' (0.05 = 5%)
  overviewWidgets: ['stats', 'keyRisks', 'topExposures', 'facilityMix', 'maturityProfile', 'arrearsSnapshot', 'originationProfile'],
  topObligorCount: 10, // adjustable top X
  // Per-series hidden strats: { 'all': ['field_key',...], 'Series 1': [...] }
  hiddenStrats: {},
  // Per-series hidden concentration charts: { 'all': ['sector','region',...], 'Series 1': [...] }
  hiddenCharts: {}
};

// Multi-tape series management
let tapes = []; // [{name, series, loans, sourceColumnNames, columnMapping}]
let activeSeries = 'all'; // 'all' or specific series name
let currentTapeName = '';

// SIC code → sector mapping (UK SIC 2007 divisions)
const SIC_DIVISION_MAP = {
  '01':'Agriculture','02':'Forestry','03':'Fishing',
  '05':'Mining','06':'Oil & Gas','07':'Metal Ores','08':'Quarrying','09':'Mining Support',
  '10':'Food Products','11':'Beverages','12':'Tobacco','13':'Textiles','14':'Wearing Apparel',
  '15':'Leather','16':'Wood Products','17':'Paper Products','18':'Printing','19':'Coke & Petroleum',
  '20':'Chemicals','21':'Pharmaceuticals','22':'Rubber & Plastics','23':'Non-Metallic Minerals',
  '24':'Basic Metals','25':'Fabricated Metals','26':'Electronics','27':'Electrical Equipment',
  '28':'Machinery','29':'Motor Vehicles','30':'Other Transport','31':'Furniture','32':'Other Manufacturing','33':'Repair & Installation',
  '35':'Energy','36':'Water Supply','37':'Sewerage','38':'Waste Management','39':'Remediation',
  '41':'Construction of Buildings','42':'Civil Engineering','43':'Specialised Construction',
  '45':'Motor Trade','46':'Wholesale','47':'Retail',
  '49':'Land Transport','50':'Water Transport','51':'Air Transport','52':'Warehousing','53':'Postal & Courier',
  '55':'Accommodation','56':'Food & Beverage Service',
  '58':'Publishing','59':'Film & TV','60':'Broadcasting','61':'Telecommunications','62':'IT Services','63':'Information Services',
  '64':'Financial Services','65':'Insurance','66':'Financial Auxiliaries',
  '68':'Real Estate',
  '69':'Legal & Accounting','70':'Head Offices & Consultancy','71':'Architecture & Engineering','72':'Scientific R&D','73':'Advertising','74':'Other Professional','75':'Veterinary',
  '77':'Rental & Leasing','78':'Employment Activities','79':'Travel Agencies','80':'Security','81':'Facilities Management','82':'Office Admin',
  '84':'Public Admin & Defence','85':'Education',
  '86':'Human Health','87':'Residential Care','88':'Social Work',
  '90':'Creative Arts','91':'Libraries & Museums','92':'Gambling','93':'Sports & Recreation',
  '94':'Membership Organisations','95':'Repair of Goods','96':'Other Personal Services',
  '97':'Households as Employers','98':'Undifferentiated Goods','99':'Extraterritorial'
};

// NACE Rev.2 section → sector mapping
const NACE_SECTION_MAP = {
  'A':'Agriculture, Forestry & Fishing','B':'Mining & Quarrying','C':'Manufacturing',
  'D':'Energy','E':'Water & Waste','F':'Construction','G':'Wholesale & Retail',
  'H':'Transport & Storage','I':'Accommodation & Food','J':'Information & Communication',
  'K':'Financial & Insurance','L':'Real Estate','M':'Professional & Scientific',
  'N':'Administrative & Support','O':'Public Administration','P':'Education',
  'Q':'Health & Social Work','R':'Arts & Entertainment','S':'Other Services',
  'T':'Households','U':'Extraterritorial'
};

function sicToSector(code) {
  if (!code) return '';
  const s = String(code).replace(/[^0-9]/g, '');
  if (s.length < 2) return '';
  const div = s.substring(0, 2);
  return SIC_DIVISION_MAP[div] || '';
}

function naceToSector(code) {
  if (!code) return '';
  const s = String(code).trim().toUpperCase();
  // NACE codes can start with a letter (section) or be numeric
  if (s.match(/^[A-U]/)) return NACE_SECTION_MAP[s[0]] || '';
  // Numeric NACE codes use same division structure as SIC
  const num = s.replace(/[^0-9]/g, '');
  if (num.length >= 2) return SIC_DIVISION_MAP[num.substring(0, 2)] || '';
  return '';
}

function convertTerm(months, unit) {
  if (unit === 'years') return (months / 12).toFixed(1) + 'yr';
  if (unit === 'days') return Math.round(months * 30.44) + 'd';
  return months.toFixed(0) + 'm';
}

// UK postcode area → region mapping
const POSTCODE_REGION_MAP = {
  'EC':'London','WC':'London','E':'London','N':'London','NW':'London','SE':'London','SW':'London','W':'London',
  'BN':'South East','BR':'South East','CR':'South East','CT':'South East','DA':'South East','GU':'South East',
  'HP':'South East','KT':'South East','ME':'South East','MK':'South East','OX':'South East','PO':'South East',
  'RG':'South East','RH':'South East','SL':'South East','SM':'South East','SO':'South East','SS':'South East',
  'TN':'South East','TW':'South East','UB':'South East',
  'BA':'South West','BH':'South West','BS':'South West','DT':'South West','EX':'South West','GL':'South West',
  'PL':'South West','SN':'South West','SP':'South West','TA':'South West','TQ':'South West','TR':'South West',
  'B':'Midlands','CV':'Midlands','DE':'Midlands','DY':'Midlands','LE':'Midlands','NG':'Midlands',
  'NN':'Midlands','PE':'Midlands','ST':'Midlands','TF':'Midlands','WR':'Midlands','WS':'Midlands','WV':'Midlands',
  'AL':'East of England','CB':'East of England','CM':'East of England','CO':'East of England','EN':'East of England',
  'HA':'East of England','IG':'East of England','IP':'East of England','LU':'East of England','NR':'East of England',
  'RM':'East of England','SG':'East of England','WD':'East of England',
  'BB':'North West','BL':'North West','CA':'North West','CH':'North West','CW':'North West','FY':'North West',
  'L':'North West','LA':'North West','M':'North West','OL':'North West','PR':'North West','SK':'North West',
  'WA':'North West','WN':'North West',
  'DH':'North East','DL':'North East','NE':'North East','SR':'North East','TS':'North East',
  'BD':'Yorkshire & Humber','DN':'Yorkshire & Humber','HD':'Yorkshire & Humber','HG':'Yorkshire & Humber',
  'HU':'Yorkshire & Humber','HX':'Yorkshire & Humber','LN':'Yorkshire & Humber','LS':'Yorkshire & Humber',
  'S':'Yorkshire & Humber','WF':'Yorkshire & Humber','YO':'Yorkshire & Humber',
  'AB':'Scotland','DD':'Scotland','DG':'Scotland','EH':'Scotland','FK':'Scotland','G':'Scotland',
  'HS':'Scotland','IV':'Scotland','KA':'Scotland','KW':'Scotland','KY':'Scotland','ML':'Scotland',
  'PA':'Scotland','PH':'Scotland','TD':'Scotland','ZE':'Scotland',
  'CF':'Wales','LD':'Wales','LL':'Wales','NP':'Wales','SA':'Wales','SY':'Wales',
  'BT':'Northern Ireland'
};

function postcodeToRegion(postcode) {
  if (!postcode) return '';
  const clean = String(postcode).trim().toUpperCase().replace(/\s+/g, '');
  const m = clean.match(/^([A-Z]{1,2})/);
  if (!m) return '';
  // Try 2-letter prefix first, then 1-letter
  if (POSTCODE_REGION_MAP[m[1]]) return POSTCODE_REGION_MAP[m[1]];
  if (m[1].length === 2 && POSTCODE_REGION_MAP[m[1][0]]) return POSTCODE_REGION_MAP[m[1][0]];
  return '';
}

const COLORS = [
  '#003078','#00857c','#4a6fa5','#6d8c70','#8a7d5a',
  '#7a5a6a','#5a7a8a','#6a6a5a','#4a7a7a','#8a6a5a',
  '#5a6a7a','#7a6a4a','#4a5a6a','#6a7a5a','#5a5a7a'
];

// ============================================================
//  NAV
// ============================================================
function updateNav(view) {
  const el = document.getElementById('nav-actions');
  if (view === 'home') {
    el.innerHTML = '';
  } else {
    el.innerHTML = `
      <button class="btn btn-nav btn-sm" onclick="openSettings()">Settings</button>
      <button class="btn btn-nav btn-sm" onclick="addAnotherTape()">+ Add Tape</button>
      <button class="btn btn-nav btn-sm" onclick="exportXLSX()">Export XLSX</button>
      <button class="btn btn-nav btn-sm" onclick="goHome()">Reset</button>
    `;
  }
}
function goHome() {
  tapes = [];
  loans = [];
  activeSeries = 'all';
  customFieldDefs = {};
  document.getElementById('upload-section').style.display = '';
  document.getElementById('dashboard').classList.remove('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('.tab[data-tab="overview"]').classList.add('active');
  document.getElementById('tab-overview').classList.add('active');
  updateNav('home');
}
updateNav('home');

// ============================================================
//  FILE UPLOAD
// ============================================================
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
uploadArea.addEventListener('drop', e => {
  e.preventDefault();
  uploadArea.classList.remove('drag-over');
  if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', e => { if (e.target.files.length) handleFiles(e.target.files); });

let pendingFileQueue = [];
function handleFiles(fileList) {
  pendingFileQueue = Array.from(fileList);
  if (pendingFileQueue.length === 0) return;
  processNextFile();
}

function processNextFile() {
  if (pendingFileQueue.length === 0) return;
  const file = pendingFileQueue.shift();
  handleFile(file);
}

function showLoading(text, sub) {
  document.getElementById('loading-text').textContent = text || 'Loading...';
  document.getElementById('loading-sub').textContent = sub || '';
  document.getElementById('loading-overlay').classList.add('active');
}
function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('active');
}

// Find the actual header row — improved detection for files with title rows,
// filters, merged cells, and decorative rows above the data.
// A good header row has: many non-empty cells, mostly strings (not numbers),
// mostly unique values, and data rows following it.
function findHeaderRow(rows) {
  const limit = Math.min(rows.length, 30);
  let bestIdx = 0, bestScore = -1;
  for (let i = 0; i < limit; i++) {
    const row = rows[i];
    if (!Array.isArray(row)) continue;
    const cells = row.filter(c => c != null && String(c).trim() !== '');
    const count = cells.length;
    if (count < 3) continue; // headers need at least 3 columns
    // Score: prefer rows with many non-empty string cells
    const strings = cells.filter(c => typeof c === 'string' || (typeof c !== 'number' && isNaN(Number(c))));
    const stringRatio = count > 0 ? strings.length / count : 0;
    // Prefer rows where most values are unique (headers are distinct)
    const unique = new Set(cells.map(c => String(c).trim().toLowerCase()));
    const uniqueRatio = count > 0 ? unique.size / count : 0;
    // Check that the next row exists and has data (confirming this is really a header)
    let hasDataBelow = false;
    for (let j = i + 1; j < Math.min(i + 4, rows.length); j++) {
      const nextRow = rows[j];
      if (Array.isArray(nextRow)) {
        const nextCells = nextRow.filter(c => c != null && String(c).trim() !== '');
        if (nextCells.length >= count * 0.5) { hasDataBelow = true; break; }
      }
    }
    if (!hasDataBelow) continue;
    // Score: count * string_ratio * unique_ratio (favour many unique string headers with data below)
    const score = count * (0.3 + 0.4 * stringRatio + 0.3 * uniqueRatio);
    if (score > bestScore) { bestScore = score; bestIdx = i; }
  }
  return bestIdx;
}

// Convert raw array-of-arrays into array-of-objects using the detected header row.
function rowsToObjects(rows, headerIdx) {
  const headerRow = rows[headerIdx];
  if (!Array.isArray(headerRow) || headerRow.length === 0) return [];
  const headers = headerRow.map(h => h != null ? String(h).trim() : '');
  const data = [];
  for (let i = headerIdx + 1; i < rows.length; i++) {
    const row = rows[i];
    if (!Array.isArray(row)) continue;
    if (row.every(c => c == null || String(c).trim() === '')) continue;
    const obj = {};
    headers.forEach((h, ci) => { if (h) obj[h] = ci < row.length && row[ci] != null ? row[ci] : ''; });
    data.push(obj);
  }
  return data;
}

function processRawRows(rows) {
  if (!rows || rows.length === 0) { alert('File appears to be empty.'); return; }
  const headerIdx = findHeaderRow(rows);
  const data = rowsToObjects(rows, headerIdx);
  if (data.length === 0) { alert('No data rows found below the detected header (row ' + (headerIdx + 1) + ').'); return; }
  showMappingModal(data);
}

function handleFile(file) {
  currentTapeName = file.name;
  const ext = file.name.split('.').pop().toLowerCase();
  const remaining = pendingFileQueue.length;
  const queueLabel = remaining > 0 ? ` (${remaining} more queued)` : '';
  showLoading('Reading ' + file.name + '...', 'Parsing data' + queueLabel);
  if (ext === 'csv') {
    Papa.parse(file, { header: false, skipEmptyLines: true,
      complete: r => { try { hideLoading(); processRawRows(r.data); } catch (err) { hideLoading(); alert('CSV parse error: ' + err.message); } },
      error: err => { hideLoading(); alert('Could not read CSV: ' + err.message); }
    });
  } else if (ext === 'xlsx' || ext === 'xls') {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        hideLoading();
        processRawRows(rows);
      } catch (err) { hideLoading(); alert('Excel parse error: ' + err.message); }
    };
    reader.onerror = () => { hideLoading(); alert('Could not read file.'); };
    reader.readAsArrayBuffer(file);
  } else {
    hideLoading();
    alert('Unsupported file type: .' + ext + '. Please use .csv, .xlsx, or .xls');
  }
}

// ============================================================
//  TEMPLATE FIELDS — core + lease tape extensions
// ============================================================
const TEMPLATE_FIELDS = [
  // Core (required)
  { key: 'loan_id',             label: 'Lease / Loan ID',     required: true,  type: 'string' },
  { key: 'borrower_name',       label: 'Lessee / Borrower',   required: true,  type: 'string' },
  { key: 'loan_amount',         label: 'Original Balance',    required: true,  type: 'number' },
  { key: 'outstanding_balance', label: 'Current Outstanding', required: true,  type: 'number' },
  // Core (optional)
  { key: 'sector',              label: 'Sector / SIC',        required: false, type: 'string' },
  { key: 'sic_code',            label: 'SIC Code',            required: false, type: 'string' },
  { key: 'nace_code',           label: 'NACE Code',           required: false, type: 'string' },
  { key: 'region',              label: 'Region',              required: false, type: 'string' },
  { key: 'maturity_date',       label: 'Maturity Date',       required: false, type: 'string' },
  { key: 'interest_rate',       label: 'Margin / Coupon',     required: false, type: 'number' },
  { key: 'credit_rating',       label: 'Credit Rating',       required: false, type: 'string' },
  { key: 'facility_type',       label: 'Facility Type',       required: false, type: 'string' },
  { key: 'default_flag',        label: 'Default Flag',        required: false, type: 'boolean' },
  { key: 'loan_status',         label: 'Status',              required: false, type: 'string' },
  { key: 'arrears_status',      label: 'Arrears Status',      required: false, type: 'string' },
  // Lease tape extensions
  { key: 'origination_date',    label: 'Origination Date',    required: false, type: 'string' },
  { key: 'original_term',       label: 'Original Term (m)',   required: false, type: 'number' },
  { key: 'remaining_term',      label: 'Remaining Term (m)',  required: false, type: 'number' },
  { key: 'currency',            label: 'Currency',            required: false, type: 'string' },
  { key: 'repayment_method',    label: 'Repayment Method',    required: false, type: 'string' },
  { key: 'amortisation_type',   label: 'Amortisation Type',   required: false, type: 'string' },
  { key: 'payment_frequency',   label: 'Payment Frequency',   required: false, type: 'string' },
  { key: 'interest_rate_type',  label: 'Interest Rate Type',  required: false, type: 'string' },
  { key: 'days_in_arrears',     label: 'Days in Arrears',     required: false, type: 'number' },
  { key: 'equipment_type',      label: 'Equipment Type',      required: false, type: 'string' },
  { key: 'asset_category',      label: 'Asset Category',      required: false, type: 'string' },
  { key: 'asset_type',          label: 'Asset Type',          required: false, type: 'string' },
  { key: 'supplier',            label: 'Supplier / Vendor',   required: false, type: 'string' },
  { key: 'deposit_amount',      label: 'Deposit Amount',      required: false, type: 'number' },
  { key: 'deposit_pct',         label: 'Deposit %',           required: false, type: 'number' },
  { key: 'vat_deferral',        label: 'VAT Deferral',        required: false, type: 'string' },
  { key: 'customer_segment',    label: 'Customer Segment',    required: false, type: 'string' },
  { key: 'origination_channel', label: 'Origination Channel', required: false, type: 'string' },
  { key: 'balloon_pct',         label: 'Balloon %',           required: false, type: 'number' },
  { key: 'postcode',            label: 'Postcode',            required: false, type: 'string' },
  { key: 'bbb_guarantee',       label: 'BBB Guarantee',       required: false, type: 'string' },
  { key: 'broker',              label: 'Broker',              required: false, type: 'string' },
  { key: 'originator',          label: 'Originator',          required: false, type: 'string' },
  { key: 'lessee_type',         label: 'Lessee Type',         required: false, type: 'string' }
];

const FIELD_ALIASES = {
  loan_id:             ['loan_id','loanid','loan id','loan #','loan_number','loannumber','loan number','id','loan_ref','loanref','deal_id','dealid','asset_id','assetid','facility_id','facilityid','reference','ref','facility_ref','facilityref','lease_identifier','leaseidentifier','lease identifier','lease_id','leaseid','lease id','lease_ref','leaseref','receivable_id'],
  borrower_name:       ['borrower_name','borrowername','borrower name','borrower','obligor','obligor_name','obligorname','counterparty','counterparty_name','client','client_name','company','company_name','entity','entity_name','name','customer','customer_name','lessee','lessee_name','lessee_identifier','lesseeidentifier','lessee identifier','group_company_identifier','group company identifier'],
  sector:              ['sector','industry','industry_sector','industrysector','segment','business_sector','industry_classification','industry_description','sector_description'],
  sic_code:            ['sic_code','siccode','sic code','sic','sic_industry_code','sicindustrycode','sic industry code','sic_number','standard_industrial_classification','sic_division','uk_sic','uk sic'],
  nace_code:           ['nace_code','nacecode','nace code','nace','nace_rev2','nace_classification','nace_section','eu_nace','nace_industry'],
  region:              ['region','geography','country','location','geo','market','territory','jurisdiction','domicile','country_of_risk','area','uk_region','ukregion','uk region','asset_location','assetlocation','asset location'],
  loan_amount:         ['loan_amount','loanamount','loan amount','original_amount','originalamount','original amount','commitment','facility_amount','facilityamount','notional','principal','face_value','facevalue','committed_amount','committedamount','deal_size','dealsize','size','facility_size','facilitysize','limit','facility_limit','original_principal_balance','originalprincipalbalance','original principal balance','original_balance','originalbalance','advance','advance_amount','advanceamount','advance amount','original_advance','originaladvance','original advance','total_advance','totaladvance'],
  outstanding_balance: ['outstanding_balance','outstandingbalance','outstanding balance','outstanding','current_balance','currentbalance','current balance','drawn','drawn_amount','drawnamount','exposure','current_exposure','net_exposure','balance','current_drawn','currentdrawn','utilised','utilised_amount','current_prin_outstanding_bal','currentprinoutstandingbal','current prin outstanding bal','current_principal','currentprincipal','current_principal_outstanding','currentprincipaloutstanding','current principal outstanding','principal_outstanding','principaloutstanding','current_outstanding','currentoutstanding'],
  maturity_date:       ['maturity_date','maturitydate','maturity date','maturity','mat_date','matdate','final_maturity','finalmaturity','end_date','enddate','expiry','expiry_date','expirydate','termination_date','repayment_date'],
  interest_rate:       ['interest_rate','interestrate','interest rate','rate','coupon','spread','margin','yield','all_in_rate','allinrate','coupon_rate','couponrate','rate_pct','pricing','current_rate','margin_coupon','margincoupon','margin / coupon','margin/coupon'],
  credit_rating:       ['credit_rating','creditrating','credit rating','rating','internal_rating','internalrating','external_rating','externalrating','risk_rating','riskrating','grade','risk_grade','credit_grade','pd_grade'],
  facility_type:       ['facility_type','facilitytype','facility type','type','loan_type','loantype','loan type','product','product_type','producttype','instrument','instrument_type','tranche','deal_type','type_of_lease','typeoflease','type of lease','lease_type','leasetype'],
  default_flag:        ['default_flag','defaultflag','default flag','default','defaulted','is_default','isdefault','in_default','npl','non_performing','nonperforming','workout','impaired','npl_flag','nplflag'],
  loan_status:         ['loan_status','loanstatus','loan status','status','account_status','accountstatus','account status','facility_status','facilitystatus','performing_status','performingstatus','performing status','contract_status','contractstatus'],
  arrears_status:      ['arrears_status','arrearsstatus','arrears status','arrears_band','arrearsband','arrears band','arrears_category','collection_status','collectionstatus','delinquency_status','delinquencystatus'],
  origination_date:    ['origination_date','originationdate','origination date','lease_origination_date','leaseoriginationdate','lease origination date','start_date','startdate','start date','drawdown_date','inception_date','commencement_date','orig_date'],
  original_term:       ['original_term','originalterm','original term','orig_term','origterm','original_term_months','term_months','contractual_term','initial_term','lease_term','orig_term_months'],
  remaining_term:      ['remaining_term','remainingterm','remaining term','rem_term','remterm','remaining_term_months','residual_term','rem_term_months','months_remaining','time_to_maturity'],
  currency:            ['currency','ccy','curr','iso_currency','currency_code','currencycode','denomination'],
  repayment_method:    ['repayment_method','repaymentmethod','repayment method','repayment_type','repaymenttype','repay_method'],
  amortisation_type:   ['amortisation_type','amortisationtype','amortisation type','amortization_type','amortizationtype','amort_type','amorttype','amortisation','amortization','amort_profile'],
  payment_frequency:   ['payment_frequency','paymentfrequency','payment frequency','pay_frequency','payfrequency','pay_freq','frequency','installment_frequency'],
  interest_rate_type:  ['interest_rate_type','interestratetype','interest rate type','rate_type','ratetype','rate type','fixed_floating','fixedfloating','fixed_or_floating','interest_type','interesttype','interest_rate_basis','interestratebasis','interest rate basis'],
  days_in_arrears:     ['days_in_arrears','daysinarrears','days in arrears','arrears_days','arrearsdays','dpd','days_past_due','dayspastdue','number_of_days_in_arrears','numberofdaysinarrears','number of days in arrears','days_in_arrear','arrears_amount_days','no_of_days_in_arrears','noofdaysinarrears'],
  equipment_type:      ['equipment_type','equipmenttype','equipment type','equipment','equipment_description','equipmentdescription','equipment_class','make_model','makemodel'],
  asset_category:      ['asset_category','assetcategory','asset category','asset_class','assetclass','asset class','collateral_category','collateralcategory'],
  asset_type:          ['asset_type','assettype','asset type','collateral_type','collateraltype','asset_description','assetdescription'],
  supplier:            ['supplier','supplier_name','suppliername','vendor','vendor_name','vendorname','dealer','dealer_name','dealername','introducer','manufacturer'],
  deposit_amount:      ['deposit_amount','depositamount','deposit amount','deposit','advance_payment','advancepayment','advance payment','upfront_payment','initial_payment'],
  deposit_pct:         ['deposit_pct','depositpct','deposit_percentage','depositpercentage','deposit percentage','deposit_percent','deposit_%','advance_pct'],
  vat_deferral:        ['vat_deferral','vatdeferral','vat deferral','vat_deferred','vatdeferred','vat deferred','vat_treatment','vattreatment','vat treatment','vat_status','vatstatus'],
  customer_segment:    ['customer_segment','customersegment','customer segment','cust_segment','client_segment'],
  origination_channel: ['origination_channel','originationchannel','origination channel','channel','source','distribution_channel','sales_channel','origination_source','orig_channel'],
  balloon_pct:         ['balloon_pct','balloonpct','balloon_percentage','balloonpercentage','balloon percentage','balloon','residual_value_pct','residual_pct','rv_pct','balloon_pct_of_original','balloon_percent'],
  postcode:            ['postcode','post_code','post code','zip','zip_code','zipcode','postal_code','postalcode','postal code'],
  bbb_guarantee:       ['bbb_guarantee','bbbguarantee','bbb guarantee','bbb_program','bbbprogram','bbb program','guarantee_scheme','guaranteescheme','guarantee scheme','ggs','rls','government_guarantee','govguarantee','bbb_scheme','bbb scheme','guarantee_program','guarantee program','recovery_loan_scheme','growth_guarantee_scheme'],
  broker:              ['broker','broker_name','brokername','broker name','intermediary','intermediary_name','introducing_broker','introducingbroker','ib','broker_firm','brokerfirm'],
  originator:          ['originator','originator_name','originatorname','originator name','lending_entity','lendingentity','lending entity','originating_entity','originatingentity','originating entity','lender','lender_name','lending_institution'],
  lessee_type:         ['lessee_type','lesseetype','lessee type','lessee_entity_type','lesseeentitytype','borrower_type','borrowertype','borrower type','entity_type','entitytype','entity type','legal_form','legalform','legal form','company_type','companytype','company type','obligor_type','obligortype','obligor type','legal_entity_type','legalentitytype','customer_type','customertype']
};

// ============================================================
//  FUZZY COLUMN MATCHING
// ============================================================
function normalizeStr(s) { return String(s).toLowerCase().replace(/[^a-z0-9]/g, ''); }

function autoMatchColumn(colName) {
  const norm = normalizeStr(colName);
  if (!norm) return '';

  // Pass 1: Exact match (highest priority)
  for (const [field, aliases] of Object.entries(FIELD_ALIASES)) {
    for (const alias of aliases) {
      if (normalizeStr(alias) === norm) return field;
    }
  }

  // Pass 2: Fuzzy substring match — require the alias to cover a significant
  // portion of the column name to avoid false positives like
  // "currentinternalriskcategory" matching "currency"
  let bestField = '';
  let bestScore = 0;
  for (const [field, aliases] of Object.entries(FIELD_ALIASES)) {
    for (const alias of aliases) {
      const normAlias = normalizeStr(alias);
      if (normAlias.length < 4) continue; // skip very short aliases for substring matching
      // Check if column contains alias or alias contains column
      const colContainsAlias = norm.includes(normAlias);
      const aliasContainsCol = normAlias.includes(norm);
      if (!colContainsAlias && !aliasContainsCol) continue;
      // Score by how much of the column name the alias covers
      // Higher coverage = better match
      const coverage = colContainsAlias
        ? normAlias.length / norm.length
        : norm.length / normAlias.length;
      // Require at least 50% coverage to avoid spurious matches
      if (coverage < 0.5) continue;
      // Prefer longer alias matches and higher coverage
      const score = normAlias.length * coverage;
      if (score > bestScore) {
        bestScore = score;
        bestField = field;
      }
    }
  }
  return bestField;
}

// ============================================================
//  MAPPING MODAL
// ============================================================
function showMappingModal(rawData) {
  pendingRawData = rawData;
  if (!rawData.length) return;
  const sourceColumns = Object.keys(rawData[0]);
  document.getElementById('mapping-col-count').textContent = sourceColumns.length;

  columnMapping = {};
  const autoMatched = {};
  sourceColumns.forEach(col => {
    // First check if we've seen this column name before (mapping memory)
    const normCol = col.toLowerCase().trim();
    const remembered = columnMappingMemory[normCol];
    if (remembered && !Object.values(autoMatched).includes(remembered)) {
      autoMatched[col] = remembered;
      columnMapping[col] = remembered;
      return;
    }
    const match = autoMatchColumn(col);
    if (match && !Object.values(autoMatched).includes(match)) {
      autoMatched[col] = match;
      columnMapping[col] = match;
    }
  });

  renderMappingRows(sourceColumns, autoMatched);
  updateMappingStatus();
  // Reset cut-off date input for new upload
  const cutoffInput = document.getElementById('mapping-cutoff-date');
  if (cutoffInput) cutoffInput.value = '';
  document.getElementById('mapping-overlay').classList.add('active');
}

function renderMappingRows(sourceColumns, autoMatched) {
  if (!sourceColumns) {
    sourceColumns = pendingRawData ? Object.keys(pendingRawData[0]) : [];
    autoMatched = autoMatched || {};
  }
  const body = document.getElementById('mapping-body');
  body.innerHTML = '';
  const headerRow = document.createElement('div');
  headerRow.className = 'mapping-row-header';
  headerRow.innerHTML = '<span>Source Column</span><span></span><span>Maps To</span>';
  body.appendChild(headerRow);

  // Build the full options list: predefined + any previously defined custom fields
  const allOptions = [...TEMPLATE_FIELDS];
  Object.values(customFieldDefs).forEach(cf => {
    if (!allOptions.find(f => f.key === cf.key)) {
      allOptions.push({ key: cf.key, label: cf.label, required: false, type: cf.type === 'numeric' ? 'number' : 'string' });
    }
  });

  // Build set of fields already in use (mapped by another column)
  const fieldsInUse = {};
  for (const [src, tgt] of Object.entries(columnMapping)) {
    if (tgt && !tgt.startsWith('__custom:')) fieldsInUse[tgt] = src;
  }

  sourceColumns.forEach(col => {
    const wrapper = document.createElement('div');
    const isAuto = autoMatched && !!autoMatched[col];
    const samples = pendingRawData ? pendingRawData.slice(0, 10).map(r => r[col]).filter(v => v != null && v !== '').slice(0, 3) : [];
    const sampleText = samples.length ? samples.join(', ') : '(empty)';
    const currentVal = columnMapping[col] || '';
    const isCustom = currentVal.startsWith('__custom:');

    const row = document.createElement('div');
    row.className = 'mapping-row';
    row.innerHTML = `
      <div class="mapping-col-name">
        ${escapeHtml(col)}${isAuto ? '<span class="mapping-badge auto">auto</span>' : ''}
        <span class="sample">${escapeHtml(sampleText)}</span>
      </div>
      <div class="mapping-arrow">&rarr;</div>
      <select class="mapping-select ${currentVal && !isCustom ? 'mapped' : ''} ${isCustom ? 'mapped' : ''}" data-source="${escapeHtml(col)}" onchange="onMappingChange(this)">
        <option value="">-- skip --</option>
        ${allOptions.map(f => {
          const inUse = fieldsInUse[f.key] && fieldsInUse[f.key] !== col;
          const usedLabel = inUse ? ' (in use)' : '';
          return `<option value="${f.key}" ${currentVal === f.key ? 'selected' : ''} ${inUse ? 'class="option-in-use"' : ''}>${f.label}${f.required ? ' *' : ''}${usedLabel}</option>`;
        }).join('')}
        <option value="__custom_new" ${isCustom ? 'selected' : ''}>+ Custom Field...</option>
      </select>
    `;
    wrapper.appendChild(row);

    // If this column is mapped to a custom field, show the inline config
    if (isCustom) {
      const cfKey = currentVal.replace('__custom:', '');
      const cfDef = customFieldDefs[cfKey] || { key: cfKey, label: col, type: 'categorical', options: [], bands: [] };
      wrapper.appendChild(buildCustomFieldConfig(col, cfDef));
    }

    body.appendChild(wrapper);
  });
}

function buildCustomFieldConfig(sourceCol, cfDef) {
  const div = document.createElement('div');
  div.className = 'custom-field-config';
  div.setAttribute('data-source', sourceCol);

  // Auto-detect unique values from data for this column
  const uniqueVals = pendingRawData ? [...new Set(pendingRawData.slice(0, 500).map(r => r[sourceCol]).filter(v => v != null && String(v).trim() !== ''))].slice(0, 50) : [];
  const allNumeric = uniqueVals.length > 0 && uniqueVals.every(v => !isNaN(parseFloat(String(v).replace(/[\u00a3,$%]/g, ''))));
  const suggestedType = allNumeric ? 'numeric' : 'categorical';

  // If this is a brand-new custom field, pre-fill type from data
  if (!cfDef.type || (cfDef.options.length === 0 && cfDef.bands.length === 0)) {
    cfDef.type = suggestedType;
    if (suggestedType === 'categorical') cfDef.options = uniqueVals.map(v => String(v)).slice(0, 30);
  }

  const safeSrc = sourceCol.replace(/'/g, "\\'");

  // Row 1: Label + Type
  let html = `<div class="cf-row">
    <label>Label</label>
    <input type="text" class="cf-label-input" value="${escapeHtml(cfDef.label)}" onchange="updateCustomFieldLabel('${safeSrc}', this.value)" placeholder="Display name">
    <label style="min-width:40px;margin-left:8px;">Type</label>
    <select onchange="updateCustomFieldType('${safeSrc}', this.value)">
      <option value="categorical" ${cfDef.type === 'categorical' ? 'selected' : ''}>Categorical</option>
      <option value="numeric" ${cfDef.type === 'numeric' ? 'selected' : ''}>Numeric (banded)</option>
      <option value="text" ${cfDef.type === 'text' ? 'selected' : ''}>Text (no strat)</option>
      <option value="date" ${cfDef.type === 'date' ? 'selected' : ''}>Date</option>
    </select>
  </div>`;

  // Row 2: Type-specific config
  if (cfDef.type === 'categorical') {
    const optTags = (cfDef.options || []).map((o, i) =>
      `<span class="cf-option-tag">${escapeHtml(o)}<button class="cf-band-del" onclick="removeCustomFieldOption('${safeSrc}',${i})">&times;</button></span>`
    ).join('');
    html += `<div class="cf-row" style="flex-wrap:wrap;">
      <label>Options</label>
      <div class="cf-options-tags">${optTags}</div>
    </div>
    <div class="cf-row">
      <label></label>
      <input type="text" placeholder="Add option..." onkeydown="if(event.key==='Enter'){addCustomFieldOption('${safeSrc}',this.value);this.value='';}" style="flex:1;">
      <span class="cf-hint">Press Enter to add. These drive stratification tables.</span>
    </div>`;
    if (uniqueVals.length > 0 && (cfDef.options || []).length === 0) {
      html += `<div class="cf-row"><label></label><button class="btn btn-outline btn-sm" onclick="autoFillCustomFieldOptions('${safeSrc}')">Auto-detect ${uniqueVals.length} options from data</button></div>`;
    }
  } else if (cfDef.type === 'numeric') {
    const bandTags = (cfDef.bands || []).map((b, i) =>
      `<span class="cf-band-tag">${escapeHtml(b.label)}<button class="cf-band-del" onclick="removeCustomFieldBand('${safeSrc}',${i})">&times;</button></span>`
    ).join('');
    html += `<div class="cf-row" style="flex-wrap:wrap;">
      <label>Bands</label>
      <div class="cf-bands-list">${bandTags || '<span class="cf-hint">No bands defined. Add bands or use auto-detect.</span>'}</div>
    </div>
    <div class="cf-row">
      <label></label>
      <input type="text" placeholder="Label (e.g. 0-25k)" id="cf-band-label-${safeSrc}" style="width:100px;">
      <input type="number" placeholder="Min" id="cf-band-min-${safeSrc}" style="width:80px;">
      <input type="number" placeholder="Max" id="cf-band-max-${safeSrc}" style="width:80px;">
      <button class="btn btn-outline btn-sm" onclick="addCustomFieldBand('${safeSrc}')">Add</button>
    </div>`;
    if (allNumeric && uniqueVals.length > 0) {
      html += `<div class="cf-row"><label></label><button class="btn btn-outline btn-sm" onclick="autoDetectCustomFieldBands('${safeSrc}')">Auto-detect bands from data</button></div>`;
    }
  } else if (cfDef.type === 'date') {
    html += `<div class="cf-row"><label></label><span class="cf-hint">Date fields will be auto-parsed and stratified by year.</span></div>`;
  } else {
    html += `<div class="cf-row"><label></label><span class="cf-hint">Text fields are included in the data table and export but not stratified.</span></div>`;
  }

  div.innerHTML = html;
  return div;
}

function onMappingChange(select) {
  const sourceCol = select.getAttribute('data-source');
  const newVal = select.value;

  // Handle "Custom Field" selection
  if (newVal === '__custom_new') {
    const safeKey = 'cf_' + sourceCol.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 30);
    if (!customFieldDefs[safeKey]) {
      customFieldDefs[safeKey] = { key: safeKey, label: sourceCol, type: 'categorical', options: [], bands: [] };
    }
    columnMapping[sourceCol] = '__custom:' + safeKey;
    select.classList.add('mapped');
    // Re-render to show config panel
    renderMappingRows();
    updateMappingStatus();
    return;
  }

  // Remove old custom mapping if changing away from custom
  const oldVal = columnMapping[sourceCol];
  if (oldVal && oldVal.startsWith('__custom:')) {
    const oldKey = oldVal.replace('__custom:', '');
    // Don't delete the def — user might reuse it
  }

  if (newVal && !newVal.startsWith('__custom')) {
    // De-duplicate: clear any other column mapped to same field
    document.querySelectorAll('.mapping-select').forEach(s => {
      if (s !== select && s.value === newVal) {
        s.value = '';
        s.classList.remove('mapped');
        delete columnMapping[s.getAttribute('data-source')];
      }
    });
  }
  if (newVal) { columnMapping[sourceCol] = newVal; select.classList.add('mapped'); }
  else {
    delete columnMapping[sourceCol];
    select.classList.remove('mapped');
  }
  // Re-render to update in-use labels and custom config panels
  renderMappingRows();
  updateMappingStatus();
}

// --- Custom field config helpers ---
function getCustomFieldDefForSource(sourceCol) {
  const mapping = columnMapping[sourceCol];
  if (!mapping || !mapping.startsWith('__custom:')) return null;
  const key = mapping.replace('__custom:', '');
  return customFieldDefs[key] || null;
}

function updateCustomFieldLabel(sourceCol, label) {
  const def = getCustomFieldDefForSource(sourceCol);
  if (def) def.label = label.trim() || sourceCol;
}

function updateCustomFieldType(sourceCol, type) {
  const def = getCustomFieldDefForSource(sourceCol);
  if (def) {
    def.type = type;
    renderMappingRows();
    updateMappingStatus();
  }
}

function addCustomFieldOption(sourceCol, val) {
  if (!val || !val.trim()) return;
  const def = getCustomFieldDefForSource(sourceCol);
  if (def) {
    if (!def.options) def.options = [];
    const trimmed = val.trim();
    if (!def.options.includes(trimmed)) def.options.push(trimmed);
    renderMappingRows();
  }
}

function removeCustomFieldOption(sourceCol, idx) {
  const def = getCustomFieldDefForSource(sourceCol);
  if (def && def.options) { def.options.splice(idx, 1); renderMappingRows(); }
}

function autoFillCustomFieldOptions(sourceCol) {
  const def = getCustomFieldDefForSource(sourceCol);
  if (!def || !pendingRawData) return;
  const uniqueVals = [...new Set(pendingRawData.map(r => r[sourceCol]).filter(v => v != null && String(v).trim() !== ''))].map(v => String(v)).slice(0, 50);
  def.options = uniqueVals;
  renderMappingRows();
}

function addCustomFieldBand(sourceCol) {
  const def = getCustomFieldDefForSource(sourceCol);
  if (!def) return;
  const safeSrc = sourceCol.replace(/'/g, "\\'");
  const label = document.getElementById('cf-band-label-' + safeSrc);
  const minEl = document.getElementById('cf-band-min-' + safeSrc);
  const maxEl = document.getElementById('cf-band-max-' + safeSrc);
  if (!label || !label.value.trim()) return;
  if (!def.bands) def.bands = [];
  def.bands.push({ label: label.value.trim(), min: parseFloat(minEl.value) || -Infinity, max: parseFloat(maxEl.value) || Infinity });
  renderMappingRows();
}

function removeCustomFieldBand(sourceCol, idx) {
  const def = getCustomFieldDefForSource(sourceCol);
  if (def && def.bands) { def.bands.splice(idx, 1); renderMappingRows(); }
}

function autoDetectCustomFieldBands(sourceCol) {
  const def = getCustomFieldDefForSource(sourceCol);
  if (!def || !pendingRawData) return;
  const vals = pendingRawData.map(r => parseFloat(String(r[sourceCol]).replace(/[\u00a3,$%]/g, ''))).filter(v => !isNaN(v));
  if (vals.length === 0) return;
  const min = Math.min(...vals);
  const max = Math.max(...vals);
  const range = max - min;
  // Create ~5-6 evenly spaced bands
  const step = range > 0 ? range / 5 : 1;
  def.bands = [];
  for (let i = 0; i < 5; i++) {
    const lo = Math.round(min + step * i);
    const hi = Math.round(min + step * (i + 1));
    const label = i === 4 ? lo + '+' : lo + '-' + hi;
    def.bands.push({ label, min: lo, max: i === 4 ? Infinity : hi });
  }
  renderMappingRows();
}

function updateMappingStatus() {
  const mapped = Object.values(columnMapping);
  const mappedCount = mapped.filter(v => v && v !== '').length;
  const total = TEMPLATE_FIELDS.length;
  const customCount = mapped.filter(v => v && v.startsWith('__custom:')).length;
  const requiredFields = TEMPLATE_FIELDS.filter(f => f.required);
  const missingRequired = requiredFields.filter(f => !mapped.includes(f.key));
  const statusEl = document.getElementById('mapping-status');
  const confirmBtn = document.getElementById('mapping-confirm-btn');
  const customLabel = customCount > 0 ? ` + ${customCount} custom` : '';
  if (missingRequired.length > 0) {
    statusEl.innerHTML = `<span class="count">${mappedCount - customCount}/${total}</span> mapped${customLabel} &middot; <span class="warn">Required: ${missingRequired.map(f => f.label).join(', ')}</span>`;
    confirmBtn.style.opacity = '0.4';
    confirmBtn.disabled = true;
  } else {
    statusEl.innerHTML = `<span class="count">${mappedCount - customCount}/${total}</span> mapped${customLabel} &middot; Ready`;
    confirmBtn.style.opacity = '1';
    confirmBtn.disabled = false;
  }
}

function cancelMapping() {
  document.getElementById('mapping-overlay').classList.remove('active');
  pendingRawData = null;
  columnMapping = {};
  // Process next file in queue if multi-file upload
  if (pendingFileQueue.length > 0) {
    setTimeout(() => processNextFile(), 300);
  }
}

function confirmMapping() {
  if (!pendingRawData) return;
  const reverseMap = {};
  const customReverseMap = {}; // cfKey -> sourceCol
  for (const [source, target] of Object.entries(columnMapping)) {
    if (target.startsWith('__custom:')) {
      const cfKey = target.replace('__custom:', '');
      customReverseMap[cfKey] = source;
    } else {
      reverseMap[target] = source;
    }
  }
  // Register any new custom fields into TEMPLATE_FIELDS so strats/exports pick them up
  Object.entries(customReverseMap).forEach(([cfKey, srcCol]) => {
    const cfDef = customFieldDefs[cfKey];
    if (cfDef && !TEMPLATE_FIELDS.find(f => f.key === cfKey)) {
      TEMPLATE_FIELDS.push({ key: cfKey, label: cfDef.label, required: false, type: cfDef.type === 'numeric' ? 'number' : 'string' });
    }
    if (cfDef && !FIELD_ALIASES[cfKey]) {
      FIELD_ALIASES[cfKey] = [cfKey, cfKey.replace(/_/g, ''), cfKey.replace(/_/g, ' ')];
    }
    // If categorical, add to fieldOptions for the strat editor
    if (cfDef && cfDef.type === 'categorical' && cfDef.options && cfDef.options.length > 0 && !fieldOptions[cfKey]) {
      fieldOptions[cfKey] = [...cfDef.options];
    }
  });
  // Save column mappings to memory for future tapes
  for (const [source, target] of Object.entries(columnMapping)) {
    if (target && !target.startsWith('__custom')) {
      columnMappingMemory[source.toLowerCase().trim()] = target;
    }
  }

  const mappedLoans = applyMapping(pendingRawData, reverseMap, customReverseMap);
  document.getElementById('mapping-overlay').classList.remove('active');

  // Prompt for series name and originator
  const defaultName = 'Series ' + (tapes.length + 1);
  const seriesName = prompt('Enter a name/series label for this tape:', defaultName);
  const series = (seriesName && seriesName.trim()) ? seriesName.trim() : defaultName;

  const defaultOriginator = mappedLoans.length > 0 && mappedLoans[0].originator ? mappedLoans[0].originator : '';
  const originatorName = prompt('Originator for this tape (leave blank if N/A):', defaultOriginator);
  const tapeOriginator = (originatorName && originatorName.trim()) ? originatorName.trim() : '';

  const cutoffInput = document.getElementById('mapping-cutoff-date');
  const cutoffDate = cutoffInput ? cutoffInput.value : '';

  tapes.push({
    name: currentTapeName || series,
    series: series,
    loans: mappedLoans,
    sourceColumnNames: { ...sourceColumnNames },
    columnMapping: { ...columnMapping },
    cutoffDate: cutoffDate,
    originator: tapeOriginator,
    _rawData: pendingRawData,
    _reverseMap: { ...reverseMap },
    _customReverseMap: { ...customReverseMap }
  });

  // Show value mapping step if there are existing tapes (for cross-tape harmonisation)
  if (tapes.length > 1) {
    const newTapeIdx = tapes.length - 1;
    showValueMappingPrompt(newTapeIdx);
  }

  pendingRawData = null;
  loans = [];
  tapes.forEach(t => loans.push(...t.loans));
  renderDashboard();
  // Process next file in queue if multi-file upload
  if (pendingFileQueue.length > 0) {
    setTimeout(() => processNextFile(), 300);
  }
}

// Store the original source column names for CSV export
let sourceColumnNames = {};

// Normalise region names for cross-tape comparison
const REGION_ALIASES = {
  'london': 'London', 'greater london': 'London', 'inner london': 'London', 'outer london': 'London',
  'south east': 'South East', 'southeast': 'South East', 'south-east': 'South East', 'se england': 'South East',
  'south west': 'South West', 'southwest': 'South West', 'south-west': 'South West', 'sw england': 'South West',
  'north west': 'North West', 'northwest': 'North West', 'north-west': 'North West', 'nw england': 'North West',
  'north east': 'North East', 'northeast': 'North East', 'north-east': 'North East', 'ne england': 'North East',
  'east of england': 'East of England', 'east anglia': 'East of England', 'eastern': 'East of England', 'east england': 'East of England',
  'west midlands': 'Midlands', 'east midlands': 'Midlands', 'midlands': 'Midlands',
  'yorkshire': 'Yorkshire & Humber', 'yorkshire and humber': 'Yorkshire & Humber', 'yorkshire & humber': 'Yorkshire & Humber',
  'yorkshire and the humber': 'Yorkshire & Humber', 'yorkshire & the humber': 'Yorkshire & Humber', 'yorks & humber': 'Yorkshire & Humber',
  'humberside': 'Yorkshire & Humber',
  'scotland': 'Scotland', 'wales': 'Wales', 'northern ireland': 'Northern Ireland', 'ni': 'Northern Ireland',
  'channel islands': 'Channel Islands', 'isle of man': 'Isle of Man'
};

function normaliseRegion(region) {
  if (!region) return '';
  const trimmed = String(region).trim();
  if (!trimmed) return '';
  const lower = trimmed.toLowerCase();
  return REGION_ALIASES[lower] || trimmed;
}

function applyMapping(data, rm, customRm) {
  // Remember which source column maps to which internal field
  sourceColumnNames = {};
  for (const [field, source] of Object.entries(rm)) sourceColumnNames[field] = source;
  if (customRm) {
    for (const [cfKey, source] of Object.entries(customRm)) sourceColumnNames[cfKey] = source;
  }

  // Smart interest rate detection: scan sample to determine if rates are decimals (0.05 = 5%) or percentages (5 = 5%)
  let rateMultiplier = 1;
  if (rm.interest_rate) {
    const sampleRates = data.slice(0, Math.min(200, data.length))
      .map(r => parseNum(r[rm.interest_rate]))
      .filter(v => v > 0);
    if (sampleRates.length > 0) {
      if (displaySettings.rateFormat === 'decimal') {
        rateMultiplier = 100;
      } else if (displaySettings.rateFormat === 'percentage') {
        rateMultiplier = 1;
      } else {
        // Auto-detect: if >80% of non-zero rates are < 1, they're likely decimals
        const belowOne = sampleRates.filter(r => r < 1).length;
        if (belowOne / sampleRates.length > 0.8) rateMultiplier = 100;
      }
    }
  }

  // Same detection for deposit_pct and balloon_pct
  let depositPctMultiplier = 1;
  if (rm.deposit_pct) {
    const sampleDep = data.slice(0, 200).map(r => parseNum(r[rm.deposit_pct])).filter(v => v > 0);
    if (sampleDep.length > 0 && sampleDep.filter(r => r < 1).length / sampleDep.length > 0.8) depositPctMultiplier = 100;
  }
  let balloonMultiplier = 1;
  if (rm.balloon_pct) {
    const sampleBal = data.slice(0, 200).map(r => parseNum(r[rm.balloon_pct])).filter(v => v > 0);
    if (sampleBal.length > 0 && sampleBal.filter(r => r < 1).length / sampleBal.length > 0.8) balloonMultiplier = 100;
  }

  return data.map((row, i) => {
    const pc = rm.postcode ? String(row[rm.postcode] || '') : '';
    const explicitRegion = rm.region ? String(row[rm.region] || '') : '';
    const region = normaliseRegion(explicitRegion) || normaliseRegion(postcodeToRegion(pc));
    const sicCode = rm.sic_code ? String(row[rm.sic_code] || '') : '';
    const naceCode = rm.nace_code ? String(row[rm.nace_code] || '') : '';
    const explicitSector = rm.sector ? String(row[rm.sector] || '') : '';
    const sector = explicitSector || sicToSector(sicCode) || naceToSector(naceCode);
    const obj = {
      loan_id:             rm.loan_id ? String(row[rm.loan_id] || '') || `L${i+1}` : `L${i+1}`,
      borrower_name:       rm.borrower_name ? String(row[rm.borrower_name] || '') : '',
      sector:              sector,
      sic_code:            sicCode,
      nace_code:           naceCode,
      region:              region,
      loan_amount:         rm.loan_amount ? parseNum(row[rm.loan_amount]) : 0,
      outstanding_balance: rm.outstanding_balance ? parseNum(row[rm.outstanding_balance]) : 0,
      maturity_date:       rm.maturity_date ? String(row[rm.maturity_date] || '') : '',
      interest_rate:       rm.interest_rate ? parseNum(row[rm.interest_rate]) * rateMultiplier : 0,
      credit_rating:       rm.credit_rating ? String(row[rm.credit_rating] || '') : '',
      facility_type:       rm.facility_type ? String(row[rm.facility_type] || '') : '',
      default_flag:        rm.default_flag ? parseDefault(row[rm.default_flag]) : false,
      loan_status:         rm.loan_status ? String(row[rm.loan_status] || '') : '',
      arrears_status:      rm.arrears_status ? String(row[rm.arrears_status] || '') : '',
      origination_date:    rm.origination_date ? String(row[rm.origination_date] || '') : '',
      original_term:       rm.original_term ? parseNum(row[rm.original_term]) : 0,
      remaining_term:      rm.remaining_term ? parseNum(row[rm.remaining_term]) : 0,
      currency:            rm.currency ? String(row[rm.currency] || '') : '',
      repayment_method:    rm.repayment_method ? String(row[rm.repayment_method] || '') : '',
      amortisation_type:   rm.amortisation_type ? String(row[rm.amortisation_type] || '') : '',
      payment_frequency:   rm.payment_frequency ? String(row[rm.payment_frequency] || '') : '',
      interest_rate_type:  rm.interest_rate_type ? String(row[rm.interest_rate_type] || '') : '',
      days_in_arrears:     rm.days_in_arrears ? parseNum(row[rm.days_in_arrears]) : 0,
      equipment_type:      rm.equipment_type ? String(row[rm.equipment_type] || '') : '',
      asset_category:      rm.asset_category ? String(row[rm.asset_category] || '') : '',
      asset_type:          rm.asset_type ? String(row[rm.asset_type] || '') : '',
      supplier:            rm.supplier ? String(row[rm.supplier] || '') : '',
      deposit_amount:      rm.deposit_amount ? parseNum(row[rm.deposit_amount]) : 0,
      deposit_pct:         rm.deposit_pct ? parseNum(row[rm.deposit_pct]) * depositPctMultiplier : 0,
      vat_deferral:        rm.vat_deferral ? String(row[rm.vat_deferral] || '') : '',
      customer_segment:    rm.customer_segment ? String(row[rm.customer_segment] || '') : '',
      origination_channel: rm.origination_channel ? String(row[rm.origination_channel] || '') : '',
      balloon_pct:         rm.balloon_pct ? parseNum(row[rm.balloon_pct]) * balloonMultiplier : 0,
      postcode:            pc,
      bbb_guarantee:       rm.bbb_guarantee ? String(row[rm.bbb_guarantee] || '') : '',
      broker:              rm.broker ? String(row[rm.broker] || '') : '',
      originator:          rm.originator ? String(row[rm.originator] || '') : '',
      lessee_type:         rm.lessee_type ? String(row[rm.lessee_type] || '') : ''
    };

    // Derive days_in_arrears from arrears_status when not explicitly mapped
    if (obj.days_in_arrears === 0 && obj.arrears_status) {
      const as = obj.arrears_status.toLowerCase().trim();
      // Only derive if the status clearly indicates arrears
      if (as.includes('>90') || as.includes('90+') || as.includes('91+') || as.includes('90 day') || as.includes('90day')) obj.days_in_arrears = 91;
      else if (as.includes('61-90') || as.includes('61 -90') || as.includes('60-90')) obj.days_in_arrears = 75;
      else if (as.includes('31-60') || as.includes('31 -60') || as.includes('30-60')) obj.days_in_arrears = 45;
      else if (as.includes('1-30') || as.includes('1 -30') || as.includes('0-30') || as === '1-30 days') obj.days_in_arrears = 15;
      // Everything else (current, up to date, performing, n/a, 0, blank, etc.) stays at 0
    }

    // Apply custom field mappings
    if (customRm) {
      for (const [cfKey, srcCol] of Object.entries(customRm)) {
        const cfDef = customFieldDefs[cfKey];
        const rawVal = row[srcCol];
        if (cfDef && cfDef.type === 'numeric') {
          obj[cfKey] = parseNum(rawVal);
        } else {
          obj[cfKey] = rawVal != null ? String(rawVal) : '';
        }
      }
    }

    return obj;
  });
}

function parseNum(v) { const n = parseFloat(String(v).replace(/[\u00a3,$%]/g, '')); return isNaN(n) ? 0 : n; }
function parseDefault(v) { return v === true || v === 1 || v === '1' || String(v).toLowerCase() === 'yes' || String(v).toLowerCase() === 'true'; }

// ============================================================
//  SAMPLE TAPE GENERATOR — with deliberate anomalies
// ============================================================
function generateSampleRows() {
  const sectors = ['Healthcare','Technology','Business Services','Manufacturing','Professional Services','Retail & Consumer','Construction & Property','Energy & Infrastructure','Media & Entertainment','Financial Services','Education','Hospitality & Leisure','Transport & Logistics'];
  const regions = ['London','South East','Midlands','North West','North East','Scotland','Wales','South West','East of England','Yorkshire & Humber'];
  const grades = ['A','A-','B+','B','B-','C+','C','C-','D'];
  const gradeWeights = [0.04, 0.08, 0.14, 0.24, 0.20, 0.14, 0.10, 0.04, 0.02];
  const leaseTypes = ['Finance Lease','Operating Lease','Hire Purchase','Conditional Sale','PCP'];
  const leaseTypeWeights = [0.30, 0.20, 0.25, 0.15, 0.10];
  const assetTypes = ['Vehicles','Plant & Machinery','IT Equipment','Office Equipment','Commercial Vehicles','Medical Equipment','Construction Equipment','Printing Equipment','Catering Equipment','Agricultural Equipment'];
  const assetTypeWeights = [0.22, 0.18, 0.14, 0.08, 0.12, 0.06, 0.08, 0.04, 0.04, 0.04];
  const repayMethods = ['Level','Reducing','Balloon','Seasonal','Stepped'];
  const repayWeights = [0.35, 0.25, 0.20, 0.10, 0.10];
  const amortTypes = ['Annuity','Linear','Bullet','Soft Bullet'];
  const amortWeights = [0.40, 0.30, 0.15, 0.15];
  const payFreqs = ['Monthly','Quarterly','Semi-Annual','Annual'];
  const payFreqWeights = [0.65, 0.20, 0.10, 0.05];
  const rateTypes = ['Fixed','Floating','Mixed'];
  const rateTypeWeights = [0.55, 0.35, 0.10];
  const custSegments = ['SME','Mid-Market','Large Corporate','Micro Enterprise','Sole Trader'];
  const custSegWeights = [0.35, 0.25, 0.15, 0.15, 0.10];
  const channels = ['Direct','Broker','Vendor','Online','Partnership'];
  const channelWeights = [0.30, 0.25, 0.20, 0.15, 0.10];
  const bbbPrograms = ['None','None','None','None','None','None','GGS','GGS','RLS','None'];
  const loanStatuses = ['Live','Live','Live','Live','Live','Live','Live','Repaid','Defaulted','Settled Early'];
  const suppliers = ['ABC Vehicles Ltd','MegaPlant Corp','TechDirect Ltd','BuildPro Equipment','MedSupply UK','AgriEquip Ltd','PrintMax Solutions','CaterPro Ltd','OfficeHub UK','FleetCo'];
  const equipTypes = ['Car','Van','Forklift','CNC Machine','Server','Laptop','Excavator','X-Ray Machine','Tractor','Printer'];
  const assetCats = ['Hard Asset','Soft Asset','Vehicle','Hard Asset','Technology','Technology','Hard Asset','Hard Asset','Hard Asset','Soft Asset'];
  const sicCodes = ['45110','46900','47710','28110','62020','86101','41201','55100','01110','58110','74909','85310','49410','56101','35110'];
  const vatDeferrals = ['Yes','No','No','No','No','Partial','No','No','No','No'];
  const brokers = ['Alpha Brokers Ltd','Capital Finance Partners','Meridian Business Finance','Direct','Sterling Asset Finance','Direct','Peak Commercial Finance','Direct','Lombard Street Partners','Direct'];
  const originators = ['Enable Funding','Enable Funding','Enable Funding','Paragon Leasing','Enable Funding','Paragon Leasing','Enable Funding','Atlas Finance','Enable Funding','Enable Funding'];
  const postcodes = [
    'EC1A 1BB','SW1A 1AA','W1D 3QU','SE1 7PB','N1 9GU',
    'BN1 1AE','CT1 2EH','GU1 1AA','ME1 1QX','OX1 1BX',
    'BS1 1HT','EX1 1QA','BA1 1SU','PL1 1EA','GL1 1DZ',
    'B1 1BB','CV1 1FY','LE1 1AA','NG1 1AB','DE1 1QH',
    'CB1 1JW','NR1 1RN','IP1 1AY','CM1 1QZ','CO1 1PJ',
    'M1 1AE','L1 1JD','PR1 1HT','CH1 1NJ','BB1 1ET',
    'NE1 4ST','DH1 3EE','SR1 1PP','DL1 1QA','TS1 1DT',
    'LS1 1BA','BD1 1EP','HU1 1AA','S1 1WB','YO1 6GA',
    'EH1 1YZ','G1 1AA','AB10 1AN','DD1 1DA','KY1 1LQ',
    'CF10 1BH','SA1 1DP','LL11 1AB','NP20 1GE','LD1 5DL'
  ];
  const borrowers = [
    'Acorn Manufacturing Ltd','Beacon Healthcare Group','Crestfield Properties Plc','Drummond Engineering Ltd','Evergreen Retail Holdings',
    'Foxbridge Capital Ltd','Glenmore Logistics Plc','Hartland Construction Ltd','Ironside Technologies Ltd','Jubilee Hotels Group',
    'Kingfisher Media Ltd','Lakeside Foods Plc','Millbrook Pharmaceuticals','Northgate Services Ltd','Oakwood Education Trust',
    'Pennine Transport Ltd','Quartermile Ventures Ltd','Rosewood Hospitality Plc','Silverstone Motors Ltd','Thornbury Agriculture',
    'Ashworth Textiles Ltd','Barrington Financial Plc','Cavendish Partners Ltd','Dalton Energy Services','Elmwood Care Homes Ltd',
    'Farnham Digital Ltd','Guildhall Property Trust','Hawthorn Packaging Ltd','Ivybridge Renewables','Kensington Capital Plc',
    'Langley Aerospace Ltd','Moorfield Recycling Ltd','Newbury Biotech Ltd','Osprey Defence Systems','Pemberton Mining Ltd',
    'Ridgeway Infrastructure','Stanmore Chemicals Ltd','Tavistock Brewing Co','Underwood Telecom Ltd','Vauxhall Precision Ltd',
    'Whitfield Consulting Ltd','Yarmouth Marine Services','Albion Steel Works Ltd','Brixton Foods Group','Cheltenham IT Services',
    'Devonshire Paper Mills','Exmouth Leisure Holdings','Falkirk Plant Hire Ltd','Greenwich Software Ltd','Holborn Legal Services',
    'Islington Health Partners','Jersey Finance Solutions','Kelso Agricultural Co','Lewisham Logistics Ltd','Manchester Print Group',
    'Norwich Data Centre Ltd','Oxford Instruments Plc','Preston Composites Ltd','Reading Facilities Mgmt','Sheffield Forgings Ltd',
    'Taunton Warehousing Ltd','Uxbridge Engineering Plc','Warwick Plastics Ltd','Exeter Renewable Power','York Building Supplies'
  ];

  function wr(weights) { const r = Math.random(); let c = 0; for (let i = 0; i < weights.length; i++) { c += weights[i]; if (r <= c) return i; } return weights.length - 1; }
  function randDate(sy, ey) {
    const y = sy + Math.floor(Math.random() * (ey - sy + 1));
    const m = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
    const d = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
    return `${d}/${m}/${y}`;
  }

  const rows = [];
  for (let i = 1; i <= 200; i++) {
    const gradeIdx = wr(gradeWeights);
    const origBal = Math.round((15000 + Math.random() * 485000) / 1000) * 1000;
    const origTerm = [12,18,24,36,48,60,72,84][Math.floor(Math.random() * 8)];
    let remTerm = Math.max(1, Math.round(origTerm * (0.1 + Math.random() * 0.8)));
    const baseRate = [3.5, 4.2, 5.0, 5.8, 6.5, 7.5, 8.5, 10.0, 12.0][gradeIdx];
    const rate = Math.round((baseRate + (Math.random() - 0.5) * 1.2) * 100) / 100;
    const elapsed = origTerm - remTerm;
    const util = Math.max(0.1, 1 - (elapsed / origTerm) * (0.7 + Math.random() * 0.3));
    let outBal = Math.round(origBal * util / 100) * 100;
    const repayIdx = wr(repayWeights);
    const balloonPct = repayIdx === 2 ? Math.round(15 + Math.random() * 30) : 0;
    const arrearsProb = [0.01, 0.02, 0.03, 0.05, 0.08, 0.12, 0.18, 0.25, 0.40][gradeIdx];
    let arrearsDays = 0;
    if (Math.random() < arrearsProb) arrearsDays = Math.floor(Math.random() * 180) + 1;
    let ccy = 'GBP';

    // --- DELIBERATE ANOMALIES ---
    // Remaining term > original term (IDs 5, 42)
    if (i === 5 || i === 42) remTerm = origTerm + 12;
    // Non-GBP currency (IDs 11, 88)
    if (i === 11) ccy = 'EUR';
    if (i === 88) ccy = 'USD';
    // Negative outstanding balance (ID 23)
    if (i === 23) outBal = -15000;
    // Outstanding > original (ID 67)
    if (i === 67) outBal = origBal + 50000;
    // Zero interest rate (IDs 33, 99)
    if (i === 33 || i === 99) {}  // rate stays as generated; we'll override below
    // Very high rate (ID 150)
    if (i === 150) {}
    // Balloon > 100% (ID 77)
    // Future origination date (IDs 130, 180)
    // Duplicate IDs (IDs 190, 191 both get same ref)

    const leaseRef = (i === 191) ? 'EF-00190' : `EF-${String(i).padStart(5, '0')}`;

    rows.push({
      'Lease_Identifier':    leaseRef,
      'Lessee_Identifier':   borrowers[Math.floor(Math.random() * borrowers.length)],
      'SIC_Industry_Code':   sectors[Math.floor(Math.random() * sectors.length)],
      'UK_Region':           regions[Math.floor(Math.random() * regions.length)],
      'Original_Principal_Balance': origBal,
      'Current_Prin_Outstanding_Bal': outBal,
      'Maturity_Date':       randDate(2026, 2033),
      'Margin_Coupon':       i === 33 || i === 99 ? 0 : (i === 150 ? 35.5 : Math.max(2.0, rate)),
      'Risk_Grade':          grades[gradeIdx],
      'Type_of_Lease':       leaseTypes[wr(leaseTypeWeights)],
      'NPL_Flag':            arrearsDays > 90 ? 'Yes' : 'No',
      'Lease_Origination_Date': i === 130 || i === 180 ? randDate(2027, 2028) : randDate(2019, 2025),
      'Original_Term':       origTerm,
      'Remaining_Term':      remTerm,
      'Currency':            ccy,
      'Repayment_Method':    repayMethods[repayIdx],
      'Amortisation_Type':   amortTypes[wr(amortWeights)],
      'Payment_Frequency':   payFreqs[wr(payFreqWeights)],
      'Interest_Rate_Type':  rateTypes[wr(rateTypeWeights)],
      'Number_of_Days_in_Arrears': arrearsDays,
      'Asset_Type':          assetTypes[wr(assetTypeWeights)],
      'Customer_Segment':    custSegments[wr(custSegWeights)],
      'Origination_Channel': channels[wr(channelWeights)],
      'Balloon_Percentage':  i === 77 ? 115 : balloonPct,
      'Postcode':            postcodes[Math.floor(Math.random() * postcodes.length)],
      'BBB_Guarantee':       bbbPrograms[Math.floor(Math.random() * bbbPrograms.length)],
      'Status':              loanStatuses[Math.floor(Math.random() * loanStatuses.length)],
      'SIC_Code':            sicCodes[Math.floor(Math.random() * sicCodes.length)],
      'Equipment_Type':      equipTypes[Math.floor(Math.random() * equipTypes.length)],
      'Asset_Category':      assetCats[Math.floor(Math.random() * assetCats.length)],
      'Supplier':            suppliers[Math.floor(Math.random() * suppliers.length)],
      'Deposit_Amount':      Math.round((origBal * (5 + Math.random() * 15) / 100) / 100) * 100,
      'Deposit_Percentage':  Math.round((5 + Math.random() * 15) * 100) / 100,
      'VAT_Deferral':        vatDeferrals[Math.floor(Math.random() * vatDeferrals.length)],
      'Broker':              brokers[Math.floor(Math.random() * brokers.length)],
      'Originator':          originators[Math.floor(Math.random() * originators.length)]
    });
  }
  return rows;
}

function downloadSampleTape() {
  const rows = generateSampleRows();
  const ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = Array(Object.keys(rows[0]).length).fill({ wch: 18 });
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Lease Tape');
  XLSX.writeFile(wb, 'sample_lease_tape_enable_funding.xlsx');
}

// ============================================================
//  FORMATTING HELPERS — GBP
// ============================================================
function fmtM(v) {
  if (v >= 1e9) return '\u00A3' + (v / 1e9).toFixed(2) + 'bn';
  if (v >= 1e6) return '\u00A3' + (v / 1e6).toFixed(1) + 'mm';
  if (v >= 1e3) return '\u00A3' + (v / 1e3).toFixed(0) + 'k';
  return '\u00A3' + v.toFixed(0);
}
function fmtFull(v) { return '\u00A3' + v.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
function fmtPct(v) { return v.toFixed(2) + '%'; }
function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ============================================================
//  DATE PARSER — UK default DD/MM/YYYY
// ============================================================
function parseDate(s) {
  if (!s) return null;
  const dmy = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (dmy) {
    const day = parseInt(dmy[1]), mon = parseInt(dmy[2]), yr = parseInt(dmy[3]);
    if (day > 12) return new Date(yr, mon - 1, day);
    if (mon > 12) return new Date(yr, day - 1, mon);
    return new Date(yr, mon - 1, day);
  }
  const ymd = String(s).match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (ymd) return new Date(parseInt(ymd[1]), parseInt(ymd[2]) - 1, parseInt(ymd[3]));
  const num = parseFloat(s);
  if (!isNaN(num) && num > 30000 && num < 100000) return new Date((num - 25569) * 86400000);
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

// ============================================================
//  TABS
// ============================================================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ============================================================
//  RENDER DASHBOARD
// ============================================================
function renderCutoffBanner() {
  const banner = document.getElementById('cutoff-date-banner');
  const meta = getActiveTapeMeta();
  const hasCutoff = meta.some(m => m.cutoffDate);
  const hasOriginator = meta.some(m => m.originator);
  if (!hasCutoff && !hasOriginator) { banner.innerHTML = ''; return; }

  let html = '<div class="cutoff-banner">';
  // Originator(s)
  if (hasOriginator) {
    const originators = [...new Set(meta.filter(m => m.originator).map(m => m.originator))];
    if (originators.length === 1) {
      html += `<span class="cutoff-label">Originator:</span><span class="cutoff-value">${escapeHtml(originators[0])}</span>`;
    } else {
      html += `<span class="cutoff-label">Originators:</span><span class="cutoff-value">${originators.map(o => escapeHtml(o)).join(', ')}</span>`;
    }
    if (hasCutoff) html += '<span style="opacity:0.2;margin:0 10px;">|</span>';
  }
  // Cut-off date(s)
  if (hasCutoff) {
    const cutoffs = meta.filter(m => m.cutoffDate);
    if (cutoffs.length === 1 || new Set(cutoffs.map(c => c.cutoffDate)).size === 1) {
      html += `<span class="cutoff-label">Cut-Off Date:</span><span class="cutoff-value">${formatCutoffDate(cutoffs[0].cutoffDate)}</span>`;
    } else {
      const items = cutoffs.map(c => `<span>${escapeHtml(c.series)}: <span class="cutoff-value">${formatCutoffDate(c.cutoffDate)}</span></span>`).join('<span style="opacity:0.3;margin:0 4px;">|</span>');
      html += `<span class="cutoff-label">Cut-Off Dates:</span>${items}`;
    }
  }
  html += '</div>';
  banner.innerHTML = html;
}

// ============================================================
//  VALUE MAPPING — cross-tape harmonisation
// ============================================================
let pendingValueMaps = {}; // { fieldKey: { oldVal: newVal, ... } }
let pendingValueMapTapeIdx = -1;

function showValueMappingPrompt(tapeIdx) {
  pendingValueMapTapeIdx = tapeIdx;
  pendingValueMaps = {};
  const tape = tapes[tapeIdx];
  const otherTapes = tapes.filter((_, i) => i !== tapeIdx);
  if (otherTapes.length === 0) return;

  const catFields = ['facility_type','asset_type','interest_rate_type','repayment_method','amortisation_type',
    'lessee_type','origination_channel','credit_rating','region','loan_status',
    'equipment_type','asset_category','supplier','broker','originator','sector'];

  // Collect existing values from other tapes
  const existingValues = {};
  catFields.forEach(f => {
    existingValues[f] = new Set();
    otherTapes.forEach(t => t.loans.forEach(l => {
      const v = l[f];
      if (v && String(v).trim()) existingValues[f].add(String(v).trim());
    }));
  });

  // New tape values
  const newTapeValues = {};
  catFields.forEach(f => {
    newTapeValues[f] = new Set();
    tape.loans.forEach(l => {
      const v = l[f];
      if (v && String(v).trim()) newTapeValues[f].add(String(v).trim());
    });
  });

  // Find mismatches in both directions
  const mismatches = {};
  catFields.forEach(f => {
    if (existingValues[f].size === 0 && newTapeValues[f].size === 0) return;
    const newOnly = [...newTapeValues[f]].filter(v => !existingValues[f].has(v));
    const existingOnly = [...existingValues[f]].filter(v => !newTapeValues[f].has(v));
    if (newOnly.length > 0 || existingOnly.length > 0) {
      mismatches[f] = { newOnly, existingOnly, allNew: [...newTapeValues[f]].sort(), allExisting: [...existingValues[f]].sort() };
    }
  });

  if (Object.keys(mismatches).length === 0) return;

  const body = document.getElementById('valuemap-body');
  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });

  let html = '';
  let sectionIdx = 0;
  for (const [field, data] of Object.entries(mismatches)) {
    const label = fieldLabels[field] || field;
    const totalMismatches = data.newOnly.length + data.existingOnly.length;
    const secId = 'harm-sec-' + sectionIdx++;
    // Each field is a collapsible section, minimised by default
    html += `<div style="margin-bottom:8px;border:1px solid var(--border-light);border-radius:var(--radius);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg);cursor:pointer;" onclick="(function(el){var body=el.nextElementSibling;var arrow=el.querySelector('.harm-arrow');if(body.style.display==='none'){body.style.display='';arrow.textContent='▾';}else{body.style.display='none';arrow.textContent='▸';}})(this)">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="harm-arrow" style="font-size:10px;color:var(--text-muted);width:12px;">▸</span>
          <span style="font-size:13px;font-weight:600;">${escapeHtml(label)}</span>
          <span class="badge badge-amber" style="font-size:10px;">${totalMismatches} to review</span>
        </div>
      </div>
      <div style="display:none;padding:8px 14px;">`;

    // New tape values not in existing tapes
    if (data.newOnly.length > 0) {
      html += `<div style="margin-bottom:8px;">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">${data.newOnly.length} in new tape only</div>`;
      data.newOnly.forEach(val => {
        const bestMatch = findBestValueMatch(val, data.allExisting);
        const optionsHtml = `<option value="__keep__">Keep as "${escapeHtml(val)}"</option>` +
          data.allExisting.map(ev => `<option value="${escapeHtml(ev)}" ${bestMatch === ev ? 'selected' : ''}>${escapeHtml(ev)}${bestMatch === ev ? ' (suggested)' : ''}</option>`).join('');
        html += `<div style="display:flex;gap:8px;align-items:center;padding:4px 0;">
          <span style="flex:0 0 180px;font-size:12px;font-family:var(--mono);padding:4px 8px;background:var(--amber-faint);border-radius:var(--radius);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(val)}">${escapeHtml(val)}</span>
          <span style="color:var(--text-muted);font-size:12px;">&#8594;</span>
          <select class="mapping-select" style="flex:1;" onchange="setValueMap('new','${field}','${val.replace(/'/g, "\\'")}',this.value)">
            ${optionsHtml}
          </select>
        </div>`;
        if (bestMatch) {
          if (!pendingValueMaps[field]) pendingValueMaps[field] = {};
          pendingValueMaps[field]['new:' + val] = bestMatch;
        }
      });
      html += `</div>`;
    }
    // Existing tape values not in new tape — default: keep unchanged
    if (data.existingOnly.length > 0) {
      html += `<div style="margin-bottom:4px;">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">${data.existingOnly.length} in existing tapes only</div>`;
      data.existingOnly.forEach(val => {
        const bestMatch = findBestValueMatch(val, data.allNew);
        const optionsHtml = `<option value="__keep__" selected>Keep as "${escapeHtml(val)}"</option>` +
          data.allNew.map(nv => `<option value="${escapeHtml(nv)}">${escapeHtml(nv)}${bestMatch === nv ? ' (suggested)' : ''}</option>`).join('');
        html += `<div style="display:flex;gap:8px;align-items:center;padding:4px 0;">
          <span style="flex:0 0 180px;font-size:12px;font-family:var(--mono);padding:4px 8px;background:var(--navy-faint);border-radius:var(--radius);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(val)}">${escapeHtml(val)}</span>
          <span style="color:var(--text-muted);font-size:12px;">&#8594;</span>
          <select class="mapping-select" style="flex:1;" onchange="setValueMap('existing','${field}','${val.replace(/'/g, "\\'")}',this.value)">
            ${optionsHtml}
          </select>
        </div>`;
      });
      html += `</div>`;
    }
    html += `</div></div>`;
  }

  const total = Object.values(mismatches).reduce((s, d) => s + d.newOnly.length + d.existingOnly.length, 0);
  document.getElementById('valuemap-status').innerHTML = `<span class="count">${total}</span> values to review — expand each category to harmonise`;
  body.innerHTML = html;
  document.getElementById('valuemap-overlay').classList.add('active');
}

function normalizeValueStr(s) {
  // Normalise '&' to 'and' and strip non-alphanumeric for comparison
  return String(s).toLowerCase().replace(/&/g, 'and').replace(/[^a-z0-9]/g, '');
}

function findBestValueMatch(val, existing) {
  const lower = normalizeValueStr(val);
  const exact = existing.find(e => e.toLowerCase() === val.toLowerCase());
  if (exact) return exact;
  // Match after normalising & to 'and' and stripping punctuation
  const stripped = existing.find(e => normalizeValueStr(e) === lower);
  if (stripped) return stripped;
  const contained = existing.find(e => normalizeValueStr(e).includes(lower) || lower.includes(normalizeValueStr(e)));
  if (contained && lower.length >= 2) return contained;
  return '';
}

function setValueMap(direction, field, oldVal, newVal) {
  if (!pendingValueMaps[field]) pendingValueMaps[field] = {};
  const key = direction + ':' + oldVal;
  if (newVal && newVal !== '__keep__') {
    pendingValueMaps[field][key] = newVal;
  } else {
    delete pendingValueMaps[field][key];
  }
}

function applyValueMapping() {
  if (pendingValueMapTapeIdx < 0) return;
  const newTape = tapes[pendingValueMapTapeIdx];
  const otherTapes = tapes.filter((_, i) => i !== pendingValueMapTapeIdx);
  for (const [field, maps] of Object.entries(pendingValueMaps)) {
    for (const [key, newVal] of Object.entries(maps)) {
      if (!newVal || newVal === '__keep__') continue;
      const [direction, ...rest] = key.split(':');
      const oldVal = rest.join(':');
      if (direction === 'new') {
        newTape.loans.forEach(l => {
          if (String(l[field]).trim() === oldVal) l[field] = newVal;
        });
      } else if (direction === 'existing') {
        otherTapes.forEach(t => t.loans.forEach(l => {
          if (String(l[field]).trim() === oldVal) l[field] = newVal;
        }));
      }
    }
  }
  document.getElementById('valuemap-overlay').classList.remove('active');
  pendingValueMaps = {};
  pendingValueMapTapeIdx = -1;
  // Refresh loans and dashboard
  loans = [];
  tapes.forEach(t => loans.push(...t.loans));
  if (loans.length) renderDashboard();
}

function closeValueMapping() {
  document.getElementById('valuemap-overlay').classList.remove('active');
  pendingValueMaps = {};
  pendingValueMapTapeIdx = -1;
}

function goBackFromHarmonisation() {
  // Remove the last tape that was just added, go back to column mapping
  if (pendingValueMapTapeIdx >= 0 && pendingValueMapTapeIdx < tapes.length) {
    const tape = tapes[pendingValueMapTapeIdx];
    // Restore pendingRawData from the tape's stored raw data
    pendingRawData = tape._rawData;
    // Restore column mapping
    columnMapping = tape.columnMapping ? { ...tape.columnMapping } : {};
    // Remove the tape
    tapes.splice(pendingValueMapTapeIdx, 1);
    // Refresh loans
    loans = [];
    tapes.forEach(t => loans.push(...t.loans));
  }
  document.getElementById('valuemap-overlay').classList.remove('active');
  pendingValueMaps = {};
  pendingValueMapTapeIdx = -1;
  // Re-open column mapping modal
  if (pendingRawData) {
    const sourceColumns = Object.keys(pendingRawData[0]);
    document.getElementById('mapping-col-count').textContent = sourceColumns.length;
    renderMappingRows(sourceColumns, {});
    updateMappingStatus();
    document.getElementById('mapping-overlay').classList.add('active');
  }
}

// ============================================================
//  COMPARISON TAB — detailed series comparison
// ============================================================
let comparisonCharts = {};
function destroyComparisonCharts() { Object.values(comparisonCharts).forEach(c => c.destroy()); comparisonCharts = {}; }

function renderComparison() {
  destroyComparisonCharts();
  const container = document.getElementById('comparison-content');
  const link = document.getElementById('tab-comparison-link');
  if (tapes.length < 2) {
    if (link) link.style.display = 'none';
    if (container) container.innerHTML = '';
    return;
  }
  if (link) link.style.display = '';

  const seriesNames = [...new Set(tapes.map(t => t.series))];
  if (seriesNames.length < 2) { container.innerHTML = ''; return; }

  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });

  // Series data
  const seriesData = seriesNames.map(s => {
    const sloans = [];
    tapes.filter(t => t.series === s).forEach(t => sloans.push(...t.loans));
    const tape = tapes.find(t => t.series === s);
    const tot = sloans.reduce((sm, l) => sm + l.outstanding_balance, 0);
    const orig = sloans.reduce((sm, l) => sm + l.loan_amount, 0);
    const waRate = tot > 0 ? sloans.reduce((sm, l) => sm + l.interest_rate * l.outstanding_balance, 0) / tot : 0;
    const waRemTerm = tot > 0 ? sloans.reduce((sm, l) => sm + (l.remaining_term || 0) * l.outstanding_balance, 0) / tot : 0;
    const waOrigTerm = tot > 0 ? sloans.reduce((sm, l) => sm + (l.original_term || 0) * l.outstanding_balance, 0) / tot : 0;
    const arrBal = sloans.filter(l => l.days_in_arrears > 0).reduce((sm, l) => sm + l.outstanding_balance, 0);
    const arrPct = tot > 0 ? (arrBal / tot) * 100 : 0;
    const arr30Bal = sloans.filter(l => l.days_in_arrears > 0 && l.days_in_arrears <= 30).reduce((sm, l) => sm + l.outstanding_balance, 0);
    const arr60Bal = sloans.filter(l => l.days_in_arrears > 30 && l.days_in_arrears <= 60).reduce((sm, l) => sm + l.outstanding_balance, 0);
    const arr90Bal = sloans.filter(l => l.days_in_arrears > 60 && l.days_in_arrears <= 90).reduce((sm, l) => sm + l.outstanding_balance, 0);
    const arr90PlusBal = sloans.filter(l => l.days_in_arrears > 90).reduce((sm, l) => sm + l.outstanding_balance, 0);
    const arr90PlusPct = tot > 0 ? (arr90PlusBal / tot) * 100 : 0;
    const defPct = sloans.length > 0 ? (sloans.filter(l => l.default_flag).length / sloans.length * 100) : 0;
    const uniqueB = new Set(sloans.map(l => l.borrower_name)).size;
    const avgFac = sloans.length > 0 ? orig / sloans.length : 0;
    const bMap = {};
    sloans.forEach(l => { bMap[l.borrower_name] = (bMap[l.borrower_name] || 0) + l.outstanding_balance; });
    const sortedBorrowers = Object.values(bMap).sort((a, b) => b - a);
    const top5Pct = tot > 0 ? (sortedBorrowers.slice(0, 5).reduce((sm, v) => sm + v, 0) / tot * 100) : 0;
    const top10Pct = tot > 0 ? (sortedBorrowers.slice(0, 10).reduce((sm, v) => sm + v, 0) / tot * 100) : 0;
    // Size band distribution
    const sizeBands = { '0-25k': 0, '25-50k': 0, '50-100k': 0, '100-250k': 0, '250-500k': 0, '500k+': 0 };
    const sizeCount = { '0-25k': 0, '25-50k': 0, '50-100k': 0, '100-250k': 0, '250-500k': 0, '500k+': 0 };
    sloans.forEach(l => {
      const b = l.outstanding_balance;
      const band = b <= 25000 ? '0-25k' : b <= 50000 ? '25-50k' : b <= 100000 ? '50-100k' : b <= 250000 ? '100-250k' : b <= 500000 ? '250-500k' : '500k+';
      sizeBands[band] += b;
      sizeCount[band]++;
    });
    return { name: s, loans: sloans, count: sloans.length, originator: tape ? tape.originator || '' : '', cutoff: tape ? tape.cutoffDate || '' : '', outstanding: tot, original: orig, waRate, waRemTerm, waOrigTerm, arrPct, arr30Bal, arr60Bal, arr90Bal, arr90PlusBal, arr90PlusPct, defPct, uniqueB, avgFac, top5Pct, top10Pct, sizeBands, sizeCount };
  });

  let html = '';

  // ---- 1. KEY METRICS SUMMARY TABLE ----
  const metrics = [
    { label: 'Originator', fn: d => d.originator || '-', raw: true },
    { label: 'Cut-Off Date', fn: d => d.cutoff ? formatCutoffDate(d.cutoff) : '-', raw: true },
    { label: 'Receivables', fn: d => d.count, fmt: v => v.toLocaleString() },
    { label: 'Original Amount', fn: d => d.original, fmt: v => fmtM(v) },
    { label: 'Current Outstanding', fn: d => d.outstanding, fmt: v => fmtM(v) },
    { label: 'Current Factor', fn: d => d.original > 0 ? (d.outstanding / d.original) : 0, fmt: v => (v * 100).toFixed(1) + '%' },
    { label: 'WA Interest Rate', fn: d => d.waRate, fmt: v => fmtPct(v) },
    { label: 'WA Orig. Term', fn: d => d.waOrigTerm, fmt: v => convertTerm(v, displaySettings.termUnit) },
    { label: 'WA Rem. Term', fn: d => d.waRemTerm, fmt: v => convertTerm(v, displaySettings.termUnit) },
    { label: 'Avg Facility Size', fn: d => d.avgFac, fmt: v => fmtM(v) },
    { label: 'Unique Borrowers', fn: d => d.uniqueB, fmt: v => v.toLocaleString() },
    { label: 'Arrears (% Bal)', fn: d => d.arrPct, fmt: v => fmtPct(v), warn: v => v > 5 ? 'var(--red)' : v > 2 ? 'var(--amber)' : '' },
    { label: '90+ DPD (% Bal)', fn: d => d.arr90PlusPct, fmt: v => fmtPct(v), warn: v => v > 5 ? 'var(--red)' : v > 2 ? 'var(--amber)' : '' },
    { label: 'Default Rate', fn: d => d.defPct, fmt: v => fmtPct(v), warn: v => v > 3 ? 'var(--red)' : v > 1 ? 'var(--amber)' : '' },
    { label: 'Top 5 Concentration', fn: d => d.top5Pct, fmt: v => v.toFixed(1) + '%', warn: v => v > 40 ? 'var(--red)' : v > 25 ? 'var(--amber)' : '' },
    { label: 'Top 10 Concentration', fn: d => d.top10Pct, fmt: v => v.toFixed(1) + '%', warn: v => v > 60 ? 'var(--red)' : v > 40 ? 'var(--amber)' : '' }
  ];

  const headerCells = seriesData.map(d => `<th class="right" style="min-width:120px;">${escapeHtml(d.name)}</th>`).join('');
  // Add delta column if exactly 2 series
  const showDelta = seriesData.length === 2;
  const deltaHeader = showDelta ? '<th class="right" style="min-width:80px;color:var(--text-muted);">Delta</th>' : '';
  const rows = metrics.map(m => {
    const cells = seriesData.map(d => {
      const v = m.fn(d);
      if (m.raw) return `<td class="mono right">${escapeHtml(String(v))}</td>`;
      const color = m.warn ? m.warn(v) : '';
      return `<td class="mono right" ${color ? 'style="color:'+color+'"' : ''}>${m.fmt(v)}</td>`;
    }).join('');
    let deltaCell = '';
    if (showDelta && !m.raw) {
      const v0 = m.fn(seriesData[0]), v1 = m.fn(seriesData[1]);
      const diff = v1 - v0;
      const sign = diff > 0 ? '+' : '';
      deltaCell = `<td class="mono right" style="color:var(--text-muted);font-size:11px;">${sign}${m.fmt(diff)}</td>`;
    } else if (showDelta) {
      deltaCell = '<td></td>';
    }
    return `<tr><td style="font-weight:500;">${m.label}</td>${cells}${deltaCell}</tr>`;
  }).join('');

  html += `<div class="card" style="margin-bottom:16px;">
    <h3 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">Key Metrics Comparison</h3>
    <div class="table-scroll"><table>
      <thead><tr><th>Metric</th>${headerCells}${deltaHeader}</tr></thead>
      <tbody>${rows}</tbody>
    </table></div>
  </div>`;

  // ---- 2. BALANCE SIZE DISTRIBUTION COMPARISON ----
  const sizeBandLabels = ['0-25k', '25-50k', '50-100k', '100-250k', '250-500k', '500k+'];
  const sizeChartId = 'comp-chart-size-' + Date.now();

  // Build table
  let sizeRows = sizeBandLabels.map(band => {
    const cells = seriesData.map(d => {
      const bal = d.sizeBands[band];
      const pct = d.outstanding > 0 ? ((bal / d.outstanding) * 100).toFixed(1) : '0.0';
      const cnt = d.sizeCount[band];
      return `<td class="mono right">${pct}%<span style="font-size:10px;color:var(--text-muted);margin-left:4px;">(${cnt})</span></td>`;
    }).join('');
    return `<tr><td style="font-size:12px;">${band}</td>${cells}</tr>`;
  }).join('');

  html += `<div class="card" style="margin-bottom:16px;">
    <h3 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">Balance Size Distribution</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
      <div class="table-scroll"><table>
        <thead><tr><th>Band</th>${seriesData.map(d => `<th class="right">${escapeHtml(d.name)}</th>`).join('')}</tr></thead>
        <tbody>${sizeRows}</tbody>
      </table></div>
      <div style="position:relative;height:220px;"><canvas id="${sizeChartId}"></canvas></div>
    </div>
  </div>`;

  // ---- 3. TOP SECTORS COMPARISON ----
  const sectorChartId = 'comp-chart-sector-' + Date.now();
  const allSectors = {};
  seriesData.forEach(d => {
    d.loans.forEach(l => { if (l.sector && String(l.sector).trim()) allSectors[l.sector] = true; });
  });
  const sectorNames = Object.keys(allSectors);
  if (sectorNames.length > 0) {
    // Compute sector breakdown per series, sorted by total across all series
    const sectorTotals = {};
    sectorNames.forEach(sec => {
      sectorTotals[sec] = seriesData.reduce((sm, d) => sm + d.loans.filter(l => l.sector === sec).reduce((s, l) => s + l.outstanding_balance, 0), 0);
    });
    const topSectors = Object.entries(sectorTotals).sort((a, b) => b[1] - a[1]).slice(0, 10).map(e => e[0]);

    let sectorRows = topSectors.map(sec => {
      const cells = seriesData.map(d => {
        const bal = d.loans.filter(l => l.sector === sec).reduce((sm, l) => sm + l.outstanding_balance, 0);
        const pct = d.outstanding > 0 ? ((bal / d.outstanding) * 100).toFixed(1) : '0.0';
        return `<td class="mono right">${pct}%</td>`;
      }).join('');
      return `<tr><td style="font-size:12px;">${escapeHtml(sec)}</td>${cells}</tr>`;
    }).join('');
    // Add "Other" row if there are more sectors
    if (sectorNames.length > 10) {
      const cells = seriesData.map(d => {
        const topBal = topSectors.reduce((sm, sec) => sm + d.loans.filter(l => l.sector === sec).reduce((s, l) => s + l.outstanding_balance, 0), 0);
        const otherPct = d.outstanding > 0 ? (((d.outstanding - topBal) / d.outstanding) * 100).toFixed(1) : '0.0';
        return `<td class="mono right" style="color:var(--text-muted);">${otherPct}%</td>`;
      }).join('');
      sectorRows += `<tr><td style="font-size:12px;color:var(--text-muted);">Other (${sectorNames.length - 10})</td>${cells}</tr>`;
    }

    html += `<div class="card" style="margin-bottom:16px;">
      <h3 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">Top Sector Breakdown</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
        <div class="table-scroll"><table>
          <thead><tr><th>Sector</th>${seriesData.map(d => `<th class="right">${escapeHtml(d.name)}</th>`).join('')}</tr></thead>
          <tbody>${sectorRows}</tbody>
        </table></div>
        <div style="position:relative;height:260px;"><canvas id="${sectorChartId}"></canvas></div>
      </div>
    </div>`;
  }

  // ---- 4. ARREARS PROFILE COMPARISON ----
  const arrearsChartId = 'comp-chart-arrears-' + Date.now();
  const arrearsBands = ['Current', '1-30 DPD', '31-60 DPD', '61-90 DPD', '90+ DPD'];

  let arrearsRows = arrearsBands.map((band, i) => {
    const cells = seriesData.map(d => {
      let bal;
      if (i === 0) bal = d.outstanding - d.arr30Bal - d.arr60Bal - d.arr90Bal - d.arr90PlusBal;
      else if (i === 1) bal = d.arr30Bal;
      else if (i === 2) bal = d.arr60Bal;
      else if (i === 3) bal = d.arr90Bal;
      else bal = d.arr90PlusBal;
      const pct = d.outstanding > 0 ? ((bal / d.outstanding) * 100).toFixed(1) : '0.0';
      const color = i >= 3 && parseFloat(pct) > 2 ? (parseFloat(pct) > 5 ? 'color:var(--red);' : 'color:var(--amber);') : '';
      return `<td class="mono right" style="${color}">${pct}%<span style="font-size:10px;color:var(--text-muted);margin-left:4px;">${fmtM(Math.max(0, bal))}</span></td>`;
    }).join('');
    return `<tr><td style="font-size:12px;">${band}</td>${cells}</tr>`;
  }).join('');

  html += `<div class="card" style="margin-bottom:16px;">
    <h3 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">Arrears Profile</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
      <div class="table-scroll"><table>
        <thead><tr><th>Band</th>${seriesData.map(d => `<th class="right">${escapeHtml(d.name)}</th>`).join('')}</tr></thead>
        <tbody>${arrearsRows}</tbody>
      </table></div>
      <div style="position:relative;height:220px;"><canvas id="${arrearsChartId}"></canvas></div>
    </div>
  </div>`;

  // ---- 5. FACILITY TYPE MIX COMPARISON ----
  const facChartId = 'comp-chart-facility-' + Date.now();
  const hasFacility = seriesData.some(d => d.loans.some(l => l.facility_type && String(l.facility_type).trim()));
  const topFacilities = [];
  if (hasFacility) {
    const allFacilities = {};
    seriesData.forEach(d => d.loans.forEach(l => { if (l.facility_type && String(l.facility_type).trim()) allFacilities[l.facility_type] = true; }));
    const facilityNames = Object.keys(allFacilities);
    const facTotals = {};
    facilityNames.forEach(f => {
      facTotals[f] = seriesData.reduce((sm, d) => sm + d.loans.filter(l => l.facility_type === f).reduce((s, l) => s + l.outstanding_balance, 0), 0);
    });
    topFacilities.push(...Object.entries(facTotals).sort((a, b) => b[1] - a[1]).slice(0, 10).map(e => e[0]));

    // Build header: per series show % / Outstanding / # columns
    const facHdrCells = seriesData.map(d => `<th class="right" colspan="3" style="border-bottom:2px solid var(--border);">${escapeHtml(d.name)}</th>`).join('');
    const facSubHdr = seriesData.map(() => `<th class="right" style="font-size:10px;font-weight:500;color:var(--text-muted);">%</th><th class="right" style="font-size:10px;font-weight:500;color:var(--text-muted);">Outstanding</th><th class="right" style="font-size:10px;font-weight:500;color:var(--text-muted);">#</th>`).join('');
    let facRows = topFacilities.map(f => {
      const cells = seriesData.map(d => {
        const bal = d.loans.filter(l => l.facility_type === f).reduce((sm, l) => sm + l.outstanding_balance, 0);
        const cnt = d.loans.filter(l => l.facility_type === f).length;
        const pct = d.outstanding > 0 ? ((bal / d.outstanding) * 100).toFixed(1) : '0.0';
        return `<td class="mono right">${pct}%</td><td class="mono right" style="font-size:11px;">${fmtM(bal)}</td><td class="mono right" style="color:var(--text-muted);">${cnt}</td>`;
      }).join('');
      return `<tr><td style="font-size:12px;">${escapeHtml(f)}</td>${cells}</tr>`;
    }).join('');

    html += `<div class="card" style="margin-bottom:16px;">
      <h3 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">Facility Type Mix</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
        <div class="table-scroll"><table>
          <thead><tr><th>Type</th>${facHdrCells}</tr><tr><th></th>${facSubHdr}</tr></thead>
          <tbody>${facRows}</tbody>
        </table></div>
        <div style="position:relative;height:240px;"><canvas id="${facChartId}"></canvas></div>
      </div>
    </div>`;
  }

  // ---- 6. MATURITY PROFILE COMPARISON ----
  const matChartId = 'comp-chart-maturity-' + Date.now();
  const now = new Date();
  const matBands = ['0-6m', '6-12m', '1-2yr', '2-3yr', '3-5yr', '5yr+'];
  const matBandData = seriesData.map(d => {
    const bands = { '0-6m': 0, '6-12m': 0, '1-2yr': 0, '2-3yr': 0, '3-5yr': 0, '5yr+': 0 };
    d.loans.forEach(l => {
      let remMonths = l.remaining_term || 0;
      if (!remMonths) {
        const mat = parseDate(l.maturity_date);
        remMonths = mat ? Math.max(0, (mat - now) / (30.44 * 86400000)) : 0;
      }
      const band = remMonths <= 6 ? '0-6m' : remMonths <= 12 ? '6-12m' : remMonths <= 24 ? '1-2yr' : remMonths <= 36 ? '2-3yr' : remMonths <= 60 ? '3-5yr' : '5yr+';
      bands[band] += l.outstanding_balance;
    });
    return bands;
  });

  let matRows = matBands.map(band => {
    const cells = seriesData.map((d, i) => {
      const bal = matBandData[i][band];
      const pct = d.outstanding > 0 ? ((bal / d.outstanding) * 100).toFixed(1) : '0.0';
      return `<td class="mono right">${pct}%</td>`;
    }).join('');
    return `<tr><td style="font-size:12px;">${band}</td>${cells}</tr>`;
  }).join('');

  html += `<div class="card" style="margin-bottom:16px;">
    <h3 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">Original Term</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
      <div class="table-scroll"><table>
        <thead><tr><th>Band</th>${seriesData.map(d => `<th class="right">${escapeHtml(d.name)}</th>`).join('')}</tr></thead>
        <tbody>${matRows}</tbody>
      </table></div>
      <div style="position:relative;height:220px;"><canvas id="${matChartId}"></canvas></div>
    </div>
  </div>`;

  // ---- 7. INTEREST RATE DISTRIBUTION ----
  const rateChartId = 'comp-chart-rate-' + Date.now();
  const rateBands = ['0-2%', '2-4%', '4-6%', '6-8%', '8-10%', '10%+'];
  const rateBandData = seriesData.map(d => {
    const bands = { '0-2%': 0, '2-4%': 0, '4-6%': 0, '6-8%': 0, '8-10%': 0, '10%+': 0 };
    d.loans.forEach(l => {
      const r = l.interest_rate;
      const band = r <= 2 ? '0-2%' : r <= 4 ? '2-4%' : r <= 6 ? '4-6%' : r <= 8 ? '6-8%' : r <= 10 ? '8-10%' : '10%+';
      bands[band] += l.outstanding_balance;
    });
    return bands;
  });
  const hasRateData = seriesData.some(d => d.loans.some(l => l.interest_rate > 0));

  if (hasRateData) {
    let rateRows = rateBands.map(band => {
      const cells = seriesData.map((d, i) => {
        const bal = rateBandData[i][band];
        const pct = d.outstanding > 0 ? ((bal / d.outstanding) * 100).toFixed(1) : '0.0';
        return `<td class="mono right">${pct}%</td>`;
      }).join('');
      return `<tr><td style="font-size:12px;">${band}</td>${cells}</tr>`;
    }).join('');

    html += `<div class="card" style="margin-bottom:16px;">
      <h3 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">Interest Rate Distribution</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
        <div class="table-scroll"><table>
          <thead><tr><th>Band</th>${seriesData.map(d => `<th class="right">${escapeHtml(d.name)}</th>`).join('')}</tr></thead>
          <tbody>${rateRows}</tbody>
        </table></div>
        <div style="position:relative;height:220px;"><canvas id="${rateChartId}"></canvas></div>
      </div>
    </div>`;
  }

  container.innerHTML = html;

  // ---- RENDER CHARTS ----
  const seriesColors = COLORS.slice(0, seriesData.length);

  // Size distribution chart — grouped bar
  const sizeCtx = document.getElementById(sizeChartId);
  if (sizeCtx) {
    comparisonCharts.size = new Chart(sizeCtx, {
      type: 'bar',
      data: {
        labels: sizeBandLabels,
        datasets: seriesData.map((d, i) => ({
          label: d.name,
          data: sizeBandLabels.map(band => d.outstanding > 0 ? ((d.sizeBands[band] / d.outstanding) * 100) : 0),
          backgroundColor: seriesColors[i], borderRadius: 2, borderWidth: 0
        }))
      },
      options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: true, labels: { boxWidth: 8, font: { size: 10 } } }, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%' } } }, scales: { x: { ticks: { color: '#4a5068', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: '#8890a0', callback: v => v + '%', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true } } }
    });
  }

  // Sector chart — horizontal grouped bar (top 8 sectors)
  const secCtx = document.getElementById(sectorChartId);
  if (secCtx && sectorNames.length > 0) {
    const sectorTotals2 = {};
    sectorNames.forEach(sec => {
      sectorTotals2[sec] = seriesData.reduce((sm, d) => sm + d.loans.filter(l => l.sector === sec).reduce((s, l) => s + l.outstanding_balance, 0), 0);
    });
    const chartSectors = Object.entries(sectorTotals2).sort((a, b) => b[1] - a[1]).slice(0, 8).map(e => e[0]);
    comparisonCharts.sector = new Chart(secCtx, {
      type: 'bar',
      data: {
        labels: chartSectors.map(s => s.length > 20 ? s.slice(0, 18) + '..' : s),
        datasets: seriesData.map((d, i) => ({
          label: d.name,
          data: chartSectors.map(sec => {
            const bal = d.loans.filter(l => l.sector === sec).reduce((sm, l) => sm + l.outstanding_balance, 0);
            return d.outstanding > 0 ? ((bal / d.outstanding) * 100) : 0;
          }),
          backgroundColor: seriesColors[i], borderRadius: 2, borderWidth: 0
        }))
      },
      options: { indexAxis: 'y', ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: true, labels: { boxWidth: 8, font: { size: 10 } } }, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%' } } }, scales: { x: { ticks: { color: '#8890a0', callback: v => v + '%', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true }, y: { ticks: { color: '#4a5068', font: { size: 10 } }, grid: { display: false } } } }
    });
  }

  // Arrears chart — stacked bar
  const arrCtx = document.getElementById(arrearsChartId);
  if (arrCtx) {
    const arrColors = ['#e0e4e8', '#b58900', '#e67e22', '#e74c3c', '#8b0000'];
    comparisonCharts.arrears = new Chart(arrCtx, {
      type: 'bar',
      data: {
        labels: seriesData.map(d => d.name),
        datasets: arrearsBands.map((band, i) => ({
          label: band,
          data: seriesData.map(d => {
            let bal;
            if (i === 0) bal = d.outstanding - d.arr30Bal - d.arr60Bal - d.arr90Bal - d.arr90PlusBal;
            else if (i === 1) bal = d.arr30Bal;
            else if (i === 2) bal = d.arr60Bal;
            else if (i === 3) bal = d.arr90Bal;
            else bal = d.arr90PlusBal;
            return d.outstanding > 0 ? ((Math.max(0, bal) / d.outstanding) * 100) : 0;
          }),
          backgroundColor: arrColors[i], borderWidth: 0, borderRadius: i === arrearsBands.length - 1 ? 2 : 0
        }))
      },
      options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: true, labels: { boxWidth: 8, font: { size: 10 } } }, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%' } } }, scales: { x: { stacked: true, ticks: { color: '#4a5068', font: { size: 11 } }, grid: { display: false } }, y: { stacked: true, ticks: { color: '#8890a0', callback: v => v + '%', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, max: 100 } } }
    });
  }

  // Maturity chart — grouped bar
  const matCtx = document.getElementById(matChartId);
  if (matCtx) {
    comparisonCharts.maturity = new Chart(matCtx, {
      type: 'bar',
      data: {
        labels: matBands,
        datasets: seriesData.map((d, i) => ({
          label: d.name,
          data: matBands.map(band => d.outstanding > 0 ? ((matBandData[i][band] / d.outstanding) * 100) : 0),
          backgroundColor: seriesColors[i], borderRadius: 2, borderWidth: 0
        }))
      },
      options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: true, labels: { boxWidth: 8, font: { size: 10 } } }, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%' } } }, scales: { x: { ticks: { color: '#4a5068', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: '#8890a0', callback: v => v + '%', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true } } }
    });
  }

  // Rate distribution chart — grouped bar
  const rateCtx = document.getElementById(rateChartId);
  if (rateCtx && hasRateData) {
    comparisonCharts.rate = new Chart(rateCtx, {
      type: 'bar',
      data: {
        labels: rateBands,
        datasets: seriesData.map((d, i) => ({
          label: d.name,
          data: rateBands.map(band => d.outstanding > 0 ? ((rateBandData[i][band] / d.outstanding) * 100) : 0),
          backgroundColor: seriesColors[i], borderRadius: 2, borderWidth: 0
        }))
      },
      options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: true, labels: { boxWidth: 8, font: { size: 10 } } }, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%' } } }, scales: { x: { ticks: { color: '#4a5068', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: '#8890a0', callback: v => v + '%', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true } } }
    });
  }

  // Facility type chart — horizontal grouped bar
  const facCtx = document.getElementById(facChartId);
  if (facCtx && hasFacility && topFacilities.length > 0) {
    comparisonCharts.facility = new Chart(facCtx, {
      type: 'bar',
      data: {
        labels: topFacilities.map(f => f.length > 20 ? f.slice(0, 18) + '..' : f),
        datasets: seriesData.map((d, i) => ({
          label: d.name,
          data: topFacilities.map(f => {
            const bal = d.loans.filter(l => l.facility_type === f).reduce((sm, l) => sm + l.outstanding_balance, 0);
            return d.outstanding > 0 ? ((bal / d.outstanding) * 100) : 0;
          }),
          backgroundColor: seriesColors[i], borderRadius: 2, borderWidth: 0
        }))
      },
      options: { indexAxis: 'y', ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: true, labels: { boxWidth: 8, font: { size: 10 } } }, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%' } } }, scales: { x: { ticks: { color: '#8890a0', callback: v => v + '%', font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true }, y: { ticks: { color: '#4a5068', font: { size: 10 } }, grid: { display: false } } } }
    });
  }
}

function renderDashboard() {
  document.getElementById('upload-section').style.display = 'none';
  document.getElementById('dashboard').classList.add('active');
  updateNav('dashboard');
  refreshLoansFromTapes();
  renderSeriesBar();
  renderCutoffBanner();
  renderStats();
  renderOverviewWidgets();
  renderCharts();
  renderStratification();
  renderAnomalies();
  renderComparison();
  renderDataTable();
}

// ============================================================
//  SERIES MANAGEMENT
// ============================================================
function refreshLoansFromTapes() {
  if (tapes.length === 0) return;
  if (activeSeries === 'all') {
    loans = [];
    tapes.forEach(t => loans.push(...t.loans));
  } else {
    const filtered = tapes.filter(t => t.series === activeSeries);
    loans = [];
    filtered.forEach(t => loans.push(...t.loans));
  }
}

function renderSeriesBar() {
  const bar = document.getElementById('series-bar');
  if (tapes.length <= 1) { bar.style.display = 'none'; return; }
  bar.style.display = '';
  const pills = document.getElementById('series-pills');
  const seriesNames = [...new Set(tapes.map(t => t.series))];
  let html = `<button class="series-pill ${activeSeries === 'all' ? 'active' : ''}" onclick="switchSeries('all')">All<span class="pill-count">(${tapes.reduce((s, t) => s + t.loans.length, 0)})</span></button>`;
  seriesNames.forEach((s, i) => {
    const count = tapes.filter(t => t.series === s).reduce((n, t) => n + t.loans.length, 0);
    const tape = tapes.find(t => t.series === s);
    const cutoff = tape && tape.cutoffDate ? tape.cutoffDate : '';
    const orig = tape && tape.originator ? tape.originator : '';
    const cutoffLabel = cutoff ? `<span class="pill-cutoff">${formatCutoffDate(cutoff)}</span>` : '';
    const origLabel = orig ? `<span class="pill-cutoff">${escapeHtml(orig)}</span>` : '';
    const safeS = s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    html += `<button class="series-pill ${activeSeries === s ? 'active' : ''}" onclick="switchSeries('${safeS}')">${escapeHtml(s)}<span class="pill-count">(${count})</span>${origLabel}${cutoffLabel}</button>`;
  });
  pills.innerHTML = html;
}

function formatCutoffDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00');
  if (isNaN(d.getTime())) return dateStr;
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

function getActiveTapeMeta() {
  const filtered = activeSeries === 'all' ? tapes : tapes.filter(t => t.series === activeSeries);
  return filtered.map(t => ({ series: t.series, cutoffDate: t.cutoffDate || '', originator: t.originator || '' }));
}

function switchSeries(series) {
  activeSeries = series;
  renderDashboard();
}

function addAnotherTape() {
  document.getElementById('upload-section').style.display = '';
  document.getElementById('dashboard').classList.remove('active');
  updateNav('home');
}

// ============================================================
//  STATS — dynamically generated
// ============================================================
function computeStats() {
  const totalOriginal = loans.reduce((s, l) => s + l.loan_amount, 0);
  const totalOutstanding = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const utilisation = totalOriginal > 0 ? (totalOutstanding / totalOriginal) * 100 : 0;
  const wair = totalOutstanding > 0
    ? loans.reduce((s, l) => s + l.interest_rate * l.outstanding_balance, 0) / totalOutstanding : 0;
  const hasRemTerm = loans.some(l => l.remaining_term > 0);
  let waRem = 0;
  if (hasRemTerm && totalOutstanding > 0) {
    waRem = loans.reduce((s, l) => s + l.remaining_term * l.outstanding_balance, 0) / totalOutstanding;
  } else {
    const now = new Date();
    waRem = totalOutstanding > 0
      ? loans.reduce((s, l) => {
          const mat = parseDate(l.maturity_date);
          const mo = mat ? Math.max(0, (mat - now) / (30.44 * 86400000)) : 0;
          return s + mo * l.outstanding_balance;
        }, 0) / totalOutstanding : 0;
  }
  const waOrigTerm = totalOutstanding > 0 ? loans.reduce((s, l) => s + (l.original_term || 0) * l.outstanding_balance, 0) / totalOutstanding : 0;
  const waSeasoning = waOrigTerm > 0 && waRem > 0 ? waOrigTerm - waRem : 0;
  const currentFactor = totalOriginal > 0 ? (totalOutstanding / totalOriginal) : 0;
  const arrears90 = loans.filter(l => l.days_in_arrears > 90);
  const arrears90Bal = arrears90.reduce((s, l) => s + l.outstanding_balance, 0);
  const arrears90Pct = totalOutstanding > 0 ? (arrears90Bal / totalOutstanding) * 100 : 0;
  const uniqueBorrowers = new Set(loans.map(l => l.borrower_name)).size;
  const avgFacility = loans.length > 0 ? totalOriginal / loans.length : 0;
  const defaultCount = loans.filter(l => l.default_flag).length;
  const defaultPct = loans.length > 0 ? (defaultCount / loans.length) * 100 : 0;
  return { totalOriginal, totalOutstanding, utilisation, wair, waRem, waOrigTerm, waSeasoning, currentFactor, hasRemTerm, arrears90, arrears90Bal, arrears90Pct, uniqueBorrowers, avgFacility, defaultCount, defaultPct };
}

function renderStats() {
  const s = computeStats();
  const container = document.getElementById('stat-grid-container');
  if (!displaySettings.overviewWidgets.includes('stats')) { container.innerHTML = ''; return; }
  container.innerHTML = `
    <div class="card stat-card">
      <div class="stat-label">Original Amount</div>
      <div class="stat-value">${fmtM(s.totalOriginal)}</div>
      <div class="stat-sub">${loans.length.toLocaleString()} receivables</div>
    </div>
    <div class="card stat-card">
      <div class="stat-label">Current Outstanding</div>
      <div class="stat-value">${fmtM(s.totalOutstanding)}</div>
      <div class="stat-sub">Factor: ${(s.currentFactor * 100).toFixed(1)}%</div>
    </div>
    <div class="card stat-card">
      <div class="stat-label">WA Interest Rate</div>
      <div class="stat-value">${fmtPct(s.wair)}</div>
      <div class="stat-sub">Balance-weighted</div>
    </div>
    <div class="card stat-card">
      <div class="stat-label">WA Rem. Term</div>
      <div class="stat-value">${convertTerm(s.waRem, displaySettings.termUnit)}</div>
      <div class="stat-sub">${s.waSeasoning > 0 ? 'Seasoning: ' + convertTerm(s.waSeasoning, displaySettings.termUnit) : (s.hasRemTerm ? 'Balance-weighted' : 'From maturity dates')}</div>
    </div>
    <div class="card stat-card">
      <div class="stat-label">90+ DPD</div>
      <div class="stat-value" style="color:${s.arrears90Pct > 5 ? 'var(--red)' : s.arrears90Pct > 2 ? 'var(--amber)' : 'var(--green)'}">${fmtPct(s.arrears90Pct)}</div>
      <div class="stat-sub">${s.arrears90.length} receivables (${fmtM(s.arrears90Bal)})</div>
    </div>
    <div class="card stat-card">
      <div class="stat-label">Unique Borrowers</div>
      <div class="stat-value">${s.uniqueBorrowers.toLocaleString()}</div>
      <div class="stat-sub">Avg facility: ${fmtM(s.avgFacility)}</div>
    </div>
  `;
}

// ============================================================
//  TOP EXPOSURES (returns HTML string)
// ============================================================
function getTopExposuresData() {
  const totalOutstanding = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const lesseeMap = {};
  loans.forEach(l => {
    const name = l.borrower_name || '(unknown)';
    if (!lesseeMap[name]) lesseeMap[name] = { name, totalBal: 0, loanCount: 0, sectors: new Set(), ratings: new Set(), loansInArrears: 0, totalArrearsBal: 0, maxArrearsDays: 0 };
    const entry = lesseeMap[name];
    entry.totalBal += l.outstanding_balance;
    entry.loanCount++;
    if (l.sector) entry.sectors.add(l.sector);
    if (l.credit_rating) entry.ratings.add(l.credit_rating);
    if (l.days_in_arrears > 0) {
      entry.loansInArrears++;
      entry.totalArrearsBal += l.outstanding_balance;
      entry.maxArrearsDays = Math.max(entry.maxArrearsDays, l.days_in_arrears);
    }
  });
  const topX = displaySettings.topObligorCount || 10;
  return { totalOutstanding, sorted: Object.values(lesseeMap).sort((a, b) => b.totalBal - a.totalBal).slice(0, topX) };
}

function buildTopExposuresHtml() {
  const totalOutstanding = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const lesseeMap = {};
  loans.forEach(l => {
    const name = l.borrower_name || '(unknown)';
    if (!lesseeMap[name]) lesseeMap[name] = { name, totalBal: 0, loanCount: 0, sectors: new Set(), ratings: new Set(), loansInArrears: 0, maxArrearsDays: 0 };
    const entry = lesseeMap[name];
    entry.totalBal += l.outstanding_balance;
    entry.loanCount++;
    if (l.sector) entry.sectors.add(l.sector);
    if (l.credit_rating) entry.ratings.add(l.credit_rating);
    if (l.days_in_arrears > 0) { entry.loansInArrears++; entry.maxArrearsDays = Math.max(entry.maxArrearsDays, l.days_in_arrears); }
  });
  const allSorted = Object.values(lesseeMap).sort((a, b) => b.totalBal - a.totalBal);
  const top10 = allSorted.slice(0, 10);
  // Cumulative concentrations
  const cumTop5 = totalOutstanding > 0 ? (allSorted.slice(0, 5).reduce((s, e) => s + e.totalBal, 0) / totalOutstanding * 100) : 0;
  const cumTop10 = totalOutstanding > 0 ? (allSorted.slice(0, 10).reduce((s, e) => s + e.totalBal, 0) / totalOutstanding * 100) : 0;
  const cumTop20 = totalOutstanding > 0 ? (allSorted.slice(0, 20).reduce((s, e) => s + e.totalBal, 0) / totalOutstanding * 100) : 0;

  const rows = top10.map((e, i) => {
    const pct = totalOutstanding > 0 ? ((e.totalBal / totalOutstanding) * 100).toFixed(2) : '0.00';
    const cumPct = totalOutstanding > 0 ? ((allSorted.slice(0, i + 1).reduce((s, x) => s + x.totalBal, 0) / totalOutstanding) * 100).toFixed(1) : '0.0';
    let arrearsLabel, arrearsText;
    if (e.loansInArrears === 0) { arrearsLabel = 'badge-green'; arrearsText = 'Current'; }
    else { arrearsLabel = e.maxArrearsDays > 90 ? 'badge-red' : 'badge-amber'; arrearsText = e.loansInArrears + '/' + e.loanCount + ' (' + e.maxArrearsDays + 'd)'; }
    const sectorText = [...e.sectors].slice(0, 2).join(', ') + (e.sectors.size > 2 ? '...' : '');
    return `<tr>
      <td>${i + 1}</td>
      <td>${escapeHtml(e.name)}<span style="font-size:11px;color:var(--text-muted);margin-left:4px;">(${e.loanCount})</span></td>
      <td>${escapeHtml(sectorText)}</td>
      <td class="mono right">${fmtFull(e.totalBal)}</td>
      <td class="mono right">${pct}%</td>
      <td class="mono right">${cumPct}%</td>
      <td><span class="badge ${arrearsLabel}">${arrearsText}</span></td>
    </tr>`;
  }).join('');

  return `<div class="card table-card">
    <div class="table-header">
      <h3>Top 10 Lessee Exposures</h3>
      <div style="display:flex;align-items:center;gap:12px;">
        <span class="badge badge-navy" style="font-size:11px;">Top 5: ${cumTop5.toFixed(1)}%</span>
        <span class="badge badge-navy" style="font-size:11px;">Top 10: ${cumTop10.toFixed(1)}%</span>
        <span class="badge badge-navy" style="font-size:11px;">Top 20: ${cumTop20.toFixed(1)}%</span>
      </div>
    </div>
    <div class="table-scroll"><table class="ow-exposures-table">
      <thead><tr><th>#</th><th>Lessee</th><th>Sector</th><th class="right">Balance</th><th class="right">% Port</th><th class="right">Cum %</th><th>Arrears</th></tr></thead>
      <tbody>${rows}</tbody>
    </table></div>
  </div>`;
}

// ============================================================
//  OVERVIEW WIDGETS — configurable
// ============================================================
let overviewCharts = {};
function destroyOverviewCharts() { Object.values(overviewCharts).forEach(c => c.destroy()); overviewCharts = {}; }

function buildTrendsTable() {
  if (tapes.length < 2) return '';
  // Sort tapes by cutoff date, then by index
  const sorted = [...tapes].sort((a, b) => {
    if (a.cutoffDate && b.cutoffDate) return a.cutoffDate.localeCompare(b.cutoffDate);
    if (a.cutoffDate) return -1;
    if (b.cutoffDate) return 1;
    return 0;
  });
  const rows = sorted.map(t => {
    const tl = t.loans;
    const totOrig = tl.reduce((s, l) => s + l.loan_amount, 0);
    const totOut = tl.reduce((s, l) => s + l.outstanding_balance, 0);
    const waRate = totOut > 0 ? tl.reduce((s, l) => s + l.interest_rate * l.outstanding_balance, 0) / totOut : 0;
    const arr90 = tl.filter(l => l.days_in_arrears > 90);
    const arr90Pct = totOut > 0 ? (arr90.reduce((s, l) => s + l.outstanding_balance, 0) / totOut * 100) : 0;
    const defPct = tl.length > 0 ? (tl.filter(l => l.default_flag).length / tl.length * 100) : 0;
    const cutoff = t.cutoffDate ? formatCutoffDate(t.cutoffDate) : '-';
    const orig = t.originator || '-';
    return `<tr>
      <td>${escapeHtml(t.series)}</td>
      <td class="mono">${cutoff}</td>
      <td class="mono">${escapeHtml(orig)}</td>
      <td class="mono right">${tl.length}</td>
      <td class="mono right">${fmtM(totOrig)}</td>
      <td class="mono right">${fmtM(totOut)}</td>
      <td class="mono right">${fmtPct(waRate)}</td>
      <td class="mono right" style="color:${arr90Pct > 5 ? 'var(--red)' : arr90Pct > 2 ? 'var(--amber)' : 'var(--green)'}">${arr90Pct.toFixed(1)}%</td>
      <td class="mono right" style="color:${defPct > 3 ? 'var(--red)' : defPct > 1 ? 'var(--amber)' : 'var(--green)'}">${defPct.toFixed(1)}%</td>
    </tr>`;
  });
  return `<table>
    <thead><tr><th>Series</th><th>Cut-Off</th><th>Originator</th><th class="right">#</th><th class="right">Original</th><th class="right">Outstanding</th><th class="right">WA Rate</th><th class="right">90+ Arr</th><th class="right">Default</th></tr></thead>
    <tbody>${rows.join('')}</tbody>
  </table>`;
}

function buildAmortProfile() {
  // French (constant payment) amortisation: PMT = PV * r / (1 - (1+r)^-n)
  // Aggregate across all loans; project monthly from cut-off date
  const totalBal = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  if (totalBal === 0) return { labels: [], balances: [], cumPrincipal: [] };

  const totWBal = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const waRate = totWBal > 0 ? loans.reduce((s, l) => s + l.interest_rate * l.outstanding_balance, 0) / totWBal : 5;
  const waRemTerm = totWBal > 0 ? loans.reduce((s, l) => s + (l.remaining_term || 0) * l.outstanding_balance, 0) / totWBal : 36;
  const remMonths = Math.max(6, Math.round(waRemTerm));
  const r = (waRate / 100) / 12; // monthly rate

  const labels = [];
  const balances = [];
  const cumPrincipal = [];
  let bal = totalBal;
  let cumPrin = 0;

  // Calculate PMT
  let pmt;
  if (r > 0) {
    pmt = bal * r / (1 - Math.pow(1 + r, -remMonths));
  } else {
    pmt = bal / remMonths;
  }

  // Quarter-by-quarter projection for readability
  const stepSize = remMonths <= 24 ? 1 : remMonths <= 60 ? 3 : 6;
  for (let m = 0; m <= remMonths; m++) {
    if (m % stepSize === 0 || m === remMonths) {
      const label = m === 0 ? 'Now' : m + 'm';
      labels.push(label);
      balances.push(Math.max(0, Math.round(bal)));
      cumPrincipal.push(Math.round(cumPrin));
    }
    if (m < remMonths && bal > 0) {
      const interest = bal * r;
      const principal = Math.min(pmt - interest, bal);
      bal -= principal;
      cumPrin += principal;
    }
  }
  return { labels, balances, cumPrincipal };
}

function buildSeriesComparisonHtml() {
  if (tapes.length < 2) return '';
  const seriesNames = [...new Set(tapes.map(t => t.series))];
  if (seriesNames.length < 2) return '';

  // Compute metrics per series
  const seriesData = seriesNames.map(s => {
    const sloans = [];
    tapes.filter(t => t.series === s).forEach(t => sloans.push(...t.loans));
    const tape = tapes.find(t => t.series === s);
    const tot = sloans.reduce((sum, l) => sum + l.outstanding_balance, 0);
    const orig = sloans.reduce((sum, l) => sum + l.loan_amount, 0);
    const waRate = tot > 0 ? sloans.reduce((sum, l) => sum + l.interest_rate * l.outstanding_balance, 0) / tot : 0;
    const waRemTerm = tot > 0 ? sloans.reduce((sum, l) => sum + (l.remaining_term || 0) * l.outstanding_balance, 0) / tot : 0;
    const arrBal = sloans.filter(l => l.days_in_arrears > 0).reduce((sum, l) => sum + l.outstanding_balance, 0);
    const arrPct = tot > 0 ? (arrBal / tot) * 100 : 0;
    const arr90Bal = sloans.filter(l => l.days_in_arrears > 90).reduce((sum, l) => sum + l.outstanding_balance, 0);
    const arr90Pct = tot > 0 ? (arr90Bal / tot) * 100 : 0;
    const defPct = sloans.length > 0 ? (sloans.filter(l => l.default_flag).length / sloans.length * 100) : 0;
    const uniqueB = new Set(sloans.map(l => l.borrower_name)).size;
    const avgFac = sloans.length > 0 ? orig / sloans.length : 0;
    const bMap = {};
    sloans.forEach(l => { bMap[l.borrower_name] = (bMap[l.borrower_name] || 0) + l.outstanding_balance; });
    const top5Vals = Object.values(bMap).sort((a, b) => b - a).slice(0, 5);
    const top5Pct = tot > 0 ? (top5Vals.reduce((sum, v) => sum + v, 0) / tot * 100) : 0;
    return { name: s, count: sloans.length, originator: tape ? tape.originator || '' : '', cutoff: tape ? tape.cutoffDate || '' : '', outstanding: tot, original: orig, waRate, waRemTerm, arrPct, arr90Pct, defPct, uniqueB, avgFac, top5Pct };
  });

  const metrics = [
    { label: 'Receivables', fn: d => d.count, fmt: v => v.toLocaleString() },
    { label: 'Outstanding', fn: d => d.outstanding, fmt: v => fmtM(v) },
    { label: 'Original', fn: d => d.original, fmt: v => fmtM(v) },
    { label: 'WA Rate', fn: d => d.waRate, fmt: v => fmtPct(v) },
    { label: 'WA Rem. Term', fn: d => d.waRemTerm, fmt: v => v.toFixed(1) + 'm' },
    { label: 'Arrears %', fn: d => d.arrPct, fmt: v => fmtPct(v), warn: v => v > 5 ? 'var(--red)' : v > 2 ? 'var(--amber)' : 'var(--green)' },
    { label: '90+ Arrears %', fn: d => d.arr90Pct, fmt: v => fmtPct(v), warn: v => v > 5 ? 'var(--red)' : v > 2 ? 'var(--amber)' : 'var(--green)' },
    { label: 'Default %', fn: d => d.defPct, fmt: v => fmtPct(v), warn: v => v > 3 ? 'var(--red)' : v > 1 ? 'var(--amber)' : 'var(--green)' },
    { label: 'Borrowers', fn: d => d.uniqueB, fmt: v => v.toLocaleString() },
    { label: 'Avg Facility', fn: d => d.avgFac, fmt: v => fmtM(v) },
    { label: 'Top 5 Conc.', fn: d => d.top5Pct, fmt: v => v.toFixed(1) + '%', warn: v => v > 40 ? 'var(--red)' : v > 25 ? 'var(--amber)' : 'var(--green)' }
  ];

  const headerCells = seriesData.map(d => `<th class="right" style="min-width:100px;">${escapeHtml(d.name)}</th>`).join('');
  const rows = metrics.map(m => {
    const cells = seriesData.map(d => {
      const v = m.fn(d);
      const color = m.warn ? m.warn(v) : '';
      return `<td class="mono right" ${color ? 'style="color:'+color+'"' : ''}>${m.fmt(v)}</td>`;
    }).join('');
    return `<tr><td style="font-weight:500;">${m.label}</td>${cells}</tr>`;
  }).join('');

  return `<div class="card ow-card" style="grid-column:1/-1;">
    <h3>Series Comparison</h3>
    <div class="table-scroll"><table>
      <thead><tr><th>Metric</th>${headerCells}</tr></thead>
      <tbody>${rows}</tbody>
    </table></div>
  </div>`;
}

function renderOverviewWidgets() {
  destroyOverviewCharts();
  const container = document.getElementById('overview-widgets');
  const active = displaySettings.overviewWidgets;
  let html = '<div class="ow-grid">';

  // KEY RISKS widget (replaces health score)
  if (active.includes('keyRisks')) {
    const st = computeStats();
    const tot = st.totalOutstanding;
    const arrearsBal = loans.filter(l => l.days_in_arrears > 0).reduce((s, l) => s + l.outstanding_balance, 0);
    const arrearsPct = tot > 0 ? (arrearsBal / tot) * 100 : 0;
    const defaultBal = loans.filter(l => l.default_flag).reduce((s, l) => s + l.outstanding_balance, 0);
    const defaultPct = tot > 0 ? (defaultBal / tot) * 100 : 0;
    const topX = displaySettings.topObligorCount || 10;
    const concentrationTopN = (() => {
      const bMap = {};
      loans.forEach(l => { bMap[l.borrower_name] = (bMap[l.borrower_name] || 0) + l.outstanding_balance; });
      const topN = Object.values(bMap).sort((a, b) => b - a).slice(0, 5);
      return tot > 0 ? (topN.reduce((s, v) => s + v, 0) / tot) * 100 : 0;
    })();
    const singleNameMax = (() => {
      const bMap = {};
      loans.forEach(l => { bMap[l.borrower_name] = (bMap[l.borrower_name] || 0) + l.outstanding_balance; });
      const max = Math.max(...Object.values(bMap), 0);
      return tot > 0 ? (max / tot) * 100 : 0;
    })();
    html += `<div class="card ow-card">
      <h3>Key Risk Metrics</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="padding:10px;background:var(--bg);border-radius:var(--radius);">
          <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.04em;">Arrears (% Bal)</div>
          <div style="font-size:1.4rem;font-weight:700;font-family:var(--mono);color:${arrearsPct > 5 ? 'var(--red)' : arrearsPct > 2 ? 'var(--amber)' : 'var(--green)'}">${fmtPct(arrearsPct)}</div>
          <div style="font-size:11px;color:var(--text-muted);">${fmtM(arrearsBal)} across ${loans.filter(l => l.days_in_arrears > 0).length} loans</div>
        </div>
        <div style="padding:10px;background:var(--bg);border-radius:var(--radius);">
          <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.04em;">Default Rate</div>
          <div style="font-size:1.4rem;font-weight:700;font-family:var(--mono);color:${defaultPct > 3 ? 'var(--red)' : defaultPct > 1 ? 'var(--amber)' : 'var(--green)'}">${fmtPct(defaultPct)}</div>
          <div style="font-size:11px;color:var(--text-muted);">${fmtM(defaultBal)} across ${loans.filter(l => l.default_flag).length} loans</div>
        </div>
        <div style="padding:10px;background:var(--bg);border-radius:var(--radius);">
          <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.04em;">Top 5 Concentration</div>
          <div style="font-size:1.4rem;font-weight:700;font-family:var(--mono);color:${concentrationTopN > 40 ? 'var(--red)' : concentrationTopN > 25 ? 'var(--amber)' : 'var(--green)'}">${concentrationTopN.toFixed(1)}%</div>
          <div style="font-size:11px;color:var(--text-muted);">of outstanding balance</div>
        </div>
        <div style="padding:10px;background:var(--bg);border-radius:var(--radius);">
          <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.04em;">Largest Obligor</div>
          <div style="font-size:1.4rem;font-weight:700;font-family:var(--mono);color:${singleNameMax > 10 ? 'var(--red)' : singleNameMax > 5 ? 'var(--amber)' : 'var(--green)'}">${singleNameMax.toFixed(1)}%</div>
          <div style="font-size:11px;color:var(--text-muted);">single-name exposure</div>
        </div>
      </div>
    </div>`;
  }

  // ARREARS SNAPSHOT widget
  if (active.includes('arrearsSnapshot')) {
    const tot = loans.reduce((s, l) => s + l.outstanding_balance, 0);
    const buckets = [
      { label: 'Current', filter: l => l.days_in_arrears === 0, bg: 'var(--green-faint)', color: 'var(--green)' },
      { label: '1-30d', filter: l => l.days_in_arrears > 0 && l.days_in_arrears <= 30, bg: 'var(--navy-faint)', color: 'var(--navy)' },
      { label: '31-60d', filter: l => l.days_in_arrears > 30 && l.days_in_arrears <= 60, bg: 'var(--amber-faint)', color: 'var(--amber)' },
      { label: '61-90d', filter: l => l.days_in_arrears > 60 && l.days_in_arrears <= 90, bg: 'var(--amber-faint)', color: 'var(--amber)' },
      { label: '90d+', filter: l => l.days_in_arrears > 90, bg: 'var(--red-faint)', color: 'var(--red)' }
    ];
    html += `<div class="card ow-card"><h3>Arrears Snapshot</h3><div class="arrears-grid">`;
    buckets.forEach(b => {
      const matched = loans.filter(b.filter);
      const bal = matched.reduce((s, l) => s + l.outstanding_balance, 0);
      const pct = tot > 0 ? ((bal / tot) * 100).toFixed(1) : '0.0';
      html += `<div class="arrears-bucket" style="background:${b.bg};">
        <div class="arrears-bucket-val" style="color:${b.color};">${matched.length}</div>
        <div class="arrears-bucket-label">${b.label}</div>
        <div class="arrears-bucket-pct">${pct}%</div>
      </div>`;
    });
    html += `</div></div>`;
  }

  // TOP EXPOSURES widget
  if (active.includes('topExposures')) {
    html += buildTopExposuresHtml();
  }

  // FACILITY MIX widget — with count and balance
  if (active.includes('facilityMix') && loans.some(l => l.facility_type)) {
    const facGroups = {};
    loans.forEach(l => {
      const ft = l.facility_type || '(blank)';
      if (ft === '(blank)') return;
      if (!facGroups[ft]) facGroups[ft] = { count: 0, balance: 0 };
      facGroups[ft].count++;
      facGroups[ft].balance += l.outstanding_balance;
    });
    const facTotal = loans.reduce((s, l) => s + l.outstanding_balance, 0);
    const facSorted = Object.entries(facGroups).sort((a, b) => b[1].balance - a[1].balance);
    let facTableRows = facSorted.map(([name, d]) => {
      const pctBal = facTotal > 0 ? ((d.balance / facTotal) * 100).toFixed(1) : '0.0';
      return `<tr><td>${escapeHtml(name)}</td><td class="mono right">${d.count.toLocaleString()}</td><td class="mono right">${fmtM(d.balance)}</td><td class="mono right">${pctBal}%</td></tr>`;
    }).join('');
    html += `<div class="card ow-card"><h3>Facility Type Mix</h3>
      <div class="table-scroll" style="max-height:180px;"><table>
        <thead><tr><th>Type</th><th class="right"># Loans</th><th class="right">Balance</th><th class="right">% Bal</th></tr></thead>
        <tbody>${facTableRows}</tbody>
      </table></div>
      <div class="mini-chart-wrap" style="margin-top:8px;"><canvas id="ow-chart-facility"></canvas></div>
    </div>`;
  }

  // MATURITY PROFILE widget
  if (active.includes('maturityProfile')) {
    html += `<div class="card ow-card"><h3>Original Term</h3><div class="mini-chart-wrap"><canvas id="ow-chart-maturity"></canvas></div></div>`;
  }

  // ORIGINATION & MATURITY PROFILE widget
  if (active.includes('originationProfile')) {
    html += `<div class="card ow-card"><h3>Origination & Maturity Profile</h3><div style="display:flex;gap:12px;"><div style="flex:1;height:180px;"><canvas id="ow-chart-origination"></canvas></div><div style="flex:1;height:180px;"><canvas id="ow-chart-maturity-profile"></canvas></div></div></div>`;
  }

  // AMORTISATION PROFILE widget
  if (active.includes('amortProfile')) {
    html += `<div class="card ow-card"><h3>Amortisation Profile (French)</h3><div class="mini-chart-wrap" style="height:200px;"><canvas id="ow-chart-amort"></canvas></div><div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Projected based on current balance, WA rate, and remaining term using standard French (constant payment) amortisation.</div></div>`;
  }

  // SERIES COMPARISON widget (only if 2+ tapes)
  if (active.includes('seriesComparison') && tapes.length >= 2) {
    html += buildSeriesComparisonHtml();
  }

  // HISTORIC TRENDS widget (only if 2+ tapes)
  if (active.includes('trends') && tapes.length >= 2) {
    html += `<div class="card ow-card" style="grid-column:1/-1;">
      <h3>Historic Trends Across Series</h3>
      <div class="trends-table-wrap">${buildTrendsTable()}</div>
      <div style="display:flex;gap:12px;margin-top:12px;">
        <div style="flex:1;"><canvas id="ow-chart-trend-bal"></canvas></div>
        <div style="flex:1;"><canvas id="ow-chart-trend-rate"></canvas></div>
      </div>
    </div>`;
  }

  html += '</div>';
  container.innerHTML = html;

  // Render mini charts after DOM is updated
  setTimeout(() => {
    const miniChartOpts = {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { ...chartDefaults.plugins.tooltip, callbacks: { label: ctx => ctx.label + ': ' + fmtM(ctx.raw) } } },
      scales: { x: { ticks: { color: '#4a5068', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: '#8890a0', callback: v => fmtM(v), font: { size: 9, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true } }
    };

    if (active.includes('facilityMix') && document.getElementById('ow-chart-facility')) {
      const fMap = capChartData(groupBy(loans, 'facility_type', 'outstanding_balance', { excludeBlanks: true }), 8);
      overviewCharts.facility = new Chart(document.getElementById('ow-chart-facility'), {
        type: 'bar', data: { labels: Object.keys(fMap), datasets: [{ data: Object.values(fMap), backgroundColor: COLORS, borderRadius: 2, borderWidth: 0 }] },
        options: { ...miniChartOpts, indexAxis: 'y' }
      });
    }

    // Origination & maturity profile charts
    if (active.includes('originationProfile') && document.getElementById('ow-chart-origination')) {
      const origBuckets = {};
      const matBuckets = {};
      loans.forEach(l => {
        const od = parseDate(l.origination_date);
        if (od) { const y = String(od.getFullYear()); origBuckets[y] = (origBuckets[y] || 0) + l.outstanding_balance; }
        const md = parseDate(l.maturity_date);
        if (md) { const y = String(md.getFullYear()); matBuckets[y] = (matBuckets[y] || 0) + l.outstanding_balance; }
      });
      const origLabels = Object.keys(origBuckets).sort();
      const matLabels = Object.keys(matBuckets).sort();
      if (origLabels.length > 0) {
        overviewCharts.origination = new Chart(document.getElementById('ow-chart-origination'), {
          type: 'bar', data: { labels: origLabels, datasets: [{ label: 'Originated', data: origLabels.map(y => origBuckets[y] || 0), backgroundColor: '#003078', borderRadius: 2, borderWidth: 0 }] },
          options: { ...miniChartOpts, plugins: { ...miniChartOpts.plugins, title: { display: true, text: 'By Origination Year', font: { size: 11, weight: '600' }, color: '#4a5068', padding: { bottom: 4 } } } }
        });
      }
      if (matLabels.length > 0) {
        overviewCharts.maturityProfile = new Chart(document.getElementById('ow-chart-maturity-profile'), {
          type: 'bar', data: { labels: matLabels, datasets: [{ label: 'Maturing', data: matLabels.map(y => matBuckets[y] || 0), backgroundColor: '#00857c', borderRadius: 2, borderWidth: 0 }] },
          options: { ...miniChartOpts, plugins: { ...miniChartOpts.plugins, title: { display: true, text: 'By Maturity Year', font: { size: 11, weight: '600' }, color: '#4a5068', padding: { bottom: 4 } } } }
        });
      }
    }

    // Amortisation profile chart (French amortisation)
    if (active.includes('amortProfile') && document.getElementById('ow-chart-amort')) {
      const amortData = buildAmortProfile();
      if (amortData.labels.length > 0) {
        overviewCharts.amort = new Chart(document.getElementById('ow-chart-amort'), {
          type: 'line',
          data: {
            labels: amortData.labels,
            datasets: [
              { label: 'Outstanding Balance', data: amortData.balances, borderColor: '#003078', backgroundColor: 'rgba(0,48,120,0.06)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2 },
              { label: 'Cumulative Principal', data: amortData.cumPrincipal, borderColor: '#00857c', backgroundColor: 'rgba(0,133,124,0.06)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2 }
            ]
          },
          options: { ...miniChartOpts, plugins: { ...miniChartOpts.plugins, legend: { display: true, labels: { font: { size: 10 }, boxWidth: 8, padding: 6 } } }, scales: { ...miniChartOpts.scales, y: { ...miniChartOpts.scales.y, beginAtZero: true } } }
        });
      }
    }

    if (active.includes('maturityProfile') && document.getElementById('ow-chart-maturity')) {
      const now = new Date();
      const mBuckets = { '<1yr': 0, '1-2yr': 0, '2-3yr': 0, '3-5yr': 0, '5-7yr': 0, '7+yr': 0 };
      loans.forEach(l => {
        const mat = parseDate(l.maturity_date);
        const years = mat ? Math.max(0, (mat - now) / (365.25 * 86400000)) : 0;
        if (years < 1) mBuckets['<1yr'] += l.outstanding_balance;
        else if (years < 2) mBuckets['1-2yr'] += l.outstanding_balance;
        else if (years < 3) mBuckets['2-3yr'] += l.outstanding_balance;
        else if (years < 5) mBuckets['3-5yr'] += l.outstanding_balance;
        else if (years < 7) mBuckets['5-7yr'] += l.outstanding_balance;
        else mBuckets['7+yr'] += l.outstanding_balance;
      });
      overviewCharts.maturity = new Chart(document.getElementById('ow-chart-maturity'), {
        type: 'bar', data: { labels: Object.keys(mBuckets), datasets: [{ data: Object.values(mBuckets), backgroundColor: '#00857c', borderRadius: 2, borderWidth: 0 }] },
        options: miniChartOpts
      });
    }

    // Trend charts
    if (active.includes('trends') && tapes.length >= 2) {
      const sorted = [...tapes].sort((a, b) => {
        if (a.cutoffDate && b.cutoffDate) return a.cutoffDate.localeCompare(b.cutoffDate);
        return 0;
      });
      const labels = sorted.map(t => t.cutoffDate ? formatCutoffDate(t.cutoffDate) : t.series);
      const balData = sorted.map(t => t.loans.reduce((s, l) => s + l.outstanding_balance, 0));
      const rateData = sorted.map(t => {
        const tot = t.loans.reduce((s, l) => s + l.outstanding_balance, 0);
        return tot > 0 ? t.loans.reduce((s, l) => s + l.interest_rate * l.outstanding_balance, 0) / tot : 0;
      });
      const trendChartBase = { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } };
      if (document.getElementById('ow-chart-trend-bal')) {
        overviewCharts.trendBal = new Chart(document.getElementById('ow-chart-trend-bal'), {
          type: 'line',
          data: { labels, datasets: [{ label: 'Outstanding', data: balData, borderColor: '#003078', backgroundColor: 'rgba(0,48,120,0.08)', fill: true, tension: 0.3, pointRadius: 4 }] },
          options: { ...trendChartBase, scales: { y: { ticks: { callback: v => fmtM(v) }, beginAtZero: false }, x: { ticks: { font: { size: 10 } } } } }
        });
      }
      if (document.getElementById('ow-chart-trend-rate')) {
        overviewCharts.trendRate = new Chart(document.getElementById('ow-chart-trend-rate'), {
          type: 'line',
          data: { labels, datasets: [{ label: 'WA Rate', data: rateData, borderColor: '#00857c', backgroundColor: 'rgba(0,133,124,0.08)', fill: true, tension: 0.3, pointRadius: 4 }] },
          options: { ...trendChartBase, scales: { y: { ticks: { callback: v => v.toFixed(2) + '%' }, beginAtZero: false }, x: { ticks: { font: { size: 10 } } } } }
        });
      }
    }
  }, 0);
}

// ============================================================
//  CHARTS
// ============================================================
const chartDefaults = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: { labels: { color: '#4a5068', font: { size: 11, family: "-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif" }, padding: 10, boxWidth: 10 } },
    tooltip: {
      backgroundColor: '#1a1e2a', titleColor: '#ffffff', bodyColor: '#e2e5ea',
      borderColor: '#4a5068', borderWidth: 1,
      titleFont: { family: "-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif", size: 12 },
      bodyFont: { family: "'SF Mono','Consolas',monospace", size: 12 }
    }
  }
};

function destroyCharts() { Object.values(charts).forEach(c => c.destroy()); charts = {}; }

// Cap chart data: keep top N entries, group remainder into "Other"
function capChartData(map, maxSlices) {
  const entries = Object.entries(map);
  if (entries.length <= maxSlices) return map;
  const top = entries.slice(0, maxSlices - 1);
  const rest = entries.slice(maxSlices - 1);
  const otherVal = rest.reduce((s, e) => s + e[1], 0);
  const result = Object.fromEntries(top);
  if (otherVal > 0) result['Other'] = otherVal;
  return result;
}

function renderCharts() {
  destroyCharts();
  const tot = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const ttipCb = { callbacks: { label: ctx => ctx.label + ': ' + fmtM(ctx.raw) + ' (' + (tot > 0 ? ((ctx.raw / tot) * 100).toFixed(1) : 0) + '%)' } };

  const sectorMap = capChartData(groupBy(loans, 'sector', 'outstanding_balance', { excludeBlanks: true }), 15);
  charts.sector = new Chart(document.getElementById('chart-sector'), {
    type: 'bar',
    data: { labels: Object.keys(sectorMap), datasets: [{ label: 'Outstanding', data: Object.values(sectorMap), backgroundColor: COLORS, borderRadius: 2, borderWidth: 0 }] },
    options: { indexAxis: 'y', ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: false }, tooltip: { ...chartDefaults.plugins.tooltip, ...ttipCb } }, scales: { x: { ticks: { color: '#8890a0', callback: v => fmtM(v), font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true }, y: { ticks: { color: '#4a5068', font: { size: 11 } }, grid: { display: false } } } }
  });

  const regionMap = capChartData(groupBy(loans, 'region', 'outstanding_balance', { excludeBlanks: true }), 12);
  charts.region = new Chart(document.getElementById('chart-region'), {
    type: 'doughnut',
    data: { labels: Object.keys(regionMap), datasets: [{ data: Object.values(regionMap), backgroundColor: COLORS.slice(5).concat(COLORS.slice(0, 5)), borderWidth: 0 }] },
    options: { ...chartDefaults, cutout: '60%', plugins: { ...chartDefaults.plugins, tooltip: { ...chartDefaults.plugins.tooltip, ...ttipCb } } }
  });

  // Loan size distribution — more useful for SME portfolio analysis than rating
  const sizeBands = { '0-25k': 0, '25-50k': 0, '50-100k': 0, '100-250k': 0, '250-500k': 0, '500k+': 0 };
  loans.forEach(l => {
    const b = l.outstanding_balance;
    if (b <= 25000) sizeBands['0-25k'] += b;
    else if (b <= 50000) sizeBands['25-50k'] += b;
    else if (b <= 100000) sizeBands['50-100k'] += b;
    else if (b <= 250000) sizeBands['100-250k'] += b;
    else if (b <= 500000) sizeBands['250-500k'] += b;
    else sizeBands['500k+'] += b;
  });
  charts.loansize = new Chart(document.getElementById('chart-loansize'), {
    type: 'bar',
    data: { labels: Object.keys(sizeBands), datasets: [{ label: 'Outstanding', data: Object.values(sizeBands), backgroundColor: '#003078', borderRadius: 2, borderWidth: 0 }] },
    options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: false }, tooltip: { ...chartDefaults.plugins.tooltip, ...ttipCb } }, scales: { x: { ticks: { color: '#4a5068', font: { size: 11 } }, grid: { display: false } }, y: { ticks: { color: '#8890a0', callback: v => fmtM(v), font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true } } }
  });

  const bMap = {};
  loans.forEach(l => { bMap[l.borrower_name] = (bMap[l.borrower_name] || 0) + l.outstanding_balance; });
  const topX = displaySettings.topObligorCount || 10;
  const topN = Object.entries(bMap).sort((a, b) => b[1] - a[1]).slice(0, topX);
  const topTitleEl = document.getElementById('chart-top-title');
  if (topTitleEl) topTitleEl.textContent = 'Top ' + topX + ' Lessee Exposures';
  charts.top10 = new Chart(document.getElementById('chart-top10'), {
    type: 'bar',
    data: { labels: topN.map(b => b[0].length > 24 ? b[0].slice(0, 22) + '..' : b[0]), datasets: [{ label: 'Exposure', data: topN.map(b => b[1]), backgroundColor: '#003078', borderRadius: 2, borderWidth: 0 }] },
    options: { ...chartDefaults, indexAxis: 'y', plugins: { ...chartDefaults.plugins, legend: { display: false } }, scales: { x: { ticks: { color: '#8890a0', callback: v => fmtM(v), font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true }, y: { ticks: { color: '#4a5068', font: { size: 10 } }, grid: { display: false } } } }
  });

  const now = new Date();
  const buckets = { '<1yr': 0, '1-2yr': 0, '2-3yr': 0, '3-5yr': 0, '5-7yr': 0, '7+yr': 0 };
  loans.forEach(l => {
    const mat = parseDate(l.maturity_date);
    const years = mat ? Math.max(0, (mat - now) / (365.25 * 86400000)) : 0;
    if (years < 1) buckets['<1yr'] += l.outstanding_balance;
    else if (years < 2) buckets['1-2yr'] += l.outstanding_balance;
    else if (years < 3) buckets['2-3yr'] += l.outstanding_balance;
    else if (years < 5) buckets['3-5yr'] += l.outstanding_balance;
    else if (years < 7) buckets['5-7yr'] += l.outstanding_balance;
    else buckets['7+yr'] += l.outstanding_balance;
  });
  charts.maturity = new Chart(document.getElementById('chart-maturity'), {
    type: 'bar',
    data: { labels: Object.keys(buckets), datasets: [{ label: 'Outstanding', data: Object.values(buckets), backgroundColor: '#00857c', borderRadius: 2, borderWidth: 0 }] },
    options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: false } }, scales: { x: { ticks: { color: '#4a5068', font: { size: 11 } }, grid: { display: false } }, y: { ticks: { color: '#8890a0', callback: v => fmtM(v), font: { size: 10, family: "'SF Mono','Consolas',monospace" } }, grid: { color: '#eef0f3' }, beginAtZero: true } } }
  });
}

function groupBy(arr, key, sumKey, opts) {
  const map = {};
  const excludeBlanks = opts && opts.excludeBlanks;
  arr.forEach(item => {
    const raw = item[key];
    const k = (raw != null && String(raw).trim() !== '') ? String(raw) : '(blank)';
    if (excludeBlanks && k === '(blank)') return;
    map[k] = (map[k] || 0) + item[sumKey];
  });
  return Object.fromEntries(Object.entries(map).sort((a, b) => b[1] - a[1]));
}

// ============================================================
//  STRATIFICATION — prospectus-style tables
// ============================================================
function renderStratification() {
  const container = document.getElementById('strat-content');
  const tot = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const n = loans.length;

  // Key WA summary at the top
  const waRate = tot > 0 ? loans.reduce((s, l) => s + l.interest_rate * l.outstanding_balance, 0) / tot : 0;
  const waOrigTerm = tot > 0 ? loans.reduce((s, l) => s + (l.original_term || 0) * l.outstanding_balance, 0) / tot : 0;
  const waRemTerm = tot > 0 ? loans.reduce((s, l) => s + (l.remaining_term || 0) * l.outstanding_balance, 0) / tot : 0;
  const waSeasoning = waOrigTerm > 0 ? waOrigTerm - waRemTerm : 0;
  const waLTV = (() => {
    const withLoan = loans.filter(l => l.loan_amount > 0);
    const totalOrig = withLoan.reduce((s, l) => s + l.loan_amount, 0);
    return totalOrig > 0 ? (withLoan.reduce((s, l) => s + l.outstanding_balance, 0) / totalOrig * 100) : 0;
  })();
  const avgBal = n > 0 ? tot / n : 0;

  // Build dynamic WA metrics — only show what we have data for
  const waMetrics = [];
  if (waRate > 0) waMetrics.push({ label: 'WA Rate', value: fmtPct(waRate) });
  if (waOrigTerm > 0) waMetrics.push({ label: 'WA Orig Term', value: convertTerm(waOrigTerm, displaySettings.termUnit) });
  if (waRemTerm > 0) waMetrics.push({ label: 'WA Rem Term', value: convertTerm(waRemTerm, displaySettings.termUnit) });
  if (waSeasoning > 0) waMetrics.push({ label: 'WA Seasoning', value: convertTerm(waSeasoning, displaySettings.termUnit) });
  waMetrics.push({ label: 'Avg Balance', value: fmtM(avgBal) });
  const uniqueB = new Set(loans.map(l => l.borrower_name).filter(Boolean)).size;
  waMetrics.push({ label: 'Borrowers', value: uniqueB.toLocaleString() });

  const cols = Math.min(waMetrics.length, 6);
  let waHtml = `<div style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:10px;margin-bottom:16px;">`;
  waMetrics.forEach(m => {
    waHtml += `<div class="card" style="padding:12px;text-align:center;">
      <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.04em;">${m.label}</div>
      <div style="font-size:1.2rem;font-weight:700;font-family:var(--mono);color:var(--navy);">${m.value}</div>
    </div>`;
  });
  waHtml += '</div>';

  // Which strat tables to show (only if data exists for that field)
  const stratFields = [
    { key: 'facility_type',       title: 'By Type of Lease' },
    { key: 'asset_type',          title: 'By Asset Type' },
    { key: 'interest_rate_type',  title: 'By Interest Rate Type' },
    { key: 'repayment_method',    title: 'By Repayment Method' },
    { key: 'amortisation_type',   title: 'By Amortisation Type' },
    { key: 'payment_frequency',   title: 'By Payment Frequency' },
    { key: 'lessee_type',          title: 'By Lessee Type' },
    { key: 'origination_channel', title: 'By Origination Channel' },
    { key: 'credit_rating',       title: 'By Credit Rating' },
    { key: 'region',              title: 'By Region' },
    { key: 'bbb_guarantee',       title: 'By BBB Guarantee Programme' },
    { key: 'loan_status',         title: 'By Status' },
    { key: 'arrears_status',      title: 'By Arrears Status' },
    { key: 'equipment_type',      title: 'By Equipment Type' },
    { key: 'asset_category',      title: 'By Asset Category' },
    { key: 'supplier',            title: 'By Supplier / Vendor' },
    { key: 'vat_deferral',        title: 'By VAT Deferral' },
    { key: 'broker',              title: 'By Broker' },
    { key: 'originator',          title: 'By Originator' }
  ];

  // Banded strats
  const bandedStrats = [];

  // Original term bands (if data present)
  if (loans.some(l => l.original_term > 0)) {
    bandedStrats.push({
      title: 'By Original Term',
      fn: l => {
        const t = l.original_term;
        if (t <= 12) return '0-12m';
        if (t <= 24) return '13-24m';
        if (t <= 36) return '25-36m';
        if (t <= 48) return '37-48m';
        if (t <= 60) return '49-60m';
        if (t <= 84) return '61-84m';
        return '85m+';
      },
      order: ['0-12m','13-24m','25-36m','37-48m','49-60m','61-84m','85m+']
    });
  }

  // Remaining term bands
  if (loans.some(l => l.remaining_term > 0)) {
    bandedStrats.push({
      title: 'By Remaining Term',
      fn: l => {
        const t = l.remaining_term;
        if (t <= 12) return '0-12m';
        if (t <= 24) return '13-24m';
        if (t <= 36) return '25-36m';
        if (t <= 48) return '37-48m';
        if (t <= 60) return '49-60m';
        return '61m+';
      },
      order: ['0-12m','13-24m','25-36m','37-48m','49-60m','61m+']
    });
  }

  // Balance bands
  bandedStrats.push({
    title: 'By Current Balance Band',
    fn: l => {
      const b = l.outstanding_balance;
      if (b <= 0) return '\u22640';
      if (b <= 25000) return '0-25k';
      if (b <= 50000) return '25-50k';
      if (b <= 100000) return '50-100k';
      if (b <= 250000) return '100-250k';
      if (b <= 500000) return '250-500k';
      return '500k+';
    },
    order: ['\u22640','0-25k','25-50k','50-100k','100-250k','250-500k','500k+']
  });

  // Origination vintage
  if (loans.some(l => l.origination_date)) {
    bandedStrats.push({
      title: 'By Origination Vintage',
      fn: l => {
        const d = parseDate(l.origination_date);
        return d ? String(d.getFullYear()) : '(blank)';
      }
    });
  }

  // Arrears bands
  if (loans.some(l => l.days_in_arrears > 0)) {
    bandedStrats.push({
      title: 'By Arrears Status',
      fn: l => {
        const d = l.days_in_arrears;
        if (d === 0) return 'Current';
        if (d <= 30) return '1-30 days';
        if (d <= 60) return '31-60 days';
        if (d <= 90) return '61-90 days';
        return '>90 days';
      },
      order: ['Current','1-30 days','31-60 days','61-90 days','>90 days']
    });
  }

  // Balloon bands
  if (loans.some(l => l.balloon_pct > 0)) {
    bandedStrats.push({
      title: 'By Balloon Percentage',
      fn: l => {
        const b = l.balloon_pct;
        if (b === 0) return 'No balloon';
        if (b <= 10) return '1-10%';
        if (b <= 20) return '11-20%';
        if (b <= 30) return '21-30%';
        if (b <= 50) return '31-50%';
        return '>50%';
      },
      order: ['No balloon','1-10%','11-20%','21-30%','31-50%','>50%']
    });
  }

  // Add custom field strats
  Object.values(customFieldDefs).forEach(cfDef => {
    if (!loans.some(l => l[cfDef.key] != null && l[cfDef.key] !== '' && l[cfDef.key] !== 0)) return;
    if (cfDef.type === 'categorical') {
      stratFields.push({ key: cfDef.key, title: 'By ' + cfDef.label });
    } else if (cfDef.type === 'numeric' && cfDef.bands && cfDef.bands.length > 0) {
      bandedStrats.push({
        title: 'By ' + cfDef.label,
        fn: l => {
          const v = parseFloat(l[cfDef.key]);
          if (isNaN(v)) return '(blank)';
          for (const b of cfDef.bands) {
            if (v >= b.min && v < b.max) return b.label;
          }
          // Check last band with inclusive max
          const last = cfDef.bands[cfDef.bands.length - 1];
          if (v >= last.min) return last.label;
          return '(other)';
        },
        order: cfDef.bands.map(b => b.label)
      });
    } else if (cfDef.type === 'date') {
      bandedStrats.push({
        title: 'By ' + cfDef.label + ' (Year)',
        fn: l => {
          const d = parseDate(l[cfDef.key]);
          return d ? String(d.getFullYear()) : '(blank)';
        }
      });
    }
  });

  // Strat toggle controls
  const hiddenKey = activeSeries || 'all';
  const hidden = displaySettings.hiddenStrats[hiddenKey] || [];
  let html = waHtml;
  html += `<div style="margin-bottom:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
    <span style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Show/Hide:</span>
    ${stratFields.map(sf => {
      const isHidden = hidden.includes(sf.key);
      return `<button class="btn btn-sm ${isHidden ? 'btn-outline' : 'btn-primary'}" style="font-size:10px;padding:3px 8px;opacity:${isHidden ? '0.5' : '1'};" onclick="toggleStrat('${sf.key}')">${sf.title.replace('By ', '')}</button>`;
    }).join('')}
  </div>`;
  html += '<div class="strat-grid">';

  // Helper to build group with WA data
  function addToGroup(groups, k, l) {
    if (!groups[k]) groups[k] = { count: 0, balance: 0, rateWeightedBal: 0, termWeightedBal: 0 };
    groups[k].count++;
    groups[k].balance += l.outstanding_balance;
    groups[k].rateWeightedBal += l.interest_rate * l.outstanding_balance;
    groups[k].termWeightedBal += (l.remaining_term || 0) * l.outstanding_balance;
  }

  // Categorical strats
  stratFields.forEach(sf => {
    // Skip if ALL loans are blank for this field
    if (!loans.some(l => l[sf.key] && String(l[sf.key]).trim() !== '')) return;
    if (hidden.includes(sf.key)) return; // user hidden
    const groups = {};
    loans.forEach(l => addToGroup(groups, l[sf.key] || '(blank)', l));
    // Sort: blanks to bottom, rest by balance descending
    const sorted = Object.entries(groups).sort((a, b) => {
      if (a[0] === '(blank)') return 1;
      if (b[0] === '(blank)') return -1;
      return b[1].balance - a[1].balance;
    });
    html += buildStratCard(sf.title, sorted, n, tot);
  });

  // Banded strats
  bandedStrats.forEach(bs => {
    const groups = {};
    loans.forEach(l => addToGroup(groups, bs.fn(l), l));
    let sorted;
    if (bs.order) {
      sorted = bs.order.filter(k => groups[k]).map(k => [k, groups[k]]);
      Object.keys(groups).filter(k => !bs.order.includes(k)).forEach(k => sorted.push([k, groups[k]]));
    } else {
      sorted = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));
    }
    html += buildStratCard(bs.title, sorted, n, tot);
  });

  html += '</div>';
  container.innerHTML = html;
}

function buildStratCard(title, sortedEntries, totalCount, totalBalance) {
  const hasRate = sortedEntries.some(([, d]) => d.rateWeightedBal > 0);
  const hasTerm = sortedEntries.some(([, d]) => d.termWeightedBal > 0);
  let rows = '';
  sortedEntries.forEach(([label, data]) => {
    const pctCount = totalCount > 0 ? ((data.count / totalCount) * 100).toFixed(1) : '0.0';
    const pctBal = totalBalance > 0 ? ((data.balance / totalBalance) * 100).toFixed(1) : '0.0';
    const avgBal = data.count > 0 ? data.balance / data.count : 0;
    const waRate = data.balance > 0 ? data.rateWeightedBal / data.balance : 0;
    const waTermMonths = data.balance > 0 ? data.termWeightedBal / data.balance : 0;
    rows += `<tr>
      <td>${escapeHtml(label)}</td>
      <td class="mono right">${data.count}</td>
      <td class="mono right">${pctCount}%</td>
      <td class="mono right">${fmtFull(data.balance)}</td>
      <td class="mono right">${pctBal}%</td>
      <td class="mono right">${fmtM(avgBal)}</td>
      ${hasRate ? `<td class="mono right">${fmtPct(waRate)}</td>` : ''}
      ${hasTerm ? `<td class="mono right">${convertTerm(waTermMonths, displaySettings.termUnit)}</td>` : ''}
    </tr>`;
  });
  const totBal = sortedEntries.reduce((s, e) => s + e[1].balance, 0);
  const totCnt = sortedEntries.reduce((s, e) => s + e[1].count, 0);
  const totRateWB = sortedEntries.reduce((s, e) => s + (e[1].rateWeightedBal || 0), 0);
  const totTermWB = sortedEntries.reduce((s, e) => s + (e[1].termWeightedBal || 0), 0);
  const totWaRate = totBal > 0 ? totRateWB / totBal : 0;
  const totWaTerm = totBal > 0 ? totTermWB / totBal : 0;
  return `<div class="card strat-card">
    <div class="strat-card-header">${escapeHtml(title)}</div>
    <div class="table-scroll"><table>
      <thead><tr>
        <th>Category</th><th class="right">#</th><th class="right">% #</th><th class="right">Balance</th><th class="right">% Bal</th><th class="right">Avg</th>
        ${hasRate ? '<th class="right">WA Rate</th>' : ''}
        ${hasTerm ? '<th class="right">WA Term</th>' : ''}
      </tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr>
        <td>Total</td>
        <td class="mono right">${totCnt}</td>
        <td class="mono right">100.0%</td>
        <td class="mono right">${fmtFull(totBal)}</td>
        <td class="mono right">100.0%</td>
        <td class="mono right">${totCnt > 0 ? fmtM(totBal / totCnt) : '-'}</td>
        ${hasRate ? `<td class="mono right">${fmtPct(totWaRate)}</td>` : ''}
        ${hasTerm ? `<td class="mono right">${convertTerm(totWaTerm, displaySettings.termUnit)}</td>` : ''}
      </tr></tfoot>
    </table></div>
  </div>`;
}

// ============================================================
//  ANOMALIES — automated data quality checks
// ============================================================
function renderAnomalies() {
  const anomalies = detectAnomalies();
  const errors = anomalies.filter(a => a.severity === 'error');
  const warnings = anomalies.filter(a => a.severity === 'warning');
  const infos = anomalies.filter(a => a.severity === 'info');

  // Summary cards
  document.getElementById('anomaly-summary-section').innerHTML = `
    <div class="anomaly-summary">
      <div class="card anomaly-summary-card">
        <div class="stat-label">Total Checks</div>
        <div class="stat-value">${anomalies.length > 0 ? anomalies.length : 'All clear'}</div>
        <div class="stat-sub">${anomalies.length === 0 ? 'No anomalies detected' : 'anomalies found'}</div>
      </div>
      <div class="card anomaly-summary-card">
        <div class="stat-label">Errors</div>
        <div class="stat-value" style="color:var(--red)">${errors.length}</div>
        <div class="stat-sub">Data integrity issues</div>
      </div>
      <div class="card anomaly-summary-card">
        <div class="stat-label">Warnings</div>
        <div class="stat-value" style="color:var(--amber)">${warnings.length}</div>
        <div class="stat-sub">Potential issues</div>
      </div>
      <div class="card anomaly-summary-card">
        <div class="stat-label">Info</div>
        <div class="stat-value" style="color:var(--navy)">${infos.length}</div>
        <div class="stat-sub">Observations</div>
      </div>
    </div>
  `;

  // Anomaly list
  if (anomalies.length === 0) {
    document.getElementById('anomaly-list-section').innerHTML = '<div class="card" style="padding:32px;text-align:center;color:var(--text-muted);">No anomalies detected in this tape. All checks passed.</div>';
    return;
  }

  const listHtml = anomalies.map(a => {
    const iconClass = a.severity === 'error' ? 'error' : a.severity === 'warning' ? 'warning' : 'info';
    const iconChar = a.severity === 'error' ? '!' : a.severity === 'warning' ? '?' : 'i';
    const examplesHtml = a.examples && a.examples.length
      ? `<div class="anomaly-examples">${a.examples.map(e => escapeHtml(e)).join(' &middot; ')}</div>` : '';
    return `<div class="card anomaly-card">
      <div class="anomaly-icon ${iconClass}">${iconChar}</div>
      <div class="anomaly-body">
        <div class="anomaly-title">${escapeHtml(a.title)}</div>
        <div class="anomaly-desc">${escapeHtml(a.description)}</div>
        ${examplesHtml}
      </div>
      <div class="anomaly-count"><span class="badge badge-${iconClass === 'error' ? 'red' : iconClass === 'warning' ? 'amber' : 'navy'}">${a.count}</span></div>
    </div>`;
  }).join('');

  document.getElementById('anomaly-list-section').innerHTML = `<div class="anomaly-list">${listHtml}</div>`;
}

function detectAnomalies() {
  const results = [];
  const now = new Date();

  // 1. Duplicate IDs
  const idCounts = {};
  loans.forEach(l => { idCounts[l.loan_id] = (idCounts[l.loan_id] || 0) + 1; });
  const dupes = Object.entries(idCounts).filter(([, c]) => c > 1);
  if (dupes.length > 0) {
    results.push({
      severity: 'error', title: 'Duplicate Lease/Loan IDs',
      description: `${dupes.length} ID(s) appear more than once. Each receivable should have a unique identifier.`,
      count: dupes.reduce((s, d) => s + d[1], 0),
      examples: dupes.slice(0, 5).map(d => d[0] + ' (\u00d7' + d[1] + ')')
    });
  }

  // 2. Negative outstanding balance
  const negBal = loans.filter(l => l.outstanding_balance < 0);
  if (negBal.length > 0) {
    results.push({
      severity: 'error', title: 'Negative Outstanding Balance',
      description: `${negBal.length} receivable(s) have a negative current outstanding balance.`,
      count: negBal.length,
      examples: negBal.slice(0, 5).map(l => l.loan_id + ': ' + fmtFull(l.outstanding_balance))
    });
  }

  // 3. Outstanding > Original balance
  const overdrawn = loans.filter(l => l.outstanding_balance > l.loan_amount && l.loan_amount > 0);
  if (overdrawn.length > 0) {
    results.push({
      severity: 'error', title: 'Outstanding Exceeds Original Balance',
      description: `${overdrawn.length} receivable(s) where current outstanding exceeds original principal.`,
      count: overdrawn.length,
      examples: overdrawn.slice(0, 5).map(l => l.loan_id + ': ' + fmtFull(l.outstanding_balance) + ' vs orig ' + fmtFull(l.loan_amount))
    });
  }

  // 4. Remaining term > original term
  if (loans.some(l => l.original_term > 0)) {
    const termIssues = loans.filter(l => l.remaining_term > l.original_term && l.original_term > 0);
    if (termIssues.length > 0) {
      results.push({
        severity: 'error', title: 'Remaining Term Exceeds Original Term',
        description: `${termIssues.length} receivable(s) have remaining term greater than original term.`,
        count: termIssues.length,
        examples: termIssues.slice(0, 5).map(l => l.loan_id + ': ' + l.remaining_term + 'm rem vs ' + l.original_term + 'm orig')
      });
    }
  }

  // 5. Non-GBP currency
  if (loans.some(l => l.currency)) {
    const nonGBP = loans.filter(l => l.currency && l.currency.toUpperCase() !== 'GBP');
    if (nonGBP.length > 0) {
      const ccys = [...new Set(nonGBP.map(l => l.currency.toUpperCase()))];
      results.push({
        severity: 'warning', title: 'Non-GBP Currency',
        description: `${nonGBP.length} receivable(s) denominated in non-GBP currencies: ${ccys.join(', ')}.`,
        count: nonGBP.length,
        examples: nonGBP.slice(0, 5).map(l => l.loan_id + ': ' + l.currency)
      });
    }
  }

  // 6. Maturity date in the past
  const pastMaturity = loans.filter(l => {
    const mat = parseDate(l.maturity_date);
    return mat && mat < now;
  });
  if (pastMaturity.length > 0) {
    results.push({
      severity: 'warning', title: 'Maturity Date in the Past',
      description: `${pastMaturity.length} receivable(s) have already passed their maturity date.`,
      count: pastMaturity.length,
      examples: pastMaturity.slice(0, 5).map(l => l.loan_id + ': ' + l.maturity_date)
    });
  }

  // 7. Future origination date
  if (loans.some(l => l.origination_date)) {
    const futureOrig = loans.filter(l => {
      const od = parseDate(l.origination_date);
      return od && od > now;
    });
    if (futureOrig.length > 0) {
      results.push({
        severity: 'warning', title: 'Future Origination Date',
        description: `${futureOrig.length} receivable(s) have an origination date in the future.`,
        count: futureOrig.length,
        examples: futureOrig.slice(0, 5).map(l => l.loan_id + ': ' + l.origination_date)
      });
    }
  }

  // 8. Interest rate = 0
  const zeroRate = loans.filter(l => l.interest_rate === 0 && l.outstanding_balance > 0);
  if (zeroRate.length > 0) {
    results.push({
      severity: 'warning', title: 'Zero Interest Rate',
      description: `${zeroRate.length} receivable(s) with a 0% interest rate / margin.`,
      count: zeroRate.length,
      examples: zeroRate.slice(0, 5).map(l => l.loan_id)
    });
  }

  // 9. Very high interest rate (>50%)
  const highRate = loans.filter(l => l.interest_rate > 50);
  if (highRate.length > 0) {
    results.push({
      severity: 'warning', title: 'Very High Interest Rate (>50%)',
      description: `${highRate.length} receivable(s) with rate above 50%. Check rate format is correct (percentage vs decimal).`,
      count: highRate.length,
      examples: highRate.slice(0, 5).map(l => l.loan_id + ': ' + l.interest_rate.toFixed(2) + '%')
    });
  }

  // 10. Balloon percentage > 100%
  if (loans.some(l => l.balloon_pct > 0)) {
    const badBalloon = loans.filter(l => l.balloon_pct > 100);
    if (badBalloon.length > 0) {
      results.push({
        severity: 'error', title: 'Balloon Percentage >100%',
        description: `${badBalloon.length} receivable(s) with balloon percentage exceeding 100%.`,
        count: badBalloon.length,
        examples: badBalloon.slice(0, 5).map(l => l.loan_id + ': ' + l.balloon_pct + '%')
      });
    }
  }

  // 11. High arrears (>90 days)
  const highArrears = loans.filter(l => l.days_in_arrears > 90);
  if (highArrears.length > 0) {
    const arrearsBal = highArrears.reduce((s, l) => s + l.outstanding_balance, 0);
    results.push({
      severity: 'warning', title: 'Arrears >90 Days',
      description: `${highArrears.length} receivable(s) in arrears for more than 90 days (${fmtM(arrearsBal)} balance).`,
      count: highArrears.length,
      examples: highArrears.slice(0, 5).map(l => l.loan_id + ': ' + l.days_in_arrears + ' days')
    });
  }

  // 12. Balance outliers (>3 std dev from mean)
  const balances = loans.map(l => l.outstanding_balance).filter(b => b > 0);
  if (balances.length > 10) {
    const mean = balances.reduce((s, b) => s + b, 0) / balances.length;
    const stddev = Math.sqrt(balances.reduce((s, b) => s + (b - mean) ** 2, 0) / balances.length);
    const threshold = mean + 3 * stddev;
    const outliers = loans.filter(l => l.outstanding_balance > threshold);
    if (outliers.length > 0) {
      results.push({
        severity: 'info', title: 'Balance Outliers (>3 Std Dev)',
        description: `${outliers.length} receivable(s) with outstanding balance above ${fmtM(threshold)} (mean + 3\u03C3).`,
        count: outliers.length,
        examples: outliers.slice(0, 5).map(l => l.loan_id + ': ' + fmtFull(l.outstanding_balance))
      });
    }
  }

  // 13. Missing borrower name
  const missingName = loans.filter(l => !l.borrower_name.trim());
  if (missingName.length > 0) {
    results.push({
      severity: 'info', title: 'Missing Lessee / Borrower Name',
      description: `${missingName.length} receivable(s) with blank borrower/lessee name.`,
      count: missingName.length,
      examples: missingName.slice(0, 5).map(l => l.loan_id)
    });
  }

  // 14. Single-name concentration
  const nameMap = {};
  loans.forEach(l => { nameMap[l.borrower_name] = (nameMap[l.borrower_name] || 0) + l.outstanding_balance; });
  const totalBal = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const bigNames = Object.entries(nameMap).filter(([, b]) => totalBal > 0 && (b / totalBal) > 0.05);
  if (bigNames.length > 0) {
    results.push({
      severity: 'info', title: 'Single-Name Concentration >5%',
      description: `${bigNames.length} lessee(s) account for more than 5% of total outstanding balance.`,
      count: bigNames.length,
      examples: bigNames.sort((a, b) => b[1] - a[1]).slice(0, 5).map(([name, bal]) => name + ': ' + fmtPct((bal / totalBal) * 100))
    });
  }

  // Sort: errors first, then warnings, then info
  const sevOrder = { error: 0, warning: 1, info: 2 };
  results.sort((a, b) => sevOrder[a.severity] - sevOrder[b.severity]);
  return results;
}

// ============================================================
//  DATA TABLE
// ============================================================
function renderDataTable() {
  document.getElementById('data-table-title').textContent = `Tape Data \u2014 ${loans.length} records`;
  if (!loans.length) { document.getElementById('data-table-container').innerHTML = ''; return; }

  // Build columns dynamically from the fields that have data
  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });
  // Also label custom fields
  Object.values(customFieldDefs).forEach(cf => { fieldLabels[cf.key] = cf.label; });

  const allKeys = Object.keys(loans[0]);
  // Determine which columns to show — skip if all values are empty/zero
  const numericFields = new Set(TEMPLATE_FIELDS.filter(f => f.type === 'number').map(f => f.key));
  Object.values(customFieldDefs).forEach(cf => { if (cf.type === 'numeric') numericFields.add(cf.key); });

  const visibleCols = allKeys.filter(k => {
    if (['loan_id', 'borrower_name', 'loan_amount', 'outstanding_balance'].includes(k)) return true; // always show core
    return loans.some(l => {
      const v = l[k];
      if (v == null) return false;
      if (typeof v === 'boolean') return v;
      if (typeof v === 'number') return v !== 0;
      return String(v).trim() !== '';
    });
  });

  const thead = visibleCols.map(k => `<th>${escapeHtml(fieldLabels[k] || k)}</th>`).join('');
  const tbody = loans.map(l => {
    const cells = visibleCols.map(k => {
      const v = l[k];
      if (k === 'days_in_arrears') {
        const cls = v > 90 ? 'badge-red' : v > 0 ? 'badge-amber' : 'badge-green';
        const txt = v > 0 ? v + 'd' : 'Current';
        return `<td><span class="badge ${cls}">${txt}</span></td>`;
      }
      if (numericFields.has(k) && typeof v === 'number') {
        if (k === 'interest_rate' || k === 'deposit_pct' || k === 'balloon_pct') return `<td class="mono">${v.toFixed(2)}%</td>`;
        if (k === 'loan_amount' || k === 'outstanding_balance' || k === 'deposit_amount') return `<td class="mono">${fmtFull(v)}</td>`;
        return `<td class="mono">${v}</td>`;
      }
      if (typeof v === 'boolean') return `<td>${v ? 'Yes' : 'No'}</td>`;
      return `<td>${escapeHtml(String(v || ''))}</td>`;
    }).join('');
    return `<tr>${cells}</tr>`;
  }).join('');

  document.getElementById('data-table-container').innerHTML = `<table>
    <thead><tr>${thead}</tr></thead>
    <tbody>${tbody}</tbody>
  </table>`;
}

// ============================================================
//  EXPORT CSV — data tab only
// ============================================================
function csvEscape(val) {
  if (val == null) return '';
  const s = String(val);
  if (s.includes(',') || s.includes('"') || s.includes('\n')) return '"' + s.replace(/"/g, '""') + '"';
  return s;
}

function exportCSV() {
  if (!loans.length) return;
  const fieldKeys = Object.keys(loans[0]);
  const fieldLabelsMap = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabelsMap[f.key] = f.label; });
  Object.values(customFieldDefs).forEach(cf => { fieldLabelsMap[cf.key] = cf.label; });

  const st = computeStats();
  const meta = getActiveTapeMeta();
  const originators = [...new Set(meta.filter(m => m.originator).map(m => m.originator))];
  const cutoffs = [...new Set(meta.filter(m => m.cutoffDate).map(m => formatCutoffDate(m.cutoffDate)))];
  const tot = st.totalOutstanding;
  const n = loans.length;
  const csvParts = [];

  // ---- SECTION 1: PORTFOLIO SUMMARY ----
  csvParts.push('PORTFOLIO SUMMARY');
  csvParts.push('');
  csvParts.push('Metric,Value');
  if (originators.length > 0) csvParts.push('Originator(s),' + csvEscape(originators.join(', ')));
  if (cutoffs.length > 0) csvParts.push('Cut-Off Date(s),' + csvEscape(cutoffs.join(', ')));
  csvParts.push('Number of Receivables,' + n.toLocaleString());
  csvParts.push('Original Amount,' + fmtFull(st.totalOriginal));
  csvParts.push('Current Outstanding,' + fmtFull(st.totalOutstanding));
  csvParts.push('Current Factor,' + (st.currentFactor * 100).toFixed(1) + '%');
  csvParts.push('WA Interest Rate,' + fmtPct(st.wair));
  csvParts.push('WA Original Term,' + convertTerm(st.waOrigTerm, displaySettings.termUnit));
  csvParts.push('WA Remaining Term,' + convertTerm(st.waRem, displaySettings.termUnit));
  csvParts.push('WA Seasoning,' + convertTerm(st.waSeasoning, displaySettings.termUnit));
  csvParts.push('90+ DPD (% Bal),' + fmtPct(st.arrears90Pct));
  csvParts.push('Default Rate,' + fmtPct(st.defaultPct));
  csvParts.push('Unique Borrowers,' + st.uniqueBorrowers.toLocaleString());
  csvParts.push('Average Facility Size,' + fmtFull(st.avgFacility));
  csvParts.push('Number of Tapes,' + tapes.length);
  csvParts.push('');

  // ---- SECTION 2: KEY STRATIFICATION ----
  const stratFields = [
    { key: 'facility_type', title: 'FACILITY TYPE BREAKDOWN' },
    { key: 'sector', title: 'SECTOR BREAKDOWN' },
    { key: 'region', title: 'REGIONAL BREAKDOWN' },
    { key: 'credit_rating', title: 'CREDIT RATING BREAKDOWN' },
    { key: 'lessee_type', title: 'LESSEE TYPE BREAKDOWN' }
  ];
  stratFields.forEach(sf => {
    if (!loans.some(l => l[sf.key] && String(l[sf.key]).trim())) return;
    const groups = {};
    loans.forEach(l => {
      const k = l[sf.key] || '(blank)';
      if (k === '(blank)') return;
      if (!groups[k]) groups[k] = { count: 0, balance: 0 };
      groups[k].count++;
      groups[k].balance += l.outstanding_balance;
    });
    const sorted = Object.entries(groups).sort((a, b) => b[1].balance - a[1].balance);
    csvParts.push(sf.title);
    csvParts.push('Category,# Loans,% Count,Balance,% Balance');
    sorted.forEach(([label, data]) => {
      csvParts.push([csvEscape(label), data.count.toLocaleString(), n > 0 ? ((data.count / n) * 100).toFixed(1) + '%' : '0%', fmtFull(data.balance), tot > 0 ? ((data.balance / tot) * 100).toFixed(1) + '%' : '0%'].join(','));
    });
    csvParts.push('');
  });

  // ---- SECTION 3: TOP 10 EXPOSURES ----
  const bMap = {};
  loans.forEach(l => { bMap[l.borrower_name || '(unknown)'] = (bMap[l.borrower_name || '(unknown)'] || 0) + l.outstanding_balance; });
  const topBorrowers = Object.entries(bMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
  csvParts.push('TOP 10 LESSEE EXPOSURES');
  csvParts.push('#,Lessee,Balance,% Portfolio,Cumulative %');
  let cumBal = 0;
  topBorrowers.forEach(([name, bal], i) => {
    cumBal += bal;
    csvParts.push([(i + 1), csvEscape(name), fmtFull(bal), tot > 0 ? ((bal / tot) * 100).toFixed(2) + '%' : '0%', tot > 0 ? ((cumBal / tot) * 100).toFixed(1) + '%' : '0%'].join(','));
  });
  csvParts.push('');

  // ---- SECTION 4: TAPE DATA ----
  csvParts.push('TAPE DATA');
  const labelRow = fieldKeys.map(k => csvEscape(fieldLabelsMap[k] || k)).join(',');
  csvParts.push(labelRow);
  loans.forEach(l => {
    csvParts.push(fieldKeys.map(h => {
      const val = l[h];
      if (typeof val === 'boolean') return val ? 'Yes' : 'No';
      if (typeof val === 'number') return val;
      return csvEscape(val);
    }).join(','));
  });

  const csv = csvParts.join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const seriesLabel = activeSeries !== 'all' ? '_' + activeSeries.replace(/[^a-zA-Z0-9]/g, '_') : '';
  a.download = 'tape_export' + seriesLabel + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
//  EXPORT XLSX — all tabs as separate sheets
// ============================================================
function exportXLSX() {
  if (!loans.length) return;
  const wb = XLSX.utils.book_new();
  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });
  Object.values(customFieldDefs).forEach(cf => { fieldLabels[cf.key] = cf.label; });

  // Sheet 1: Tape Data
  const fieldKeys = Object.keys(loans[0]);
  const dataHeaders = fieldKeys.map(k => fieldLabels[k] || k);
  const dataSourceRow = fieldKeys.map(k => sourceColumnNames[k] || '');
  const dataRows = loans.map(l => fieldKeys.map(k => {
    const v = l[k];
    return typeof v === 'boolean' ? (v ? 'Yes' : 'No') : v;
  }));
  const dataSheet = XLSX.utils.aoa_to_sheet([dataHeaders, dataSourceRow, ...dataRows]);
  dataSheet['!cols'] = fieldKeys.map(() => ({ wch: 18 }));
  XLSX.utils.book_append_sheet(wb, dataSheet, 'Tape Data');

  // Sheet 2: Stratification — gather all strat tables
  const stratRows = [];
  const tot = loans.reduce((s, l) => s + l.outstanding_balance, 0);
  const n = loans.length;
  const xlsxStratFields = [
    { key: 'facility_type', title: 'By Type of Lease' }, { key: 'asset_type', title: 'By Asset Type' },
    { key: 'interest_rate_type', title: 'By Interest Rate Type' }, { key: 'repayment_method', title: 'By Repayment Method' },
    { key: 'amortisation_type', title: 'By Amortisation Type' }, { key: 'payment_frequency', title: 'By Payment Frequency' },
    { key: 'lessee_type', title: 'By Lessee Type' }, { key: 'credit_rating', title: 'By Credit Rating' },
    { key: 'region', title: 'By Region' }, { key: 'bbb_guarantee', title: 'By BBB Guarantee' },
    { key: 'loan_status', title: 'By Status' }, { key: 'arrears_status', title: 'By Arrears Status' },
    { key: 'equipment_type', title: 'By Equipment Type' }, { key: 'asset_category', title: 'By Asset Category' },
    { key: 'supplier', title: 'By Supplier' }, { key: 'vat_deferral', title: 'By VAT Deferral' },
    { key: 'broker', title: 'By Broker' }, { key: 'originator', title: 'By Originator' }
  ];
  xlsxStratFields.forEach(sf => {
    if (!loans.some(l => l[sf.key])) return;
    const groups = {};
    loans.forEach(l => {
      const k = l[sf.key] || '(blank)';
      if (!groups[k]) groups[k] = { count: 0, balance: 0, rateWB: 0 };
      groups[k].count++; groups[k].balance += l.outstanding_balance;
      groups[k].rateWB += l.interest_rate * l.outstanding_balance;
    });
    const sorted = Object.entries(groups).sort((a, b) => b[1].balance - a[1].balance);
    stratRows.push([sf.title]);
    stratRows.push(['Category', 'Count', '% Count', 'Balance', '% Balance', 'Average', 'WA Rate']);
    sorted.forEach(([label, data]) => {
      const waRate = data.balance > 0 ? (data.rateWB / data.balance).toFixed(2) + '%' : '-';
      stratRows.push([label, data.count, n > 0 ? ((data.count / n) * 100).toFixed(1) + '%' : '0%', data.balance, tot > 0 ? ((data.balance / tot) * 100).toFixed(1) + '%' : '0%', data.count > 0 ? data.balance / data.count : 0, waRate]);
    });
    stratRows.push([]);
  });
  if (stratRows.length > 0) {
    const stratSheet = XLSX.utils.aoa_to_sheet(stratRows);
    stratSheet['!cols'] = [{ wch: 24 }, { wch: 10 }, { wch: 10 }, { wch: 18 }, { wch: 10 }, { wch: 18 }, { wch: 10 }];
    XLSX.utils.book_append_sheet(wb, stratSheet, 'Stratification');
  }

  // Sheet 3: Anomalies
  const anomalies = detectAnomalies();
  const customResults = evaluateCustomTests();
  customResults.forEach(cr => { if (!anomalies.find(a => a.title === cr.title)) anomalies.push(cr); });
  if (anomalies.length > 0) {
    const anomalyRows = [['Severity', 'Title', 'Description', 'Count', 'Examples']];
    anomalies.forEach(a => {
      anomalyRows.push([a.severity, a.title, a.description, a.count, a.examples ? a.examples.join('; ') : '']);
    });
    const anomSheet = XLSX.utils.aoa_to_sheet(anomalyRows);
    anomSheet['!cols'] = [{ wch: 10 }, { wch: 30 }, { wch: 50 }, { wch: 8 }, { wch: 40 }];
    XLSX.utils.book_append_sheet(wb, anomSheet, 'Anomalies');
  }

  // Sheet 4: Overview Summary
  const st = computeStats();
  const xlsMeta = getActiveTapeMeta();
  const xlsOriginators = [...new Set(xlsMeta.filter(m => m.originator).map(m => m.originator))];
  const xlsCutoffs = [...new Set(xlsMeta.filter(m => m.cutoffDate).map(m => formatCutoffDate(m.cutoffDate)))];
  const summaryRows = [
    ['Metric', 'Value'],
    ['Originator(s)', xlsOriginators.join(', ') || '-'],
    ['Cut-Off Date(s)', xlsCutoffs.join(', ') || '-'],
    ['Number of Receivables', loans.length],
    ['Original Amount', st.totalOriginal],
    ['Current Outstanding', st.totalOutstanding],
    ['Current Factor', (st.currentFactor * 100).toFixed(1) + '%'],
    ['WA Interest Rate', fmtPct(st.wair)],
    ['WA Original Term', convertTerm(st.waOrigTerm, displaySettings.termUnit)],
    ['WA Remaining Term', convertTerm(st.waRem, displaySettings.termUnit)],
    ['WA Seasoning', convertTerm(st.waSeasoning, displaySettings.termUnit)],
    ['90+ DPD (% Bal)', fmtPct(st.arrears90Pct)],
    ['Default Rate', fmtPct(st.defaultPct)],
    ['Unique Borrowers', st.uniqueBorrowers],
    ['Average Facility Size', st.avgFacility],
    ['Number of Tapes', tapes.length],
    ['Active Series', activeSeries]
  ];
  const summarySheet = XLSX.utils.aoa_to_sheet(summaryRows);
  summarySheet['!cols'] = [{ wch: 24 }, { wch: 24 }];
  XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');

  // Sheet 5: Per-Tape Breakdown (if multiple tapes)
  if (tapes.length > 1) {
    const tapeRows = [['Metric', ...tapes.map(t => t.series)]];
    tapeRows.push(['Originator', ...tapes.map(t => t.originator || '-')]);
    tapeRows.push(['Cut-Off Date', ...tapes.map(t => t.cutoffDate ? formatCutoffDate(t.cutoffDate) : '-')]);
    tapeRows.push(['Receivables', ...tapes.map(t => t.loans.length)]);
    tapeRows.push(['Original Balance', ...tapes.map(t => t.loans.reduce((s, l) => s + l.loan_amount, 0))]);
    tapeRows.push(['Outstanding Balance', ...tapes.map(t => t.loans.reduce((s, l) => s + l.outstanding_balance, 0))]);
    tapeRows.push(['WA Interest Rate', ...tapes.map(t => {
      const tb = t.loans.reduce((s, l) => s + l.outstanding_balance, 0);
      return tb > 0 ? (t.loans.reduce((s, l) => s + l.interest_rate * l.outstanding_balance, 0) / tb).toFixed(2) + '%' : '-';
    })]);
    tapeRows.push(['90+ Arrears %', ...tapes.map(t => {
      const tb = t.loans.reduce((s, l) => s + l.outstanding_balance, 0);
      const ab = t.loans.filter(l => l.days_in_arrears > 90).reduce((s, l) => s + l.outstanding_balance, 0);
      return tb > 0 ? ((ab / tb) * 100).toFixed(1) + '%' : '-';
    })]);
    tapeRows.push(['Default Rate', ...tapes.map(t => {
      return t.loans.length > 0 ? ((t.loans.filter(l => l.default_flag).length / t.loans.length) * 100).toFixed(1) + '%' : '-';
    })]);
    const tapeSheet = XLSX.utils.aoa_to_sheet(tapeRows);
    tapeSheet['!cols'] = [{ wch: 20 }, ...tapes.map(() => ({ wch: 18 }))];
    XLSX.utils.book_append_sheet(wb, tapeSheet, 'Tape Comparison');
  }

  const fileName = activeSeries !== 'all' ? 'tape_export_' + activeSeries.replace(/[^a-zA-Z0-9]/g, '_') + '.xlsx' : 'tape_export.xlsx';
  XLSX.writeFile(wb, fileName);
}

// ============================================================
//  SETTINGS MODAL — field option editor
// ============================================================
function openSettings() {
  renderSettingsBody();
  document.getElementById('settings-overlay').classList.add('active');
}
function closeSettings() {
  document.getElementById('settings-overlay').classList.remove('active');
  // Re-render dashboard if data loaded, to reflect any option changes
  if (loans.length) renderDashboard();
}

function renderSettingsBody() {
  const body = document.getElementById('settings-body');
  let html = '';

  // Display settings section
  html += '<div class="settings-section"><div class="settings-section-title">Display Settings</div>';
  html += '<div class="opt-field-group"><div class="opt-field-label">Remaining / Original Term Display Unit</div>';
  html += '<div style="display:flex;gap:6px;">';
  ['months','years','days'].forEach(u => {
    const sel = displaySettings.termUnit === u ? 'background:var(--navy);color:#fff;border-color:var(--navy);' : '';
    html += `<button class="btn btn-outline btn-sm" style="${sel}" onclick="displaySettings.termUnit='${u}';renderSettingsBody();if(loans.length)renderDashboard();">${u.charAt(0).toUpperCase()+u.slice(1)}</button>`;
  });
  html += '</div></div>';

  // Interest rate format setting
  html += '<div class="opt-field-group"><div class="opt-field-label">Interest Rate Format</div>';
  html += '<p style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">How rates are coded in your data. Auto-detect converts decimals (0.05) to percentages (5%) when most values are &lt; 1.</p>';
  html += '<div style="display:flex;gap:6px;">';
  ['auto','percentage','decimal'].forEach(f => {
    const labels = { auto: 'Auto-detect', percentage: 'Already % (5 = 5%)', decimal: 'Decimal (0.05 = 5%)' };
    const sel = displaySettings.rateFormat === f ? 'background:var(--navy);color:#fff;border-color:var(--navy);' : '';
    html += `<button class="btn btn-outline btn-sm" style="${sel}" onclick="changeRateFormat('${f}')">${labels[f]}</button>`;
  });
  html += '</div></div></div>';

  // Overview widgets section
  const widgetDefs = [
    { key: 'stats', label: 'Key Metrics (stats bar)' },
    { key: 'keyRisks', label: 'Key Risk Metrics' },
    { key: 'topExposures', label: 'Top Lessee Exposures' },
    { key: 'facilityMix', label: 'Facility Type Mix Chart' },
    { key: 'maturityProfile', label: 'Original Term Chart' },
    { key: 'arrearsSnapshot', label: 'Arrears Snapshot' },
    { key: 'originationProfile', label: 'Origination & Maturity Profile' },
    { key: 'amortProfile', label: 'Amortisation Profile (French)' },
    { key: 'seriesComparison', label: 'Series Comparison (Multi-Tape)' },
    { key: 'trends', label: 'Historic Trends (Multi-Tape)' }
  ];
  html += '<div class="settings-section"><div class="settings-section-title">Overview Page Widgets</div>';
  html += '<p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">Choose which widgets appear on the Overview tab.</p>';
  widgetDefs.forEach(w => {
    const checked = displaySettings.overviewWidgets.includes(w.key) ? 'checked' : '';
    html += `<label style="display:flex;align-items:center;gap:8px;font-size:13px;padding:4px 0;cursor:pointer;">
      <input type="checkbox" ${checked} onchange="toggleOverviewWidget('${w.key}', this.checked)" style="accent-color:var(--navy);"> ${escapeHtml(w.label)}
    </label>`;
  });
  html += '</div>';

  // Series management section
  if (tapes.length > 0) {
    html += '<div class="settings-section"><div class="settings-section-title">Loaded Tapes</div>';
    tapes.forEach((t, i) => {
      const cutoffStr = t.cutoffDate ? formatCutoffDate(t.cutoffDate) : '';
      const origStr = t.originator || '';
      html += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-light);">
        <span style="font-size:13px;font-weight:500;">${escapeHtml(t.name)}</span>
        <span class="badge badge-navy">${escapeHtml(t.series)}</span>
        ${origStr ? `<span class="badge badge-green">${escapeHtml(origStr)}</span>` : ''}
        ${cutoffStr ? `<span style="font-size:11px;color:var(--text-muted);font-style:italic;">${cutoffStr}</span>` : ''}
        <span style="font-size:11px;color:var(--text-muted);">${t.loans.length} records</span>
        <button class="btn btn-outline btn-sm" style="margin-left:auto;font-size:10px;padding:2px 8px;" onclick="recategoriseTape(${i})" title="Edit field options for this tape">Edit Fields</button>
        <button class="opt-tag-del" onclick="renameTapeSeries(${i})" title="Rename series">&#9998;</button>
        <button class="opt-tag-del" onclick="editTapeOriginator(${i})" title="Edit originator">O</button>
        <button class="opt-tag-del" onclick="removeTape(${i})" title="Remove tape">&times;</button>
      </div>`;
    });
    html += '</div>';
  }

  // Field category options section
  html += '<div class="settings-section"><div class="settings-section-title">Field Category Options</div>';
  html += '<p style="font-size:12px;color:var(--text-muted);margin-bottom:14px;">Configure predefined options for categorical fields. Click an option to edit it inline. These drive stratification tables and data quality checks.</p>';

  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });

  for (const [fieldKey, options] of Object.entries(fieldOptions)) {
    const label = fieldLabels[fieldKey] || fieldKey;
    html += `<div class="opt-field-group">
      <div class="opt-field-label">${escapeHtml(label)} <span style="font-size:11px;color:var(--text-muted);font-weight:400;">(${options.length} options)</span>
        <button class="opt-tag-del" style="float:right;font-size:13px;cursor:pointer;" onclick="deleteFieldCategory('${fieldKey}')" title="Remove entire category">&times;</button>
      </div>
      <div class="opt-tags" id="opt-tags-${fieldKey}">
        ${options.map((opt, idx) =>
          `<span class="opt-tag" id="opt-tag-${fieldKey}-${idx}">
            <span class="opt-tag-text" ondblclick="inlineEditOption('${fieldKey}',${idx})" title="Double-click to edit">${escapeHtml(opt)}</span>
            <button class="opt-tag-edit" onclick="inlineEditOption('${fieldKey}',${idx})" title="Edit">&#9998;</button>
            <button class="opt-tag-del" onclick="deleteFieldOption('${fieldKey}',${idx})" title="Remove">&times;</button>
          </span>`
        ).join('')}
      </div>
      <div class="opt-add-row">
        <input class="opt-add-input" id="opt-input-${fieldKey}" placeholder="Add new option..." onkeydown="if(event.key==='Enter')addFieldOption('${fieldKey}')">
        <button class="opt-add-btn" onclick="addFieldOption('${fieldKey}')">Add</button>
      </div>
    </div>`;
  }

  html += '<div style="margin-top:16px;"><button class="btn btn-outline btn-sm" onclick="addNewFieldCategory()">+ Add New Field Category</button></div>';
  html += '</div>';
  body.innerHTML = html;
}

function addFieldOption(fieldKey) {
  const input = document.getElementById('opt-input-' + fieldKey);
  const val = input.value.trim();
  if (!val) return;
  if (fieldOptions[fieldKey].includes(val)) { input.value = ''; return; }
  fieldOptions[fieldKey].push(val);
  input.value = '';
  renderSettingsBody();
}

function editFieldOption(fieldKey, idx) {
  const current = fieldOptions[fieldKey][idx];
  const newVal = prompt('Edit option:', current);
  if (newVal === null || newVal.trim() === '' || newVal.trim() === current) return;
  fieldOptions[fieldKey][idx] = newVal.trim();
  renderSettingsBody();
}

function inlineEditOption(fieldKey, idx) {
  const tag = document.getElementById('opt-tag-' + fieldKey + '-' + idx);
  if (!tag) return editFieldOption(fieldKey, idx);
  const textSpan = tag.querySelector('.opt-tag-text');
  if (!textSpan) return editFieldOption(fieldKey, idx);
  const current = fieldOptions[fieldKey][idx];
  textSpan.innerHTML = `<input type="text" value="${escapeHtml(current)}" style="border:1px solid var(--navy);border-radius:3px;padding:1px 6px;font-size:12px;width:${Math.max(60, current.length * 8)}px;font-family:inherit;" onblur="finishInlineEdit('${fieldKey}',${idx},this.value)" onkeydown="if(event.key==='Enter'){this.blur();}if(event.key==='Escape'){this.value='${escapeHtml(current)}';this.blur();}">`;
  textSpan.querySelector('input').focus();
  textSpan.querySelector('input').select();
}

function finishInlineEdit(fieldKey, idx, newVal) {
  if (newVal && newVal.trim() && newVal.trim() !== fieldOptions[fieldKey][idx]) {
    fieldOptions[fieldKey][idx] = newVal.trim();
  }
  renderSettingsBody();
}

function deleteFieldOption(fieldKey, idx) {
  fieldOptions[fieldKey].splice(idx, 1);
  renderSettingsBody();
}

function deleteFieldCategory(fieldKey) {
  if (!confirm('Remove the entire "' + fieldKey + '" category?')) return;
  delete fieldOptions[fieldKey];
  renderSettingsBody();
}

function addNewFieldCategory() {
  const name = prompt('Enter a field key (e.g. "product_line"):');
  if (!name || !name.trim()) return;
  const key = name.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
  if (fieldOptions[key]) { alert('Field "' + key + '" already exists.'); return; }
  const label = prompt('Display label for this field (e.g. "Product Line"):', key);
  if (!label) return;
  const optionsStr = prompt('Enter initial options separated by commas (e.g. "Green Loan, SME Loan, Asset Finance"):');
  const opts = optionsStr ? optionsStr.split(',').map(s => s.trim()).filter(Boolean) : [];
  fieldOptions[key] = opts;
  // Add to TEMPLATE_FIELDS if not already there
  if (!TEMPLATE_FIELDS.find(f => f.key === key)) {
    TEMPLATE_FIELDS.push({ key: key, label: label.trim(), required: false, type: 'string' });
  }
  // Add empty alias list
  if (!FIELD_ALIASES[key]) {
    FIELD_ALIASES[key] = [key, key.replace(/_/g, ''), key.replace(/_/g, ' ')];
  }
  renderSettingsBody();
}

// ============================================================
//  OVERVIEW WIDGET TOGGLES
// ============================================================
function toggleStrat(key) {
  const hiddenKey = activeSeries || 'all';
  if (!displaySettings.hiddenStrats[hiddenKey]) displaySettings.hiddenStrats[hiddenKey] = [];
  const arr = displaySettings.hiddenStrats[hiddenKey];
  const idx = arr.indexOf(key);
  if (idx >= 0) arr.splice(idx, 1);
  else arr.push(key);
  renderStratification();
}

function toggleOverviewWidget(key, enabled) {
  if (enabled && !displaySettings.overviewWidgets.includes(key)) {
    displaySettings.overviewWidgets.push(key);
  } else if (!enabled) {
    displaySettings.overviewWidgets = displaySettings.overviewWidgets.filter(k => k !== key);
  }
}

function changeRateFormat(fmt) {
  displaySettings.rateFormat = fmt;
  // Re-apply mapping to all tapes to recalculate rates
  tapes.forEach(t => {
    if (t._rawData && t._reverseMap) {
      t.loans = applyMapping(t._rawData, t._reverseMap, t._customReverseMap || {});
    }
  });
  loans = [];
  tapes.forEach(t => loans.push(...t.loans));
  renderSettingsBody();
  if (loans.length) renderDashboard();
}

function renameTapeSeries(idx) {
  const tape = tapes[idx];
  const newName = prompt('Rename series for "' + tape.name + '":', tape.series);
  if (newName && newName.trim()) {
    tape.series = newName.trim();
    renderSettingsBody();
  }
}

function editTapeOriginator(idx) {
  const tape = tapes[idx];
  const newOrig = prompt('Originator for "' + tape.name + '":', tape.originator || '');
  if (newOrig !== null) {
    tape.originator = newOrig.trim();
    renderSettingsBody();
  }
}

function recategoriseTape(idx) {
  const tape = tapes[idx];
  // Build a field editor for this tape — let user change categorical options inline
  const overlay = document.getElementById('recat-overlay');
  if (!overlay) return;
  const body = document.getElementById('recat-body');
  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });

  // Find which categorical fields have data in this tape
  const catFields = [];
  const keys = tape.loans.length > 0 ? Object.keys(tape.loans[0]) : [];
  keys.forEach(k => {
    const vals = [...new Set(tape.loans.map(l => l[k]).filter(v => v != null && String(v).trim() !== '' && typeof v === 'string'))];
    if (vals.length > 0 && vals.length <= 100) {
      catFields.push({ key: k, label: fieldLabels[k] || k, values: vals.sort() });
    }
  });

  let html = `<h3 style="margin-bottom:12px;">Edit Field Categorisation — ${escapeHtml(tape.series)}</h3>`;
  html += `<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Remap values for categorical fields. Changes apply to this tape only.</p>`;

  catFields.forEach(cf => {
    html += `<div class="opt-field-group">
      <div class="opt-field-label">${escapeHtml(cf.label)} <span style="font-size:11px;color:var(--text-muted);">(${cf.values.length} values)</span></div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">`;
    cf.values.forEach(v => {
      html += `<span class="opt-tag"><span class="opt-tag-text">${escapeHtml(v)}</span>
        <button class="opt-tag-edit" onclick="recatRenameValue(${idx},'${cf.key.replace(/'/g, "\\'")}','${v.replace(/'/g, "\\'")}')" title="Rename">&#9998;</button></span>`;
    });
    html += `</div></div>`;
  });

  html += `<div style="margin-top:16px;text-align:right;">
    <button class="btn btn-outline btn-sm" onclick="closeRecatOverlay()">Close</button>
  </div>`;
  body.innerHTML = html;
  overlay.classList.add('active');
}

function recatRenameValue(tapeIdx, fieldKey, oldValue) {
  const newValue = prompt('Rename "' + oldValue + '" to:', oldValue);
  if (!newValue || newValue.trim() === oldValue || newValue.trim() === '') return;
  const tape = tapes[tapeIdx];
  tape.loans.forEach(l => {
    if (l[fieldKey] === oldValue) l[fieldKey] = newValue.trim();
  });
  // Refresh global loans
  refreshLoansFromTapes();
  // Re-render the recat dialog
  recategoriseTape(tapeIdx);
  // Re-render dashboard in background
  if (loans.length) {
    renderStats();
    renderStratification();
  }
}

function closeRecatOverlay() {
  const overlay = document.getElementById('recat-overlay');
  if (overlay) overlay.classList.remove('active');
  if (loans.length) renderDashboard();
}

function removeTape(idx) {
  if (!confirm('Remove tape "' + tapes[idx].name + '"? This cannot be undone.')) return;
  tapes.splice(idx, 1);
  if (tapes.length === 0) { goHome(); return; }
  renderSettingsBody();
  if (loans.length) renderDashboard();
}

// ============================================================
//  CUSTOM TESTS — user-defined data quality checks
// ============================================================
function addCustomTest() {
  customTests.push({ name: '', field: 'outstanding_balance', op: '>', value: '', severity: 'warning' });
  renderCustomTestList();
}

function removeCustomTest(idx) {
  customTests.splice(idx, 1);
  renderCustomTestList();
}

function updateCustomTest(idx, prop, val) {
  customTests[idx][prop] = val;
}

function renderCustomTestList() {
  const list = document.getElementById('custom-test-list');
  const empty = document.getElementById('custom-test-empty');
  const runBtn = document.getElementById('run-custom-tests-btn');
  if (customTests.length === 0) {
    empty.style.display = '';
    runBtn.style.display = 'none';
    list.innerHTML = '<div class="custom-test-empty" id="custom-test-empty">No custom tests defined. Click "+ Add Test" to create one.</div>';
    return;
  }
  runBtn.style.display = '';

  const numericFields = TEMPLATE_FIELDS.filter(f => f.type === 'number').map(f => f.key);
  const stringFields = TEMPLATE_FIELDS.filter(f => f.type === 'string').map(f => f.key);
  const allFields = TEMPLATE_FIELDS.map(f => f.key);
  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });

  list.innerHTML = customTests.map((t, i) => {
    const fieldOpts = allFields.map(k => `<option value="${k}" ${t.field === k ? 'selected' : ''}>${fieldLabels[k] || k}</option>`).join('');
    const isNum = numericFields.includes(t.field);
    const ops = isNum
      ? ['>','>=','<','<=','=','!=']
      : ['=','!=','contains','is empty','is not empty'];
    const opOpts = ops.map(o => `<option value="${o}" ${t.op === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('');
    const needsVal = t.op !== 'is empty' && t.op !== 'is not empty';
    return `<div class="custom-test-row">
      <input class="ct-name" placeholder="Test name" value="${escapeHtml(t.name)}" onchange="updateCustomTest(${i},'name',this.value)">
      <select class="ct-field" onchange="updateCustomTest(${i},'field',this.value);renderCustomTestList();">${fieldOpts}</select>
      <select class="ct-op" onchange="updateCustomTest(${i},'op',this.value);renderCustomTestList();">${opOpts}</select>
      ${needsVal ? `<input class="ct-val" placeholder="Value" value="${escapeHtml(t.value)}" onchange="updateCustomTest(${i},'value',this.value)">` : '<span class="ct-val"></span>'}
      <select class="ct-sev" onchange="updateCustomTest(${i},'severity',this.value)">
        <option value="error" ${t.severity==='error'?'selected':''}>Error</option>
        <option value="warning" ${t.severity==='warning'?'selected':''}>Warning</option>
        <option value="info" ${t.severity==='info'?'selected':''}>Info</option>
      </select>
      <button class="ct-del" onclick="removeCustomTest(${i})" title="Delete">&times;</button>
    </div>`;
  }).join('');
}

function runCustomTests() {
  if (!loans.length) return;
  const results = evaluateCustomTests();
  // Merge with built-in anomalies and re-render
  renderAnomalies(results);
}

function evaluateCustomTests() {
  const results = [];
  const fieldLabels = {};
  TEMPLATE_FIELDS.forEach(f => { fieldLabels[f.key] = f.label; });

  customTests.forEach(t => {
    if (!t.field) return;
    const matches = loans.filter(l => {
      const v = l[t.field];
      const tv = t.value;
      switch (t.op) {
        case '>':          return parseFloat(v) > parseFloat(tv);
        case '>=':         return parseFloat(v) >= parseFloat(tv);
        case '<':          return parseFloat(v) < parseFloat(tv);
        case '<=':         return parseFloat(v) <= parseFloat(tv);
        case '=':          return String(v).toLowerCase() === String(tv).toLowerCase();
        case '!=':         return String(v).toLowerCase() !== String(tv).toLowerCase();
        case 'contains':   return String(v).toLowerCase().includes(String(tv).toLowerCase());
        case 'is empty':   return v == null || String(v).trim() === '' || v === 0;
        case 'is not empty': return v != null && String(v).trim() !== '' && v !== 0;
        default: return false;
      }
    });
    if (matches.length > 0) {
      const label = fieldLabels[t.field] || t.field;
      const needsVal = t.op !== 'is empty' && t.op !== 'is not empty';
      results.push({
        severity: t.severity,
        title: t.name || `Custom: ${label} ${t.op}${needsVal ? ' ' + t.value : ''}`,
        description: `${matches.length} receivable(s) where ${label} ${t.op}${needsVal ? ' ' + t.value : ''}.`,
        count: matches.length,
        examples: matches.slice(0, 5).map(l => l.loan_id + ': ' + String(l[t.field])),
        custom: true
      });
    }
  });
  return results;
}

// Extend renderAnomalies to accept extra results from custom tests
const _origRenderAnomalies = renderAnomalies;
renderAnomalies = function(extraResults) {
  const anomalies = detectAnomalies();
  if (extraResults && extraResults.length) anomalies.push(...extraResults);
  // Also always run custom tests
  const customResults = evaluateCustomTests();
  customResults.forEach(cr => {
    if (!anomalies.find(a => a.title === cr.title)) anomalies.push(cr);
  });

  const sevOrder = { error: 0, warning: 1, info: 2 };
  anomalies.sort((a, b) => sevOrder[a.severity] - sevOrder[b.severity]);

  const errors = anomalies.filter(a => a.severity === 'error');
  const warnings = anomalies.filter(a => a.severity === 'warning');
  const infos = anomalies.filter(a => a.severity === 'info');

  document.getElementById('anomaly-summary-section').innerHTML = `
    <div class="anomaly-summary">
      <div class="card anomaly-summary-card">
        <div class="stat-label">Total Checks</div>
        <div class="stat-value">${anomalies.length > 0 ? anomalies.length : 'All clear'}</div>
        <div class="stat-sub">${anomalies.length === 0 ? 'No anomalies detected' : 'anomalies found'}</div>
      </div>
      <div class="card anomaly-summary-card">
        <div class="stat-label">Errors</div>
        <div class="stat-value" style="color:var(--red)">${errors.length}</div>
        <div class="stat-sub">Data integrity issues</div>
      </div>
      <div class="card anomaly-summary-card">
        <div class="stat-label">Warnings</div>
        <div class="stat-value" style="color:var(--amber)">${warnings.length}</div>
        <div class="stat-sub">Potential issues</div>
      </div>
      <div class="card anomaly-summary-card">
        <div class="stat-label">Info</div>
        <div class="stat-value" style="color:var(--navy)">${infos.length}</div>
        <div class="stat-sub">Observations</div>
      </div>
    </div>
  `;

  if (anomalies.length === 0) {
    document.getElementById('anomaly-list-section').innerHTML = '<div class="card" style="padding:32px;text-align:center;color:var(--text-muted);">No anomalies detected in this tape. All checks passed.</div>';
  } else {
    const listHtml = anomalies.map(a => {
      const iconClass = a.severity === 'error' ? 'error' : a.severity === 'warning' ? 'warning' : 'info';
      const iconChar = a.severity === 'error' ? '!' : a.severity === 'warning' ? '?' : 'i';
      const customBadge = a.custom ? '<span class="mapping-badge auto">custom</span>' : '';
      const examplesHtml = a.examples && a.examples.length
        ? `<div class="anomaly-examples">${a.examples.map(e => escapeHtml(e)).join(' &middot; ')}</div>` : '';
      return `<div class="card anomaly-card">
        <div class="anomaly-icon ${iconClass}">${iconChar}</div>
        <div class="anomaly-body">
          <div class="anomaly-title">${escapeHtml(a.title)} ${customBadge}</div>
          <div class="anomaly-desc">${escapeHtml(a.description)}</div>
          ${examplesHtml}
        </div>
        <div class="anomaly-count"><span class="badge badge-${iconClass === 'error' ? 'red' : iconClass === 'warning' ? 'amber' : 'navy'}">${a.count}</span></div>
      </div>`;
    }).join('');
    document.getElementById('anomaly-list-section').innerHTML = `<div class="anomaly-list">${listHtml}</div>`;
  }

  // Always render custom test UI
  renderCustomTestList();
};

</script>
</body>
</html>
